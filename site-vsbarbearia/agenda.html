<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000"/>
    <title>VS Barbearia - Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #000000;
        }
        .app-container {
            background-color: #111111;
            max-width: 450px; /* Limita a largura máxima em telas muito grandes */
            margin: 0 auto; /* Centraliza o container */
        }
        /* --- TELA DE CARREGAMENTO --- */
        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }
        .fade-in-delay {
            animation: fadeIn 1s ease-in-out 0.3s;
            animation-fill-mode: both; /* Garante que o estado inicial (invisível) seja mantido antes da animação */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #444;
            border-top: 4px solid #fbb62c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-screen.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        /* --- REMOVER E ESTILIZAR BARRA DE SCROLL --- */
        #main-content::-webkit-scrollbar {
            display: none;
        }
        #main-content {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .service-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .service-list-scroll::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 10px;
        }
        .service-list-scroll::-webkit-scrollbar-thumb {
            background-color: #fbb62c;
            border-radius: 10px;
            border: 2px solid #1e1e1e;
        }
        .modal-scroll-hidden::-webkit-scrollbar {
            display: none;
        }
        .modal-scroll-hidden {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #1e1e1e; /* Fundo do modal mais sólido */
            border-top: 1px solid #fbb62c;
            color: #e0e0e0;
        }
        .modal-title {
            color: #fbb62c; /* Cor primária para títulos do modal */
        }
        .selection-item {
            background-color: #222222;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }
        .selection-item:hover {
            border-color: #fbb62c;
        }
         .selection-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #2a2a2a;
        }
        .selection-item.disabled:hover {
            border-color: #444;
        }
        .selection-item-text {
            color: #9ca3af; /* Cor cinza mais clara para placeholder */
        }
        .selection-item-text.selected {
            color: #ffffff; /* Branco quando selecionado */
        }
        .btn-primary {
            background-color: #4a4a4a;
            color: #cccccc;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #5a5a5a;
        }
        .btn-primary.active {
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700;
        }
        /* --- ESTILOS DO CALENDÁRIO E CARDS --- */
        .info-card { /* Classe genérica para cards */
            background-color: #2a2a2a;
            padding: 1.5rem;
            border-radius: 0.75rem;
        }
        .calendar-day-header {
            font-weight: 600;
            color: #fbb62c; /* Dourado para dias da semana */
            text-align: center;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            place-items: center;
        }
        .calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .calendar-day.available {
            color: #ffffff;
            background-color: #374151;
            cursor: pointer;
        }
        .calendar-day.available:hover {
            background-color: #4b5563;
        }
        .calendar-day.today {
            border: 2px solid #fbb62c;
        }
        .calendar-day.unavailable {
            color: #6b7280;
            cursor: not-allowed;
        }
        .calendar-day.selected {
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700;
            border: none;
        }
        .calendar-day.selected:hover {
            background-color: #fbb62c; /* Mantém a cor amarela no hover quando selecionado */
        }
        /* --- FIM DOS ESTILOS DO CALENDÁRIO --- */
        .time-slot {
            background-color: #374151;
            border: 1px solid #444;
            color: #ffffff;
            font-weight: 500;
        }
        .time-slot.selected {
            border-color: #fbb62c;
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700;
        }
        .time-slot.disabled {
            background-color: #2a2a2a;
            color: #6b7280;
            cursor: not-allowed;
            border-color: #374151;
        }
        .footer-nav a.active {
            color: #fbb62c;
        }
        .text-secondary {
            color: #d1d5db;
        }
        .text-primary {
            color: #fbb62c;
        }
        .bg-primary {
            background-color: #fbb62c;
        }
        /* --- ESTILOS DOS PLANOS (DO SITE) --- */
        .plan-card {
            background-color: #000;
            border: 1px solid #444;
            transition: border-color 0.3s ease;
        }
        .plan-card:hover {
            border-color: #fbb62c;
        }
        .plan-card.popular {
            border: 2px solid #fbb62c;
        }
        .btn-plan {
            display: block;
            width: 100%;
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700; 
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; 
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .btn-plan:hover {
            background-color: #e0a828; 
        }
        .btn-plan:disabled {
            background-color: #4a4a4a;
            color: #888;
            cursor: not-allowed;
        }
        .btn-bordered {
            display: block;
            width: 100%;
            background-color: transparent;
            color: #fbb62c;
            font-weight: 700; 
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; 
            text-align: center;
            border: 2px solid #fbb62c;
            transition: all 0.3s ease;
        }
        .btn-bordered:hover {
            background-color: #fbb62c;
            color: #111111;
        }
        /* --- ESTILO DO VÍDEO DE FUNDO --- */
        .video-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .video-background video { min-width: 100%; min-height: 100%; width: auto; height: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: cover; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); }

        /* Efeito de blur adicionado */
        .content-blur {
            filter: blur(4px);
            transition: filter 0.3s ease-in-out;
        }
        /* Estilos para a tela de histórico */
        .history-card {
            background-color: #222;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #444;
        }
        /* Estilos para tela de Login/Cadastro */
        .auth-form input, .auth-form textarea, .auth-form select {
            background-color: #333;
            border: 1px solid #555;
            color: white;
        }
        .auth-form input:focus, .auth-form textarea:focus, .auth-form select:focus {
            border-color: #fbb62c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 182, 44, 0.5);
        }
        .btn-dark {
            background-color: #1a1a1a;
            color: #fff;
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-dark:hover {
            background-color: #2a2a2a;
        }
        /* Estilos para avaliação */
        .rating-stars i {
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            color: #6b7280; /* Cor padrão (cinza) */
        }
        .rating-stars i.selected {
            color: #fbb62c; /* Cor quando selecionada (amarelo) */
        }
        .comment-label {
            transition: opacity 0.3s ease-in-out;
        }
        /* Novos estilos para status do plano */
        .service-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            padding: 0.5rem;
            height: 60px;
        }
        .service-icon.used {
            background-color: #374151; /* gray-700 */
            color: #9ca3af; /* gray-400 */
        }
        .service-icon.available {
            background-color: #1e1e1e;
            color: #fbb62c; /* primary color */
            border: 1px solid #fbb62c;
        }

        /* Animações para o card de créditos */
        #credit-card-details {
            transition: all 0.5s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        #credit-card-details.expanded {
            max-height: 500px; /* Altura suficiente para o conteúdo */
        }
        .progress-bar-animated {
            transition: width 1s ease-out;
        }
    </style>
</head>
<body>
    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 bg-black flex flex-col items-center justify-center p-8 z-50">
        <!-- Bloco de conteúdo principal centralizado -->
        <div class="flex flex-col items-center text-center">
            <!-- Logo -->
            <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-20 h-20 fade-in mb-16">
    
            <!-- Loader -->
            <div class="loader mx-auto mb-16"></div>
    
            <!-- Texto -->
            <div class="fade-in-delay">
                <h1 class="text-lg font-bold text-white">Elevando a sua experiência</h1>
                <p class="text-gray-400 mt-2 text-xs max-w-[220px] mx-auto">Estilo e precisão em cada corte.</p>
            </div>
        </div>
    
        <!-- Seção "Criado por" posicionada na parte inferior -->
        <div class="absolute bottom-28 flex items-center justify-center space-x-1">
            <span class="text-lg text-gray-400">Criado por</span>
            <img src="https://i.postimg.cc/D0pp6j3q/Subcabe-alho-39.png" alt="Vel Sites Logo" class="h-10 relative -top-px left-1" onerror="this.style.display='none'">
        </div>
    </div>

    <div class="w-full app-container text-white flex flex-col h-screen overflow-hidden">
        
        <div id="main-content" class="flex-grow overflow-y-auto">
            <!-- Conteúdo da View será injetado aqui -->
        </div>

        <!-- Footer de Navegação -->
        <div id="footer-nav" class="flex justify-around items-center py-3 px-4 bg-[#000] border-t-4 border-[#fbb62c] mt-auto">
            <a href="#" class="flex flex-col items-center footer-nav-item" data-view="agendar">
                <i class="fas fa-calendar-check text-xl"></i>
                <span class="text-xs mt-1">Agendar</span>
            </a>
            <a href="#" class="relative flex flex-col items-center text-gray-400 hover:text-primary footer-nav-item" data-view="historico">
                <i class="fas fa-history text-xl"></i>
                <span class="text-xs mt-1">Histórico</span>
                <span id="review-notification-dot" class="absolute top-0 right-2 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-400 hover:text-primary footer-nav-item" data-view="planos">
                <i class="fas fa-star text-xl"></i>
                <span class="text-xs mt-1">Planos</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-400 hover:text-primary footer-nav-item" data-view="perfil">
                <i class="fas fa-user-circle text-xl"></i>
                <span class="text-xs mt-1">Perfil</span>
            </a>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-50 flex justify-center hidden modal-backdrop p-4">
        <div id="modal-content" class="w-full max-w-sm p-4 transform transition-all duration-300 ease-in-out translate-y-full">
            <!-- Conteúdo do Modal será injetado aqui -->
        </div>
    </div>

    <!-- Input de arquivo para foto de perfil (escondido) -->
    <input type="file" id="profile-pic-input" accept="image/*" class="hidden">

<script>
    // --- DADOS MOCK (Simulação do Banco de Dados) ---
    const unidades = [
        { id: 1, nome: 'Unidade Matriz (Shopping Tropical)', endereco: 'Av. Cel. Pacífico Pinto da Fonseca, 170', img: 'https://i.postimg.cc/jjQygJ63/image-4.png', mapsUrl: 'https://maps.app.goo.gl/CuV8XPC29G7335E9A' },
        { id: 2, nome: 'Unidade Romeu Duarte', endereco: 'Rua Francisco de Paula Batista Freitas, 538', img: 'https://i.postimg.cc/hPwbjhKV/image.png', mapsUrl: 'https://maps.app.goo.gl/irHEHy6ELasM1o887' }
    ];
    const barbeiros = [
        { id: 0, nome: 'Sem preferência', funcao: 'Será atribuído um profissional disponível', img: null },
        { id: 1, nome: 'Vanilton Santos', funcao: 'Fundador & Visagista', img: 'https://i.postimg.cc/pT3ScnBb/482320646-1375134203841648-765763137701876086-n.jpg' },
        { id: 2, nome: 'Profissional 2', funcao: 'Barbeiro', img: 'https://placehold.co/100x100/333333/FFFFFF?text=P2' },
        { id: 3, nome: 'Profissional 3', funcao: 'Barbeiro', img: 'https://placehold.co/100x100/333333/FFFFFF?text=P3' },
    ];
    const servicos = [
        { id: 1, nome: 'Corte de Cabelo', preco: 50.00, promocao: 40.00, duracao: '40 min' },
        { id: 2, nome: 'Barba', preco: 50.00, promocao: 40.00, duracao: '40 min' },
        { id: 3, nome: 'Combo Cabelo + Barba', preco: 100.00, promocao: 75.00, duracao: '1h 20min' },
        { id: 4, nome: 'Sobrancelha', preco: 20.00, promocao: null, duracao: '15 min' },
        { id: 5, nome: 'Pezinho', preco: 15.00, promocao: null, duracao: '10 min' },
        { id: 6, nome: 'Hidratação', preco: 30.00, promocao: null, duracao: '20 min' },
        { id: 7, nome: 'Corte Infantil', preco: 40.00, promocao: null, duracao: '30 min' },
        { id: 8, nome: 'Platinado', preco: 150.00, promocao: null, duracao: '2h' },
    ];
    const planos = [
        { title: 'Cabelo Limitado', price: '129,90', period: '/mês', features: ['Plano mensal limitado para cabelo', 'Válido nas duas unidades', 'Economia de até 35%'], popular: false },
        { title: 'Barba Limitado', price: '129,90', period: '/mês', features: ['Plano mensal limitado para barba', 'Válido nas duas unidades', 'Economia de até 35%'], popular: false },
        { title: 'Cabelo e Barba Limitado', price: '189,90', period: '/mês', features: ['Plano mensal limitado para cabelo e barba', 'Válido nas duas unidades', 'Economia de até 40%'], popular: true },
        { title: 'Cabelo e Barba Ilimitado', price: '259,90', period: '/mês', features: ['Plano mensal ilimitado para cabelo e barba', 'Válido nas duas unidades', 'Sem limite de uso'], popular: false },
    ];
    
    const goals = [
        { id: 1, target: 5, prize: 'Hidratação Grátis', icon: 'fas fa-tint', serviceId: 6 },
        { id: 2, target: 8, prize: 'Brinde Exclusivo', icon: 'fas fa-box-open', serviceId: null },
        { id: 3, target: 12, prize: 'Shampoo Jaboque', icon: 'fas fa-bottle-droplet', serviceId: null }
    ];

    const agendamentos = {
        abertos: [],
        historico: [
            { id: 100, data: '2025-07-20T10:00:00', unidade: unidades[1], barbeiro: barbeiros[2], servico: servicos[0], avaliacao: 5, usedInPlan: true },
            { id: 99, data: '2025-06-15T16:20:00', unidade: unidades[0], barbeiro: barbeiros[1], servico: servicos[1], avaliacao: null, usedInPlan: false }
        ]
    };

    let userSubscription = {
        active: false,
        plan: null,
        nextBillingDate: '',
        lastServiceDate: '',
        usedServices: 0,
        totalServices: 4
    };

    const paymentHistory = [
        { id: 'pay_1', date: '10/08/2025', amount: '189,90', status: 'Pago', method: 'Cartão de Crédito final 1234' },
        { id: 'pay_2', date: '10/07/2025', amount: '189,90', status: 'Pago', method: 'Cartão de Crédito final 1234' },
        { id: 'pay_3', date: '10/06/2025', amount: '189,90', status: 'Pago', method: 'Pix' }
    ];

    let paymentMethods = [
        { id: 1, type: 'card', last4: '1234', brand: 'visa', primary: true },
        { id: 2, type: 'card', last4: '5678', brand: 'mastercard', primary: false }
    ];

    let userInfo = {
        name: 'Vanilton Santos',
        phone: '(37) 99999-9999',
        email: 'vanilton.santos@exemplo.com',
        referralCode: 'VANILTONS10',
        profilePic: 'https://i.postimg.cc/pT3ScnBb/482320646-1375134203841648-765763137701876086-n.jpg',
        birthdate: '',
        referralCredits: 20.00, // Créditos de indicação
        referralsMade: 6, // Número de indicações bem-sucedidas
        redeemedGoals: [] // IDs das metas já resgatadas
    };
    
    const registeredPhone = '3799745723';
    // Mapeamento de quais serviços cada plano cobre (por ID do serviço)
    const planServiceMapping = {
        'Cabelo Limitado': [1, 7], // Corte de Cabelo, Corte Infantil
        'Barba Limitado': [2], // Barba
        'Cabelo e Barba Limitado': [1, 2, 3, 7], // Corte, Barba, Combo, Infantil
        'Cabelo e Barba Ilimitado': [1, 2, 3, 4, 5, 6, 7] // Todos os principais
    };


    // --- ESTADO DA APLICAÇÃO ---
    let selection = {};
    let userLoggedIn = true; // Mantendo logado para testes
    let isAuthModalOpen = false;
    let remarcarSelection = {}; // Estado para remarcação

    // --- ELEMENTOS DO DOM ---
    const modalContainer = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');
    const mainContent = document.getElementById('main-content');
    const footerNav = document.getElementById('footer-nav');
    const profilePicInput = document.getElementById('profile-pic-input');


    // --- FUNÇÕES DE ESTADO (CACHE) ---
    function saveState() {
        localStorage.setItem('agendamentoState', JSON.stringify({ 
            selection, 
            userLoggedIn, 
            agendamentos, 
            userSubscription, 
            paymentMethods,
            userInfo
        }));
    }

    function loadState() {
        const savedState = localStorage.getItem('agendamentoState');
        if (savedState) {
            const state = JSON.parse(savedState);
            selection = state.selection || {};
            userLoggedIn = state.userLoggedIn !== undefined ? state.userLoggedIn : true;
            userSubscription = state.userSubscription || { active: false, plan: null, usedServices: 0, totalServices: 4 };
            paymentMethods = state.paymentMethods || [ { id: 1, type: 'card', last4: '1234', brand: 'visa', primary: true } ];
            userInfo = state.userInfo || {
                name: 'Vanilton Santos',
                phone: '(37) 99999-9999',
                email: 'vanilton.santos@exemplo.com',
                referralCode: 'VANILTONS10',
                profilePic: 'https://i.postimg.cc/pT3ScnBb/482320646-1375134203841648-765763137701876086-n.jpg',
                birthdate: '',
                referralCredits: 20.00,
                referralsMade: 6,
                redeemedGoals: []
            };
            if (state.agendamentos) {
                agendamentos.abertos = state.agendamentos.abertos || [];
                agendamentos.historico = state.agendamentos.historico || [
                    { id: 100, data: '2025-07-20T10:00:00', unidade: unidades[1], barbeiro: barbeiros[2], servico: servicos[0], avaliacao: 5, usedInPlan: true },
                    { id: 99, data: '2025-06-15T16:20:00', unidade: unidades[0], barbeiro: barbeiros[1], servico: servicos[1], avaliacao: null, usedInPlan: false }
                ];
            }
        } else {
            resetSelections();
        }
    }

    // --- FUNÇÕES DO MODAL ---
    function openModal(content, customClass = '', position = 'end') {
        isAuthModalOpen = (position === 'center');

        modalContainer.classList.remove('items-end', 'items-center');
        modalContainer.classList.add(position === 'center' ? 'items-center' : 'items-end');

        const baseClasses = 'w-full max-w-sm p-4 transform-gpu transition-transform duration-300 ease-in-out';
        const styleClasses = position === 'center' 
            ? 'rounded-2xl translate-y-full' 
            : 'rounded-t-2xl mb-6 translate-y-full';
        
        modalContent.className = `${baseClasses} ${styleClasses} ${customClass}`;
        modalContent.innerHTML = content;

        mainContent.classList.add('content-blur');
        footerNav.classList.add('content-blur');
        modalContainer.classList.remove('hidden');
        modalContainer.classList.add('flex');
        
        setTimeout(() => {
            modalContent.classList.remove('translate-y-full');
        }, 10);
    }

    function closeModal(callback) {
        modalContent.classList.add('translate-y-full');
        mainContent.classList.remove('content-blur');
        footerNav.classList.remove('content-blur');
        setTimeout(() => {
            modalContainer.classList.add('hidden');
            modalContent.innerHTML = '';
            isAuthModalOpen = false;
            if (callback && typeof callback === 'function') {
                callback();
            }
        }, 300);
    }
    
    // Função helper para usar em `onclick`
    function closeModalAndRender(view) {
        closeModal(() => renderView(view));
    }


    modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer && !isAuthModalOpen) {
            closeModal();
        }
    });

    // --- LÓGICA DE RENDERIZAÇÃO DE VIEWS ---
    function renderView(viewName) {
        document.querySelectorAll('.footer-nav-item').forEach(item => {
            item.classList.remove('active', 'text-primary');
            item.classList.add('text-gray-400');
            if (item.dataset.view === viewName) {
                item.classList.add('active', 'text-primary');
                item.classList.remove('text-gray-400');
            }
        });

        switch (viewName) {
            case 'agendar':
                renderAgendarView();
                break;
            case 'planos':
                renderPlanosView();
                break;
            case 'historico':
                renderHistoricoView();
                break;
            case 'perfil':
                renderPerfilView();
                break;
        }
    }

    function renderAgendarView() {
        let reminderHtml = '';
        const today = new Date();
        const todaysAppointment = agendamentos.abertos.find(ag => new Date(ag.data).toDateString() === today.toDateString());

        if (todaysAppointment) {
            const horaFormatada = new Date(todaysAppointment.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            reminderHtml = `
                <div class="bg-primary/20 border-l-4 border-primary text-primary p-4 m-6 rounded-r-lg" role="alert">
                    <p class="font-bold">Lembrete</p>
                    <p class="text-sm">Seu horário é hoje às ${horaFormatada} na ${todaysAppointment.unidade.nome}.</p>
                </div>
            `;
        }

        mainContent.innerHTML = `
            ${reminderHtml}
            <div class="relative flex flex-col" style="height: 100%;">
                <div class="video-background">
                    <video autoplay muted loop playsinline poster="https://i.postimg.cc/28q5gTbm/Design-sem-nome-76.png">
                        <source src="https://files.catbox.moe/fzxnia.mp4" type="video/mp4">
                    </video>
                    <div class="video-overlay"></div>
                </div>
                
                <div class="relative z-10 flex-grow flex flex-col justify-end p-6">
                    <div class="text-center mb-8">
                        <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-20 h-20 mb-4 mx-auto">
                        <h1 class="text-3xl font-bold">Agende seu horário</h1>
                        <div class="w-24 h-1 bg-[#fbb62c] mx-auto my-3 rounded"></div>
                        <p class="text-gray-200">Escolha os serviços e agende com facilidade.</p>
                    </div>
                </div>

                <div class="relative z-10 p-6 pt-0 space-y-4 bg-gradient-to-t from-[#111111] to-transparent">
                    <div id="select-unidade" class="flex items-center justify-between p-4 rounded-lg cursor-pointer selection-item">
                        <div class="flex items-center">
                            <i class="fas fa-store text-primary w-6 text-center"></i>
                            <span id="unidade-text" class="ml-4 selection-item-text">Selecionar unidade</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </div>
                    <div id="select-barbeiro" class="flex items-center justify-between p-4 rounded-lg cursor-pointer selection-item disabled">
                        <div class="flex items-center">
                            <i class="fas fa-user-tie text-primary w-6 text-center"></i>
                            <span id="barbeiro-text" class="ml-4 selection-item-text">Selecionar barbeiro</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </div>
                    <div id="select-servico" class="flex items-center justify-between p-4 rounded-lg cursor-pointer selection-item disabled">
                        <div class="flex items-center">
                            <i class="fas fa-cut text-primary w-6 text-center"></i>
                            <span id="servico-text" class="ml-4 selection-item-text">Selecionar serviço</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </div>
                    <div id="select-data" class="flex items-center justify-between p-4 rounded-lg cursor-pointer selection-item disabled">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt text-primary w-6 text-center"></i>
                            <span id="data-text" class="ml-4 selection-item-text">Selecionar data e hora</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </div>
                    <button id="agendar-btn" class="w-full py-3 mt-6 rounded-lg btn-primary" disabled>Agendar</button>
                </div>
            </div>
        `;
        updateAgendarViewFromState();
        attachAgendarEventListeners();
    }

    function renderPlanosView() {
        let planStatusHtml = '';
        if (userSubscription.active && userSubscription.plan) {
            const used = userSubscription.usedServices;
            const total = userSubscription.totalServices;
            
            let serviceIconsHtml = '';
            for (let i = 1; i <= total; i++) {
                const isUsed = i <= used;
                serviceIconsHtml += `
                    <div class="service-icon ${isUsed ? 'used' : 'available'}">
                        <i class="fas fa-cut text-lg"></i>
                        <span class="text-xs mt-1">${isUsed ? 'Usado' : 'Livre'}</span>
                    </div>
                `;
            }

            planStatusHtml = `
                <div class="px-6 pt-10">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-white">Plano <span class="text-primary">Atual</span></h2>
                        <div class="w-20 h-1 bg-primary mx-auto mt-2 rounded-full transform scale-x-0 transition-transform duration-700 ease-out" id="plan-title-underline"></div>
                    </div>

                    <div class="bg-[#1e1e1e] p-5 rounded-2xl border border-gray-800 shadow-lg">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="font-bold text-white text-lg">${userSubscription.plan.title}</h3>
                            <span class="bg-green-500/20 text-green-400 text-xs font-semibold px-2.5 py-1 rounded-full">Ativo</span>
                        </div>

                        <div class="space-y-4">
                            <div class="grid grid-cols-4 gap-3">
                                ${serviceIconsHtml}
                            </div>
                            <div>
                                <div class="flex justify-between mb-1 text-xs font-medium text-secondary">
                                    <span>Progresso</span>
                                    <span>${used} de ${total}</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div id="plan-progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-700 my-5"></div>

                        <div class="flex justify-between items-center text-sm text-secondary">
                            <span>Próxima renovação:</span>
                            <span class="font-bold text-white">${userSubscription.nextBillingDate}</span>
                        </div>
                    </div>
                    <div class="mt-4 space-y-3">
                        <button class="w-full text-left p-4 rounded-xl bg-[#1e1e1e] border border-gray-800 flex items-center justify-between hover:border-gray-700 transition-colors" onclick="showPagamentosModal()">
                            <span><i class="fas fa-receipt w-6 text-center mr-3 text-primary"></i>Histórico de Pagamentos</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                        <button class="w-full text-left p-4 rounded-xl bg-[#1e1e1e] border border-gray-800 flex items-center justify-between hover:border-gray-700 transition-colors" onclick="showBeneficiosModal()">
                            <span><i class="fas fa-gem w-6 text-center mr-3 text-primary"></i>Benefícios do Clube</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                         <button class="w-full text-left p-4 rounded-xl bg-[#1e1e1e] border border-gray-800 flex items-center justify-between hover:border-gray-700 transition-colors" onclick="showGerenciarAssinaturaModal()">
                            <span><i class="fas fa-cog w-6 text-center mr-3 text-primary"></i>Gerenciar Assinatura</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                    </div>
                </div>
            `;
        }


        const plansHtml = planos.map(plan => {
            const isCurrentPlan = userSubscription.active && userSubscription.plan && userSubscription.plan.title === plan.title;
            return `
                <div class="plan-card ${plan.popular ? 'popular' : ''} ${isCurrentPlan ? 'border-2 border-primary' : ''} rounded-xl overflow-hidden flex flex-col">
                    ${plan.popular ? '<div class="bg-[#fbb62c] text-black text-center py-1 font-bold text-sm">MAIS POPULAR</div>' : ''}
                    <div class="p-6 flex flex-col flex-grow">
                        <h3 class="text-xl font-bold mb-2 text-white">${plan.title}</h3>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-bold text-primary">R$${plan.price}</span>
                            <span class="text-gray-400 ml-1">${plan.period}</span>
                        </div>
                        <ul class="space-y-3 mb-8 flex-grow text-secondary text-sm">
                            ${plan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-primary mr-3 mt-1"></i><span>${f}</span></li>`).join('')}
                        </ul>
                        <button class="btn-plan mt-auto" onclick="showSubscriptionModal('${plan.title}')" ${isCurrentPlan ? 'disabled' : ''}>${isCurrentPlan ? 'Seu Plano Atual' : 'Assinar Plano'}</button>
                    </div>
                </div>
            `
        }).join('');

        mainContent.innerHTML = `
            <div class="pb-24 flex flex-col">
                ${planStatusHtml}
                
                <div class="px-6 ${planStatusHtml ? 'mt-12 border-t border-gray-800 pt-12' : 'pt-10'}">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-2 text-white">Nossos <span class="text-primary">Planos</span></h2>
                        <div class="w-20 h-1 bg-primary mx-auto"></div>
                        <p class="text-gray-300 mt-4 text-sm max-w-md mx-auto">Economize com nossos planos e aproveite serviços de qualidade.</p>
                    </div>
                    <div class="space-y-6 flex-grow">
                        ${plansHtml}
                    </div>
                    <div class="text-center mt-10 pt-6 border-t border-gray-700">
                        <p class="text-secondary mb-6">Não tem certeza de qual plano escolher? Entre em contato conosco.</p>
                        <div class="space-y-4">
                            <a href="#" class="btn-plan" onclick="renderView('agendar')">Agendar Horário</a>
                            <button class="btn-bordered w-full" onclick="showFaleConoscoModal()">Fale Conosco</button>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <button class="btn-dark border border-gray-600" onclick="showTermosModal()">Termos e Serviços</button>
                    </div>
                </div>
            </div>
        `;

        if (userSubscription.active) {
            const progressBar = document.getElementById('plan-progress-bar');
            const titleUnderline = document.getElementById('plan-title-underline');

            if (progressBar && titleUnderline) {
                requestAnimationFrame(() => {
                    const used = userSubscription.usedServices;
                    const total = userSubscription.totalServices;
                    const progressPercentage = (used / total) * 100;
                    
                    progressBar.style.width = `${progressPercentage}%`;
                    titleUnderline.style.transform = 'scaleX(1)';
                });
            }
        }
    }
    
    function renderHistoricoView() {
        const agendamentosAbertosHtml = agendamentos.abertos.map(ag => {
            const data = new Date(ag.data);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            let tagHtml = '';
            if (ag.usedInPlan) {
                tagHtml = `<span class="bg-primary/20 text-primary text-xs font-semibold px-2 py-0.5 rounded-full ml-auto">Plano</span>`;
            } else if (ag.usedReferralCredit) {
                tagHtml = `<span class="bg-green-500/20 text-green-400 text-xs font-semibold px-2 py-0.5 rounded-full ml-auto">Crédito</span>`;
            }

            return `
                <div class="history-card cursor-pointer" onclick="showDetalhesAgendamento(${ag.id})">
                     <div class="pb-3">
                        <div class="flex items-start">
                            <h3 class="font-bold text-lg text-white flex-grow">${ag.unidade.nome}</h3>
                            ${tagHtml}
                        </div>
                        <div class="flex justify-between text-secondary text-sm mt-2 mb-4">
                            <span><i class="far fa-calendar-alt mr-2 text-primary"></i>${dataFormatada}</span>
                            <span><i class="far fa-clock mr-2 text-primary"></i>${horaFormatada}</span>
                        </div>
                        <div class="flex items-center">
                            <img src="${ag.barbeiro.img || 'https://placehold.co/100x100/333333/FFFFFF?text=S/F'}" class="w-12 h-12 rounded-full mr-4 object-cover">
                            <div>
                                <p class="text-sm text-gray-400">Barbeiro</p>
                                <p class="font-semibold text-white">${ag.barbeiro.nome}</p>
                            </div>
                            <div class="ml-auto text-right">
                                <p class="text-sm text-gray-400">Serviço</p>
                                <p class="font-semibold text-white">${ag.servico.nome}</p>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 mt-3 pt-3 text-center">
                        <span class="font-semibold text-primary text-sm">Ver detalhes</span>
                    </div>
                </div>
            `;
        }).join('');

        const historicoHtml = agendamentos.historico.map(ag => {
             const data = new Date(ag.data);
             const dataFormatada = data.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
             const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
             
             let tagHtml = '';
             if (ag.usedInPlan) {
                tagHtml = `<span class="bg-primary/20 text-primary text-xs font-semibold px-2 py-0.5 rounded-full">Plano</span>`;
             } else if (ag.usedReferralCredit) {
                tagHtml = `<span class="bg-green-500/20 text-green-400 text-xs font-semibold px-2 py-0.5 rounded-full">Crédito</span>`;
             }

             let footerHtml = '';
             if (ag.avaliacao) {
                 footerHtml = `
                    <div class="flex justify-center items-center text-primary mt-3 pt-3 border-t border-gray-700">
                        ${[...Array(5)].map((_, i) => `<i class="fas fa-star ${i < ag.avaliacao ? 'text-primary' : 'text-gray-600'}"></i>`).join('')}
                    </div>
                 `;
             } else {
                 footerHtml = `
                     <div class="mt-3 pt-3 border-t border-gray-700 grid grid-cols-2 gap-3">
                         <button class="btn-bordered w-full text-sm py-2" onclick="showAvaliacaoModal(${ag.id})">Avaliar</button>
                         <button class="btn-plan w-full text-sm py-2" onclick="rebookAppointment(${ag.id})">Agendar Novamente</button>
                     </div>
                 `;
             }

             return `
                 <div class="history-card">
                     <p class="text-sm text-gray-400 mb-2"><i class="far fa-calendar-alt mr-2 text-primary"></i>${dataFormatada}</p>
                     <p class="text-sm text-gray-400 mb-4"><i class="far fa-clock mr-2 text-primary"></i>${horaFormatada}</p>
                     <div class="border-t border-gray-700 pt-3">
                        <div class="flex justify-between items-start">
                             <p class="font-semibold text-white mb-2">${ag.unidade.nome}</p>
                             ${tagHtml}
                        </div>
                         <div class="flex justify-between text-sm">
                             <div>
                                 <p class="text-gray-400">Barbeiro</p>
                                 <p class="text-white">${ag.barbeiro.nome}</p>
                             </div>
                             <div>
                                 <p class="text-gray-400">Serviço</p>
                                 <p class="text-white">${ag.servico.nome}</p>
                             </div>
                         </div>
                     </div>
                     ${footerHtml}
                 </div>
             `;
        }).join('');

        mainContent.innerHTML = `
            <div class="p-6">
                <h2 class="text-2xl font-bold text-white mb-6">Histórico</h2>
                
                <section class="mb-8">
                    <h3 class="text-xl font-semibold text-primary mb-4">Agendamento em aberto</h3>
                    <div class="space-y-4">
                        ${agendamentosAbertosHtml || '<p class="text-secondary">Nenhum agendamento em aberto.</p>'}
                    </div>
                </section>

                <section>
                    <h3 class="text-xl font-semibold text-primary mb-4">Histórico de serviços</h3>
                    <div class="space-y-4">
                        ${historicoHtml || '<p class="text-secondary">Nenhum serviço no histórico.</p>'}
                    </div>
                </section>
            </div>
        `;
    }

    function renderPerfilView() {
        if (!userLoggedIn) {
            mainContent.innerHTML = `
                <div class="p-6 h-full flex flex-col items-center justify-center text-center">
                    <i class="fas fa-user-circle text-6xl text-gray-600 mb-4"></i>
                    <h1 class="text-2xl font-bold text-primary">Perfil</h1>
                    <p class="text-secondary mt-2 mb-6">Crie uma conta para ver suas informações e gerenciar seus agendamentos.</p>
                    <button class="btn-plan" onclick="showLogin()">Entrar ou Cadastrar</button>
                </div>
            `;
            return;
        }

        let creditCardHtml = '';
        const referrals = userInfo.referralsMade;
        
        if (userInfo.referralCredits >= 50) {
            creditCardHtml = `
                <div class="bg-gradient-to-br from-primary to-[#dca52c] p-5 rounded-2xl border-2 border-primary/50 shadow-lg text-center text-black relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/20 rounded-full z-0"></div>
                    <div class="absolute -bottom-8 -left-2 w-24 h-24 bg-white/10 rounded-full z-0"></div>
                    
                    <div class="relative z-10">
                        <i class="fas fa-gift text-4xl mb-3 text-black"></i>
                        <p class="font-bold text-xl drop-shadow text-black">Parabéns! Você conseguiu!</p>
                        <p class="text-4xl font-extrabold my-2 drop-shadow-md text-black">R$ ${userInfo.referralCredits.toFixed(2).replace('.', ',')}</p>
                        <p class="text-sm font-medium mb-4 drop-shadow text-black">em créditos para usar</p>
                        <button class="w-full py-3 font-bold rounded-lg bg-black text-primary transition-transform duration-200 hover:scale-105 shadow-xl" onclick="showResgatarCreditoModal()">Resgatar Corte Grátis</button>
                    </div>
                </div>
            `;
        } else {
             const goalsHtml = goals.map(goal => {
                const progress = Math.min((referrals / goal.target) * 100, 100);
                const achieved = referrals >= goal.target;
                const redeemed = userInfo.redeemedGoals.includes(goal.id);

                let rewardButtonHtml = '';

                if (redeemed) {
                    rewardButtonHtml = `<span class="bg-gray-700 text-secondary text-xs font-bold py-1.5 px-3 rounded-full mt-2 cursor-default">Resgatado</span>`;
                } else if (achieved && goal.serviceId) {
                    rewardButtonHtml = `<button class="bg-primary text-black text-xs font-bold py-1.5 px-3 rounded-full mt-2 hover:bg-yellow-400 transition-all" onclick="resgatarMetaServico(${goal.serviceId})">Resgatar</button>`;
                } else if (achieved) {
                    rewardButtonHtml = `<span class="text-xs text-secondary mt-2 block">Retire na barbearia</span>`;
                }


                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${achieved ? 'bg-gradient-to-br from-primary to-yellow-400 text-black shadow-lg' : 'bg-gray-700/50 border-2 border-gray-600'}">
                            <i class="${goal.icon} text-xl ${achieved ? '' : 'text-primary'}"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-baseline mb-1">
                                <p class="font-bold text-sm ${achieved ? 'text-primary' : 'text-white'}">${goal.prize}</p>
                                <p class="text-xs ${achieved ? 'text-primary font-bold' : 'text-secondary'}">${achieved ? 'Concluído!' : `${referrals}/${goal.target}`}</p>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full progress-bar-animated" style="width: 0%" data-progress="${progress}"></div>
                            </div>
                            ${rewardButtonHtml}
                        </div>
                    </div>
                `;
            }).join('');

            creditCardHtml = `
                <div class="bg-gradient-to-b from-[#2a2a2a] to-[#1e1e1e] p-5 rounded-2xl border border-gray-800 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-secondary text-sm">Crédito disponível</p>
                            <p class="text-3xl font-bold text-white mt-1">R$ ${userInfo.referralCredits.toFixed(2).replace('.', ',')}</p>
                        </div>
                         <button id="credit-card-toggle" class="text-sm font-semibold text-primary flex items-center" onclick="toggleCreditCardDetails(true)">
                            <span id="toggle-text">Ver metas</span> <i id="toggle-icon" class="fas fa-chevron-down ml-2 text-xs transition-transform"></i>
                         </button>
                    </div>
                    
                    <div id="credit-card-details">
                         <div class="mt-4 pt-4 border-t border-gray-700/50">
                            <h4 class="font-semibold text-primary mb-4 text-center">Metas de Indicação</h4>
                             <div class="space-y-5">
                                ${goalsHtml}
                             </div>
                         </div>
                    </div>

                    <p class="text-xs text-secondary text-center mt-4 pt-4 border-t border-gray-700/50">Acumule crédito para trocar por serviços.</p>
                </div>
            `;
        }

        mainContent.innerHTML = `
            <div class="p-6 pt-12">
                <div class="flex flex-col items-center text-center mb-8">
                    <div class="relative mb-4">
                        <img id="profile-view-pic" src="${userInfo.profilePic}" class="w-24 h-24 rounded-full object-cover border-4 border-primary">
                        <button class="absolute bottom-0 right-0 bg-gray-700 rounded-full h-8 w-8 flex items-center justify-center" onclick="showTrocarFotoModal()">
                            <i class="fas fa-camera text-white"></i>
                        </button>
                    </div>
                    <h2 class="text-2xl font-bold text-white">${userInfo.name}</h2>
                </div>

                <!-- Card de Créditos -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-primary mb-4">Seus Créditos</h3>
                    ${creditCardHtml}
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-primary mb-4">Suas informações</h3>
                    <div class="space-y-4 text-secondary">
                        <div class="flex items-center">
                            <i class="fas fa-phone-alt w-6 text-center mr-4 text-primary"></i>
                            <div>
                                <p class="text-xs">Celular</p>
                                <p class="text-white">${userInfo.phone}</p>
                            </div>
                        </div>
                         <div class="flex items-center">
                            <i class="fas fa-envelope w-6 text-center mr-4 text-primary"></i>
                            <div>
                                <p class="text-xs">E-mail</p>
                                <p class="text-white">${userInfo.email}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center" onclick="showEditarPerfilModal()"><i class="fas fa-edit w-6 text-center mr-3 text-primary"></i>Editar perfil</button>
                    <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center" onclick="showAlterarPagamentoModal()"><i class="fas fa-credit-card w-6 text-center mr-3 text-primary"></i>Formas de Pagamento</button>
                    <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center" onclick="showIndiqueAmigoModal()"><i class="fas fa-gift w-6 text-center mr-3 text-primary"></i>Indique um Amigo</button>
                    <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center" onclick="showNotificacoesModal()"><i class="fas fa-bell w-6 text-center mr-3 text-primary"></i>Notificações</button>
                    <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center" onclick="showAlterarPinModal()"><i class="fas fa-key w-6 text-center mr-3 text-primary"></i>Alterar PIN</button>
                </div>
                <div class="mt-8">
                    <button class="w-full py-3 font-bold rounded-lg btn-dark border border-red-500 text-red-500" onclick="handleLogout()">Sair</button>
                </div>

                <!-- Seção Criado Por -->
                <div class="mt-16 mb-8 text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-base text-gray-400">Criado por</span>
                        <img src="https://i.postimg.cc/D0pp6j3q/Subcabe-alho-39.png" alt="Vel Sites Logo" class="h-9 relative -top-px" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>
        `;
    }

    function toggleCreditCardDetails(show) {
        const detailsDiv = document.getElementById('credit-card-details');
        const toggleButton = document.getElementById('credit-card-toggle');
        const toggleText = document.getElementById('toggle-text');
        const toggleIcon = document.getElementById('toggle-icon');

        if (detailsDiv && toggleButton && toggleText && toggleIcon) {
            if (show) {
                detailsDiv.classList.add('expanded');
                toggleText.textContent = 'Recolher';
                toggleIcon.classList.add('rotate-180');
                toggleButton.setAttribute('onclick', 'toggleCreditCardDetails(false)');
                
                // Animar as barras de progresso ao expandir
                setTimeout(() => {
                    document.querySelectorAll('.progress-bar-animated').forEach(bar => {
                        bar.style.width = bar.dataset.progress + '%';
                    });
                }, 100); // Pequeno delay para a animação ser visível

            } else {
                detailsDiv.classList.remove('expanded');
                toggleText.textContent = 'Ver metas';
                toggleIcon.classList.remove('rotate-180');
                toggleButton.setAttribute('onclick', 'toggleCreditCardDetails(true)');

                 // Resetar as barras de progresso ao recolher
                document.querySelectorAll('.progress-bar-animated').forEach(bar => {
                    bar.style.width = '0%';
                });
            }
        }
    }
    
    function updateProfilePics() {
        const newSrc = userInfo.profilePic;
        const profileViewPic = document.getElementById('profile-view-pic');
        const modalEditPic = document.getElementById('modal-edit-pic');
        if (profileViewPic) profileViewPic.src = newSrc;
        if (modalEditPic) modalEditPic.src = newSrc;
    }

    function showDetalhesAgendamento(id) {
        const agendamento = agendamentos.abertos.find(ag => ag.id === id);
        if (!agendamento) return;

        const dataAgendamento = new Date(agendamento.data);
        const agora = new Date();
        const diffHoras = (dataAgendamento - agora) / (1000 * 60 * 60);
        const podeRemarcar = diffHoras > 7;

        const dataFormatada = dataAgendamento.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
        const horaFormatada = dataAgendamento.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        let precoHtml;
        if (agendamento.usedInPlan) {
            precoHtml = `
                <div class="border-t border-b border-gray-700 py-3 my-3">
                    <div class="flex justify-between items-center text-green-400">
                        <span>${agendamento.servico.nome}</span>
                        <span class="font-bold">Incluso no Plano</span>
                    </div>
                </div>
                 <div class="flex justify-between items-center font-bold text-lg">
                    <span class="text-white">Total</span>
                    <span class="text-primary">R$ 0,00</span>
                </div>
            `;
        } else if (agendamento.usedReferralCredit) {
             precoHtml = `
                <div class="border-t border-b border-gray-700 py-3 my-3">
                    <div class="flex justify-between items-center text-green-400">
                        <span>${agendamento.servico.nome}</span>
                        <span class="font-bold">Resgatado com Créditos</span>
                    </div>
                </div>
                 <div class="flex justify-between items-center font-bold text-lg">
                    <span class="text-white">Total</span>
                    <span class="text-primary">R$ 0,00</span>
                </div>
            `;
        } else {
            const diaDaSemana = dataAgendamento.getDay();
            const temPromocao = diaDaSemana >= 1 && diaDaSemana <= 3;
            const preco = temPromocao && agendamento.servico.promocao ? agendamento.servico.promocao.toFixed(2) : agendamento.servico.preco.toFixed(2);
            precoHtml = `
                <div class="border-t border-b border-gray-700 py-3 my-3">
                    <div class="flex justify-between items-center">
                        <span>${agendamento.servico.nome}</span>
                        <span class="text-white font-bold">R$ ${preco}</span>
                    </div>
                </div>
                 <div class="flex justify-between items-center font-bold text-lg">
                    <span class="text-white">Total</span>
                    <span class="text-primary">R$ ${preco}</span>
                </div>
            `;
        }


        const remarcarButtonHtml = podeRemarcar
            ? `<button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="showRemarcarModal(${id})">Remarcar</button>`
            : `<div class="relative group">
                   <button class="w-full py-3 font-bold rounded-lg btn-primary cursor-not-allowed" disabled>Remarcar</button>
                   <span class="absolute hidden group-hover:block -top-12 left-1/2 -translate-x-1/2 w-max max-w-xs bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-90">
                       Não é possível remarcar com menos de 7h de antecedência.
                   </span>
               </div>`;

        const modalHtml = `
            <div class="info-card p-6">
                <h2 class="text-xl font-bold mb-6 text-center modal-title">Detalhes do Agendamento</h2>
                <div class="space-y-4 text-secondary">
                    <div>
                        <p><strong class="text-white">Unidade:</strong><br>${agendamento.unidade.nome}</p>
                        <a href="${agendamento.unidade.mapsUrl}" target="_blank" class="block w-full text-white font-semibold py-2 px-4 rounded-xl transition text-center mt-3 text-sm" style="background-color: #0b0b0a;">Ver localização</a>
                    </div>
                    <p><strong class="text-white">Data:</strong><br>${dataFormatada}</p>
                    <p><strong class="text-white">Horário:</strong><br>${horaFormatada}</p>
                    <p><strong class="text-white">Barbeiro:</strong><br>${agendamento.barbeiro.nome}</p>
                    ${precoHtml}
                </div>
                <div class="mt-8 space-y-3">
                    ${remarcarButtonHtml}
                    <button class="w-full py-3 font-bold rounded-lg btn-bordered" onclick="showCancelarConfirmacaoModal(${id})">Cancelar agendamento</button>
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                </div>
            </div>
        `;
        openModal(modalHtml);
    }
    
    function showRemarcarModal(id) {
        const agendamento = agendamentos.abertos.find(ag => ag.id === id);
        if (!agendamento) return;
        remarcarSelection = { id }; // Reset selection

        let displayMonth = new Date().getMonth();
        let displayYear = new Date().getFullYear();
        
        function renderCalendarRemarcar(month, year) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const limitDate = new Date();
            limitDate.setDate(limitDate.getDate() + 7);
            limitDate.setHours(0, 0, 0, 0);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            let calendarHeader = `<div class="flex justify-between items-center text-white mb-4 px-2">
                <button id="prev-month-remarcar" class="text-xl p-2"><i class="fas fa-chevron-left"></i></button>
                <h3 class="font-bold text-lg">${monthNames[month]} ${year}</h3>
                <button id="next-month-remarcar" class="text-xl p-2"><i class="fas fa-chevron-right"></i></button>
            </div>`;
            
            let dayHeaders = `<div class="grid grid-cols-7 text-center text-sm mb-2">
                ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => `<div class="calendar-day-header">${d}</div>`).join('')}
            </div>`;
            
            let daysGrid = `<div class="calendar-grid">`;
            for (let i = 0; i < firstDayOfMonth; i++) { daysGrid += `<div></div>`; }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();

                const isSelectable = currentDate >= today && currentDate <= limitDate && dayOfWeek !== 0;
                const isToday = currentDate.getTime() === today.getTime();
                
                let dayClass = 'calendar-day';
                if (isSelectable) {
                    dayClass += ' available';
                    if(isToday) {
                        dayClass += ' today';
                    }
                } else {
                    dayClass += ' unavailable';
                }

                daysGrid += `<div class="${dayClass}" ${!isSelectable ? 'disabled' : ''} onclick="selectRemarcarDate(this, ${year}, ${month}, ${day})">${day}</div>`;
            }
            daysGrid += `</div>`;
            
            return `<div style="width: 300px;">${calendarHeader}${dayHeaders}${daysGrid}</div>`;
        }

        const modalHtml = `
            <div class="info-card p-6 flex flex-col" style="min-height: 550px; max-height: 90vh;">
                <h2 class="text-xl font-bold mb-4 text-center modal-title">Remarcar Horário</h2>
                <div class="flex-grow overflow-y-auto pr-2 modal-scroll-hidden">
                    <div class="flex justify-center">
                        <div id="calendar-container-remarcar"></div>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-bold text-center mb-4 text-white">Escolha o novo horário</h3>
                         <div class="grid grid-cols-2 gap-2 mb-4">
                            <button id="btn-remarcar-manha" class="py-2 rounded-lg btn-primary active" onclick="showTimeSlotsRemarcar('manha')">Manhã</button>
                            <button id="btn-remarcar-tarde" class="py-2 rounded-lg btn-primary" onclick="showTimeSlotsRemarcar('tarde')">Tarde</button>
                        </div>
                        <div id="time-slots-remarcar" class="grid grid-cols-4 gap-2 text-center">
                            <p class="col-span-4 text-gray-400 text-sm">Selecione uma data para ver os horários</p>
                        </div>
                    </div>
                </div>
                <div class="mt-auto pt-6 grid grid-cols-2 gap-4">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showDetalhesAgendamento(${id})">Voltar</button>
                    <button id="confirm-remarcar-btn" class="w-full py-3 font-semibold rounded-lg btn-plan opacity-50" disabled>Confirmar Novo Horário</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none p-0', 'center');

        function updateCalendar() {
            document.getElementById('calendar-container-remarcar').innerHTML = renderCalendarRemarcar(displayMonth, displayYear);
            document.getElementById('prev-month-remarcar').addEventListener('click', () => {
                displayMonth--;
                if (displayMonth < 0) { displayMonth = 11; displayYear--; }
                updateCalendar();
            });
            document.getElementById('next-month-remarcar').addEventListener('click', () => {
                displayMonth++;
                if (displayMonth > 11) { displayMonth = 0; displayYear++; }
                updateCalendar();
            });
        }
        updateCalendar();
    }

    function showTimeSlotsRemarcar(periodo) {
        const btnManha = document.getElementById('btn-remarcar-manha');
        const btnTarde = document.getElementById('btn-remarcar-tarde');
        
        btnManha.classList.toggle('active', periodo === 'manha');
        btnTarde.classList.toggle('active', periodo === 'tarde');

        const timeSlotsContainer = document.getElementById('time-slots-remarcar');
        if (!remarcarSelection.data) {
            timeSlotsContainer.innerHTML = '<p class="col-span-4 text-gray-400 text-sm">Selecione uma data para ver os horários</p>';
            return;
        }

        const allTimes = {
            manha: ['08:00', '08:40', '09:20', '10:00', '10:40', '11:20'],
            tarde: ['13:00', '13:40', '14:20', '15:00', '15:40', '16:20', '17:00', '17:40', '18:20', '19:00']
        };

        const now = new Date();
        const selectedDate = new Date(remarcarSelection.data);
        
        let availableTimes = allTimes[periodo].filter(time => {
            if (selectedDate.toDateString() === now.toDateString()) {
                const [hours, minutes] = time.split(':');
                const slotTime = new Date(selectedDate);
                slotTime.setHours(parseInt(hours), parseInt(minutes));
                return slotTime > now;
            }
            return true;
        });

        if (availableTimes.length > 0) {
            timeSlotsContainer.innerHTML = availableTimes.map(time => `<div class="p-3 rounded-lg cursor-pointer time-slot" onclick="selectRemarcarTime(this, '${time}')">${time}</div>`).join('');
        } else {
            timeSlotsContainer.innerHTML = `<p class="col-span-4 text-gray-400 text-sm">Não há horários disponíveis para este período.</p>`;
        }
    }

    function selectRemarcarDate(element, year, month, day) {
        if (element.hasAttribute('disabled')) return;
        document.querySelectorAll('#calendar-container-remarcar .calendar-day.selected').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        remarcarSelection.data = new Date(year, month, day).toISOString();
        showTimeSlotsRemarcar('manha');
    }

    function selectRemarcarTime(element, time) {
        document.querySelectorAll('#time-slots-remarcar .time-slot.selected').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        remarcarSelection.hora = time;
        
        const confirmBtn = document.getElementById('confirm-remarcar-btn');
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('opacity-50');
        confirmBtn.onclick = () => showConfirmarRemarcacaoModal(remarcarSelection.id, remarcarSelection.data, remarcarSelection.hora);
    }

    function showConfirmarRemarcacaoModal(id, newDateISO, newTime) {
        const agendamento = agendamentos.abertos.find(ag => ag.id === id);
        const dataAntiga = new Date(agendamento.data);
        const dataNova = new Date(newDateISO);

        const dataAntigaFormatada = dataAntiga.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });
        const horaAntigaFormatada = dataAntiga.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        const dataNovaFormatada = dataNova.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });

        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-calendar-check text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Confirmar Remarcação</h2>
                <div class="text-left space-y-4 text-secondary mb-6">
                    <div>
                        <p class="font-semibold text-gray-400">De:</p>
                        <p class="text-white">${dataAntigaFormatada} às ${horaAntigaFormatada}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-400">Para:</p>
                        <p class="text-white">${dataNovaFormatada} às ${newTime}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showRemarcarModal(${id})">Voltar</button>
                    <button class="w-full py-2 font-semibold rounded-lg btn-plan" onclick="handleRemarcacao(${id}, '${newDateISO}', '${newTime}')">Confirmar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function handleRemarcacao(id, newDateISO, newTime) {
        const agendamentoIndex = agendamentos.abertos.findIndex(ag => ag.id === id);
        if (agendamentoIndex === -1) return;

        const [hours, minutes] = newTime.split(':');
        const newDate = new Date(newDateISO);
        newDate.setHours(parseInt(hours), parseInt(minutes));
       
        agendamentos.abertos[agendamentoIndex].data = newDate.toISOString();
        saveState();
        
        showRemarcacaoSuccessModal();
    }

    function showRemarcacaoSuccessModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Agendamento Remarcado!</h2>
                <p class="text-secondary mb-6">Seu horário foi atualizado com sucesso.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="closeModalAndRender('historico')">Fechar</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function showCancelarConfirmacaoModal(id) {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Confirmar Cancelamento</h2>
                <p class="text-secondary mb-6">Você tem certeza que deseja cancelar este agendamento? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center space-x-4">
                    <button class="py-2 px-6 font-bold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button class="py-2 px-6 font-bold rounded-lg bg-red-600 text-white" onclick="confirmarCancelamento(${id})">Cancelar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function confirmarCancelamento(id) {
        const agendamentoParaCancelar = agendamentos.abertos.find(ag => ag.id === id);

        if (agendamentoParaCancelar) {
            if (agendamentoParaCancelar.usedInPlan && userSubscription.usedServices > 0) {
                userSubscription.usedServices--;
            }
            if (agendamentoParaCancelar.usedReferralCredit) {
                userInfo.referralCredits += 50;
            }
        }
        
        agendamentos.abertos = agendamentos.abertos.filter(ag => ag.id !== id);
        
        saveState();
        closeModal(() => {
            renderView('historico');
        });
    }

    function renderPlaceholderView(viewName) {
        mainContent.innerHTML = `
            <div class="p-6 h-full flex flex-col items-center justify-center text-center">
                <i class="fas fa-tools text-5xl text-gray-600 mb-4"></i>
                <h1 class="text-2xl font-bold text-primary capitalize">${viewName}</h1>
                <p class="text-secondary mt-2">Esta funcionalidade está em desenvolvimento.</p>
            </div>
        `;
    }

    // --- LÓGICA DE AGENDAMENTO ---
    function attachAgendarEventListeners() {
        document.getElementById('select-unidade').addEventListener('click', showUnidades);
        document.getElementById('select-barbeiro').addEventListener('click', showBarbeiros);
        document.getElementById('select-servico').addEventListener('click', showServicos);
        document.getElementById('select-data').addEventListener('click', showCalendario);
        
        document.getElementById('agendar-btn').addEventListener('click', () => {
             if (userLoggedIn) {
                 showResumoAgendamentoModal();
            } else {
                 showLogin();
            }
        });
    }

    function checkAgendarButton() {
        const agendarBtn = document.getElementById('agendar-btn');
        if (!agendarBtn) return;

        if (agendamentos.abertos.length >= 2) {
            agendarBtn.textContent = 'Máximo de 2 agendamentos em aberto';
            agendarBtn.disabled = true;
            agendarBtn.classList.remove('active');
            agendarBtn.style.backgroundColor = '#374151';
            agendarBtn.style.cursor = 'not-allowed';
            return;
        }
        
        agendarBtn.style.backgroundColor = '';
        agendarBtn.style.cursor = '';
        agendarBtn.textContent = 'Agendar';

        if (selection.unidade && selection.barbeiro && selection.servico && selection.data && selection.hora) {
            agendarBtn.classList.add('active');
            agendarBtn.disabled = false;
        } else {
            agendarBtn.classList.remove('active');
            agendarBtn.disabled = true;
        }
    }

    function updateStepUI() {
        const steps = ['unidade', 'barbeiro', 'servico', 'data'];
        let enabled = true;
        steps.forEach(step => {
            const el = document.getElementById(`select-${step}`);
            if (enabled) {
                el.classList.remove('disabled');
            } else {
                el.classList.add('disabled');
            }
            if (!selection[step]) {
                enabled = false;
            }
        });
    }

    function showUnidades() {
        let content = `<h2 class="text-xl font-bold mb-6 text-center modal-title">Escolha uma unidade</h2>`;
        content += unidades.map(u => `
            <div class="flex items-center p-3 rounded-lg mb-3 cursor-pointer selection-item" onclick="selectUnidade(${u.id})">
                <img src="${u.img}" alt="${u.nome}" class="w-20 h-20 rounded-lg mr-4 object-cover">
                <div class="flex-1">
                    <p class="font-semibold text-white">${u.nome}</p>
                    <p class="text-sm text-secondary"><i class="fas fa-map-marker-alt mr-1 text-primary"></i>${u.endereco}</p>
                </div>
            </div>
        `).join('');
        openModal(content);
    }

    function selectUnidade(id) {
        selection.unidade = unidades.find(u => u.id === id);
        if (!selection.unidade) return;

        // Reseta as seleções seguintes, mas preserva o serviço se for resgate
        selection.barbeiro = null;
        if (!selection.isFromCreditRedemption) {
            selection.servico = null;
        }
        selection.data = null;
        selection.hora = null;

        updateAgendarViewFromState();
        closeModal();
        saveState();
    }

    function showBarbeiros() {
        if (!selection.unidade) return;
        let content = `<h2 class="text-xl font-bold mb-6 text-center modal-title">Escolha um profissional</h2>`;
        content += barbeiros.map(b => `
            <div class="flex items-center p-3 rounded-lg mb-3 cursor-pointer selection-item" onclick="selectBarbeiro(${b.id})">
                <img src="${b.img || 'https://placehold.co/100x100/333333/FFFFFF?text=S/F'}" alt="${b.nome}" class="w-16 h-16 rounded-full mr-4 object-cover">
                <div>
                    <p class="font-semibold text-white">${b.nome}</p>
                    <p class="text-sm text-secondary">${b.funcao}</p>
                </div>
            </div>
        `).join('');
        openModal(content);
    }

    function selectBarbeiro(id) {
        selection.barbeiro = barbeiros.find(b => b.id === id);
        if(!selection.barbeiro) return;

        // Reseta as seleções seguintes, mas preserva o serviço se for resgate
        if (!selection.isFromCreditRedemption) {
            selection.servico = null;
        }
        selection.data = null;
        selection.hora = null;
        
        // Pula para a seleção de data se o serviço já estiver definido (resgate)
        if (selection.isFromCreditRedemption && selection.servico) {
            updateAgendarViewFromState();
            saveState(); 
            // Passa a função showCalendario como callback para ser executada após o modal fechar
            closeModal(showCalendario);
        } else {
            updateAgendarViewFromState();
            closeModal();
            saveState();
        }
    }
    
    function showServicos() {
        if (!selection.unidade || !selection.barbeiro) return;
        
        // Bloqueia a seleção de serviço se for um resgate de meta
        if (selection.isFromCreditRedemption && servicos.some(s => s.id === selection.servico?.id)) {
            return;
        }

        const diaDaSemana = selection.data ? new Date(selection.data).getDay() : -1;
        const temPromocao = diaDaSemana >= 1 && diaDaSemana <= 3;

        let content = `<h2 class="text-xl font-bold mb-6 text-center modal-title">Escolha um serviço</h2>`;
        content += '<div class="space-y-3 service-list-scroll max-h-[60vh] overflow-y-auto pr-2">';
        content += servicos.map(s => {
            const precoHtml = temPromocao && s.promocao
                ? `<span class="font-bold text-primary">R$ ${s.promocao.toFixed(2)}</span> <span class="text-xs line-through text-gray-400">R$ ${s.preco.toFixed(2)}</span>`
                : `<span class="font-bold text-white">R$ ${s.preco.toFixed(2)}</span>`;

            return `
                <div class="flex items-center justify-between p-4 rounded-lg cursor-pointer selection-item" onclick="selectServico(${s.id})">
                    <div>
                        <p class="font-semibold text-white">${s.nome}</p>
                        <p class="text-sm text-secondary"><i class="far fa-clock mr-1 text-primary"></i>${s.duracao}</p>
                    </div>
                    <div class="text-right">
                        ${precoHtml}
                    </div>
                </div>
            `;
        }).join('');
        content += '</div>';
        openModal(content);
    }

    function selectServico(id) {
        // Fallback guard clause to prevent changing service during redemption
        if (selection.isFromCreditRedemption) return;

        selection.servico = servicos.find(s => s.id === id);
        if(!selection.servico) return;
        
        const el = document.getElementById('servico-text');
        // This element might not exist if the view was manipulated by another flow, so we check it.
        if (el) {
            el.textContent = selection.servico.nome;
            el.classList.remove('selection-item-text');
            el.classList.add('selected');
        }
        
        updateAgendarViewFromState();
        closeModal();
        saveState();
    }

    function showCalendario() {
        if(!selection.unidade || !selection.barbeiro || !selection.servico) return;
        let displayMonth = new Date().getMonth();
        let displayYear = new Date().getFullYear();
        
        function renderCalendar(month, year) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const limitDate = new Date();
            limitDate.setDate(limitDate.getDate() + 7);
            limitDate.setHours(0, 0, 0, 0);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            let calendarHeader = `<div class="flex justify-between items-center text-white mb-4 px-2">
                <button id="prev-month" class="text-xl p-2"><i class="fas fa-chevron-left"></i></button>
                <h3 class="font-bold text-lg">${monthNames[month]} ${year}</h3>
                <button id="next-month" class="text-xl p-2"><i class="fas fa-chevron-right"></i></button>
            </div>`;
            
            let dayHeaders = `<div class="grid grid-cols-7 text-center text-sm mb-2">
                ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => `<div class="calendar-day-header">${d}</div>`).join('')}
            </div>`;
            
            let daysGrid = `<div class="calendar-grid">`;
            for (let i = 0; i < firstDayOfMonth; i++) { daysGrid += `<div></div>`; }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();

                const isSelectable = currentDate >= today && currentDate <= limitDate && dayOfWeek !== 0;
                const isToday = currentDate.getTime() === today.getTime();
                
                let dayClass = 'calendar-day';
                if (isSelectable) {
                    dayClass += ' available';
                    if(isToday) {
                        dayClass += ' today';
                    }
                } else {
                    dayClass += ' unavailable';
                }

                daysGrid += `<div class="${dayClass}" data-date="${year}-${month+1}-${day}" ${!isSelectable ? 'disabled' : ''} onclick="selectDate(this, ${year}, ${month}, ${day})">${day}</div>`;
            }
            daysGrid += `</div>`;
            
            return `<div style="width: 300px;">${calendarHeader}${dayHeaders}${daysGrid}</div>`;
        }

        let content = `
            <div class="info-card">
                <h2 class="text-xl font-bold mb-4 text-center modal-title">Data do agendamento</h2>
                <div class="flex justify-center">
                    <div id="calendar-container"></div>
                </div>
                <div class="mt-6">
                    <h3 class="font-bold text-center mb-4 text-white">Escolha o melhor horário</h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="btn-manha" class="py-2 rounded-lg btn-primary active" onclick="showTimeSlots('manha')">Manhã</button>
                        <button id="btn-tarde" class="py-2 rounded-lg btn-primary" onclick="showTimeSlots('tarde')">Tarde</button>
                    </div>
                    <div id="time-slots" class="grid grid-cols-4 gap-2 text-center">
                        <p class="col-span-4 text-gray-400 text-sm">Selecione uma data para ver os horários</p>
                    </div>
                </div>
            </div>
        `;
        openModal(content);

        function updateCalendar() {
            document.getElementById('calendar-container').innerHTML = renderCalendar(displayMonth, displayYear);
            document.getElementById('prev-month').addEventListener('click', () => {
                displayMonth--;
                if (displayMonth < 0) { displayMonth = 11; displayYear--; }
                updateCalendar();
            });
            document.getElementById('next-month').addEventListener('click', () => {
                displayMonth++;
                if (displayMonth > 11) { displayMonth = 0; displayYear++; }
                updateCalendar();
            });

            setTimeout(autoSelectFirstAvailableDate, 50); 
        }
        updateCalendar();
    }
    
    function autoSelectFirstAvailableDate() {
        for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            if (date.getDay() !== 0) { // Não é domingo
                const day = date.getDate();
                const month = date.getMonth();
                const year = date.getFullYear();
                const dayElement = document.querySelector(`.calendar-day[data-date="${year}-${month+1}-${day}"]`);
                if (dayElement && !dayElement.hasAttribute('disabled')) {
                    selectDate(dayElement, year, month, day);
                    return;
                }
            }
        }
    }

    function showTimeSlots(periodo) {
        const btnManha = document.getElementById('btn-manha');
        const btnTarde = document.getElementById('btn-tarde');
        
        btnManha.classList.toggle('active', periodo === 'manha');
        btnTarde.classList.toggle('active', periodo === 'tarde');

        const timeSlotsContainer = document.getElementById('time-slots');
        if (!selection.data) {
            timeSlotsContainer.innerHTML = '<p class="col-span-4 text-gray-400 text-sm">Selecione uma data para ver os horários</p>';
            return;
        }

        const allTimes = {
            manha: ['08:00', '08:40', '09:20', '10:00', '10:40', '11:20'],
            tarde: ['13:00', '13:40', '14:20', '15:00', '15:40', '16:20', '17:00', '17:40', '18:20', '19:00']
        };

        const now = new Date();
        const selectedDate = new Date(selection.data);
        
        let availableTimes = allTimes[periodo].filter(time => {
            if (selectedDate.toDateString() === now.toDateString()) {
                const [hours, minutes] = time.split(':');
                const slotTime = new Date(selectedDate);
                slotTime.setHours(parseInt(hours), parseInt(minutes));
                return slotTime > now;
            }
            return true;
        });

        if (availableTimes.length > 0) {
            timeSlotsContainer.innerHTML = availableTimes.map(time => `<div class="p-3 rounded-lg cursor-pointer time-slot" onclick="selectTime(this, '${time}')">${time}</div>`).join('');
        } else {
            timeSlotsContainer.innerHTML = `<p class="col-span-4 text-gray-400 text-sm">Não há horários disponíveis para este período.</p>`;
        }
    }

    function selectDate(element, year, month, day) {
        if (element && element.hasAttribute('disabled')) return;
        
        document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
        if (element) {
             element.classList.add('selected');
        } else {
            const dayElement = document.querySelector(`.calendar-day[data-date="${year}-${month+1}-${day}"]`);
            if(dayElement) dayElement.classList.add('selected');
        }
        
        selection.data = new Date(year, month, day).toISOString();

        selection.hora = null;
        const dataTextEl = document.getElementById('data-text');
        if (dataTextEl) {
            dataTextEl.textContent = 'Selecionar data e hora';
            dataTextEl.classList.add('selection-item-text');
            dataTextEl.classList.remove('selected');
        }
        
        updateAgendarViewFromState();
        showTimeSlots('manha');
    }

    function selectTime(element, time) {
        document.querySelectorAll('.time-slot.selected').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        selection.hora = time;
        const date = new Date(selection.data);
        const weekDays = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        const dayName = weekDays[date.getDay()];
        const dayOfMonth = date.getDate();
        const monthName = date.toLocaleString('pt-BR', { month: 'long' });
        const el = document.getElementById('data-text');
        el.textContent = `${selection.hora} - ${dayName}, ${dayOfMonth} de ${monthName}`;
        el.classList.remove('selection-item-text');
        el.classList.add('selected');
        
        updateAgendarViewFromState();
        setTimeout(closeModal, 300);
        saveState();
    }
    
    function showLimiteAgendamentosModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-exclamation-circle text-4xl text-yellow-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Limite Atingido</h2>
                <p class="text-secondary mb-6">Você já possui o máximo de 2 agendamentos em aberto.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="closeModal()">Entendido</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function resetSelections() {
        selection = {
            unidade: null,
            barbeiro: null,
            servico: null,
            data: null,
            hora: null,
            isFromCreditRedemption: false
        };
    }

    function checkSubscriptionCoverage(serviceId) {
        if (!userSubscription.active || !userSubscription.plan) {
            return { isCovered: false, remainingServices: 0 };
        }

        const coveredServices = planServiceMapping[userSubscription.plan.title];
        if (!coveredServices || !coveredServices.includes(serviceId)) {
            return { isCovered: false, remainingServices: userSubscription.totalServices - userSubscription.usedServices };
        }

        const remaining = userSubscription.totalServices - userSubscription.usedServices;
        if (remaining > 0) {
            return { isCovered: true, remainingServices: remaining };
        }

        return { isCovered: false, remainingServices: 0 };
    }

    function showResumoAgendamentoModal() {
        const agendarBtn = document.getElementById('agendar-btn');
        if(!agendarBtn || agendarBtn.disabled) return;

        // Verificação defensiva para prevenir o erro reportado
        if (!selection.servico) {
            console.error("showResumoAgendamentoModal foi chamado sem um serviço selecionado.", selection);
            // Opcionalmente, mostrar uma mensagem de erro amigável aqui.
            // Por enquanto, vamos apenas prevenir o travamento.
            return;
        }

        if (agendamentos.abertos.length >= 2) {
            showLimiteAgendamentosModal();
            return;
        }

        const dataAgendamento = new Date(selection.data);
        const diaDaSemana = dataAgendamento.getDay();
        const temPromocao = diaDaSemana >= 1 && diaDaSemana <= 3;
        
        // Lógica de Assinatura
        const { isCovered, remainingServices } = checkSubscriptionCoverage(selection.servico.id);
        
        let precoFinal;
        let precoOriginal = selection.servico.preco;
        let descontoSemana = 0;
        let planBenefitHtml = '';
        let creditBenefitHtml = '';

        if (selection.isFromCreditRedemption) {
            precoFinal = 0;
            creditBenefitHtml = `
                <div class="flex justify-between text-green-400">
                    <span>Resgate de Crédito</span>
                    <span>- R$ ${precoOriginal.toFixed(2)}</span>
                </div>
                <div class="bg-primary/10 border-l-4 border-primary text-primary p-3 rounded-r-lg text-sm mt-3" role="alert">
                    <p class="font-bold">Serviço resgatado com seus créditos de indicação!</p>
                </div>
            `;
        } else if (isCovered) {
            precoFinal = 0;
            planBenefitHtml = `
                <div class="flex justify-between text-green-400">
                    <span>Incluso no seu plano</span>
                    <span>- R$ ${precoOriginal.toFixed(2)}</span>
                </div>
                <div class="bg-primary/10 border-l-4 border-primary text-primary p-3 rounded-r-lg text-sm mt-3" role="alert">
                    <p class="font-bold">Este serviço será abatido do seu plano.</p>
                </div>
            `;
        } else {
            precoFinal = temPromocao && selection.servico.promocao ? selection.servico.promocao : precoOriginal;
            descontoSemana = temPromocao && selection.servico.promocao ? precoOriginal - precoFinal : 0;
            if (userSubscription.active && !isCovered && remainingServices === 0) {
                 planBenefitHtml = `
                    <div class="bg-yellow-500/10 border-l-4 border-yellow-500 text-yellow-500 p-3 rounded-r-lg text-sm mt-3" role="alert">
                        <p class="font-bold">Seus serviços do plano esgotaram. Este agendamento será cobrado à parte.</p>
                    </div>
                `;
            }
        }


        const dataFormatada = dataAgendamento.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'long'
        });

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col auth-form">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Resumo do Agendamento</h2>
                
                <div class="text-left space-y-3 text-sm mb-6">
                    <p><strong class="text-gray-400">Unidade:</strong><br><span class="text-white">${selection.unidade.nome}</span></p>
                    <p><strong class="text-gray-400">Data:</strong><br><span class="text-white">${dataFormatada} às ${selection.hora}</span></p>
                    <p><strong class="text-gray-400">Profissional:</strong><br><span class="text-white">${selection.barbeiro.nome}</span></p>
                    <p><strong class="text-gray-400">Serviço:</strong><br><span class="text-white">${selection.servico.nome}</span></p>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <div id="cupom-section" class="${isCovered || selection.isFromCreditRedemption ? 'hidden' : ''}">
                        <div class="flex items-center justify-between mb-4">
                            <input type="text" id="cupom-input" placeholder="Cupom de desconto" class="w-full p-2 rounded-lg mr-2">
                            <button class="px-4 py-2 btn-primary rounded-lg text-sm font-bold" onclick="aplicarCupom()">Aplicar</button>
                        </div>
                        <div id="cupom-feedback" class="text-sm h-5 mb-2"></div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-secondary">Subtotal</span>
                            <span>R$ ${precoOriginal.toFixed(2)}</span>
                        </div>
                        ${creditBenefitHtml}
                        ${planBenefitHtml}
                        <div id="desconto-semana-row" class="flex justify-between text-green-400 ${descontoSemana > 0 && !isCovered && !selection.isFromCreditRedemption ? '' : 'hidden'}">
                            <span>Desconto Seg-Qua</span>
                            <span>- R$ ${descontoSemana.toFixed(2)}</span>
                        </div>
                        <div id="desconto-cupom-row" class="flex justify-between text-green-400 hidden">
                            <span>Desconto Cupom</span>
                            <span id="desconto-cupom-valor"></span>
                        </div>
                        <div class="flex justify-between font-bold text-lg border-t border-gray-700 pt-2 mt-2">
                            <span class="text-white">Total</span>
                            <span id="total-valor" class="text-primary">R$ ${precoFinal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="finalizarAgendamento(${isCovered})">Confirmar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function aplicarCupom() {
        const cupomInput = document.getElementById('cupom-input');
        const feedbackDiv = document.getElementById('cupom-feedback');
        const cupomCode = cupomInput.value.toUpperCase();

        if (cupomCode === 'VS10') {
            feedbackDiv.textContent = 'Cupom de 10% aplicado!';
            feedbackDiv.className = 'text-sm h-5 mb-2 text-green-400';
            recalcularTotal(0.10);
        } else {
            feedbackDiv.textContent = 'Cupom inválido.';
            feedbackDiv.className = 'text-sm h-5 mb-2 text-red-500';
            recalcularTotal(0);
        }
    }

    function recalcularTotal(descontoCupomPercent) {
        const dataAgendamento = new Date(selection.data);
        const diaDaSemana = dataAgendamento.getDay();
        const temPromocao = diaDaSemana >= 1 && diaDaSemana <= 3;
        const precoOriginal = selection.servico.preco;
        const precoPromocional = selection.servico.promocao;
        
        const precoBase = temPromocao && precoPromocional ? precoPromocional : precoOriginal;
        
        const valorDescontoCupom = precoBase * descontoCupomPercent;
        const precoFinal = precoBase - valorDescontoCupom;

        const descontoCupomRow = document.getElementById('desconto-cupom-row');
        const descontoCupomValor = document.getElementById('desconto-cupom-valor');
        const totalValor = document.getElementById('total-valor');

        if (valorDescontoCupom > 0) {
            descontoCupomValor.textContent = `- R$ ${valorDescontoCupom.toFixed(2)}`;
            descontoCupomRow.classList.remove('hidden');
        } else {
            descontoCupomRow.classList.add('hidden');
        }

        totalValor.textContent = `R$ ${precoFinal.toFixed(2)}`;
    }


    function finalizarAgendamento(usedInPlan) {
        const newId = Date.now();
        const [hours, minutes] = selection.hora.split(':');
        const finalDate = new Date(selection.data);
        finalDate.setHours(parseInt(hours), parseInt(minutes));

        if(usedInPlan) {
            userSubscription.usedServices++;
        }
        
        // Lógica para marcar meta como resgatada
        if (selection.isFromCreditRedemption) {
            const redeemedGoal = goals.find(g => g.serviceId === selection.servico.id);
            if (redeemedGoal && !userInfo.redeemedGoals.includes(redeemedGoal.id)) {
                userInfo.redeemedGoals.push(redeemedGoal.id);
            }
        }

        const novoAgendamento = {
            id: newId,
            data: finalDate.toISOString(),
            unidade: selection.unidade,
            barbeiro: selection.barbeiro,
            servico: selection.servico,
            avaliacao: null,
            usedInPlan: usedInPlan,
            usedReferralCredit: !!selection.isFromCreditRedemption
        };

        agendamentos.abertos.push(novoAgendamento);
        saveState();
        
        const dataFormatada = new Date(selection.data).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        const successMessage = `
            <div class="info-card text-center p-6 flex flex-col justify-center">
                <div class="mb-4">
                    <i class="far fa-check-circle text-6xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold mb-6 modal-title">Agendamento Confirmado!</h2>
                
                <div class="text-left space-y-5 text-secondary mb-8 text-base">
                    <div>
                        <p><strong class="text-white">Unidade:</strong> ${selection.unidade.nome}</p>
                        <a href="${selection.unidade.mapsUrl}" target="_blank" class="block w-full text-white font-semibold py-2 px-4 rounded-xl transition text-center mt-3 text-sm" style="background-color: #0b0b0a;">Ver localização</a>
                    </div>
                    <p><strong class="text-white">Barbeiro:</strong> ${selection.barbeiro.nome}</p>
                    <p><strong class="text-white">Serviços:</strong> ${selection.servico.nome}</p>
                    <p><strong class="text-white">Data:</strong> ${dataFormatada}</p>
                    <p><strong class="text-white">Horário:</strong> Às ${selection.hora}</p>
                </div>

                <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="closeModal(); renderView('historico');">Ver Meus Agendamentos</button>
            </div>
        `;
        openModal(successMessage);
        resetSelections();
        renderAgendarView(); // Adicionado para resetar a view de agendamento em segundo plano
    }

    // --- LÓGICA DE LOGIN/CADASTRO E REDEFINIÇÃO DE SENHA ---
    function showLogin() {
        const loginHtml = `
            <div class="p-6 text-center auth-form">
                 <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-16 h-16 mb-4 mx-auto">
                <h2 class="text-2xl font-bold text-white mb-2">Acesse sua conta</h2>
                 <div class="w-24 h-0.5 bg-primary mx-auto mb-8"></div>
                <div class="relative mb-4">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-user text-gray-400"></i></span>
                    <input type="text" id="login-user" oninput="validateLoginForm()" placeholder="E-mail ou telefone" class="w-full p-3 pl-10 rounded-lg">
                </div>
                <div class="relative mb-6">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-lock text-gray-400"></i></span>
                    <input type="password" id="login-pin" oninput="this.value = this.value.replace(/\\D/g, ''); validateLoginForm()" placeholder="PIN de 6 dígitos" class="w-full p-3 pl-10 rounded-lg" maxlength="6" inputmode="numeric">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('login-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                </div>
                <button id="login-btn" class="w-full py-3 btn-plan font-bold rounded-lg opacity-50" onclick="handleLogin()" disabled>Login</button>
                <a href="#" class="text-sm text-gray-400 mt-4 block" onclick="showEsqueciSenha()">Esqueceu a senha?</a>
                <p class="text-sm text-gray-400 mt-2">Não possui conta? <a href="#" class="font-bold text-primary" onclick="showCadastro()">Faça seu cadastro</a></p>
                <div class="mt-8">
                    <button class="btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                </div>
            </div>
        `;
        openModal(loginHtml, 'bg-transparent border-none', 'center');
    }
    
    function validateLoginForm() {
        const userInput = document.getElementById('login-user');
        const pinInput = document.getElementById('login-pin');
        const loginBtn = document.getElementById('login-btn');

        if (userInput.value.trim().length > 0 && pinInput.value.length === 6) {
            loginBtn.disabled = false;
            loginBtn.classList.remove('opacity-50');
        } else {
            loginBtn.disabled = true;
            loginBtn.classList.add('opacity-50');
        }
    }

    function handleLogin() {
        const loginBtn = document.getElementById('login-btn');
        loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        loginBtn.disabled = true;

        setTimeout(() => {
            userLoggedIn = true;
            saveState();
            closeModal();
            setTimeout(showResumoAgendamentoModal, 310);
        }, 3000);
    }

    function showCadastro() {
        const cadastroHtml = `
            <div class="p-6 text-center auth-form">
                <h2 class="text-2xl font-bold text-white mb-2">Criar conta</h2>
                <p class="text-secondary text-sm mb-6">Preencha o formulário abaixo com seus dados</p>
                <input type="text" id="signup-name" oninput="validateCadastroForm()" placeholder="Nome e Sobrenome" class="w-full p-3 rounded-lg mb-4">
                <input type="tel" id="signup-phone" oninput="formatPhone(event); validateCadastroForm();" placeholder="Telefone (celular)" class="w-full p-3 rounded-lg mb-4" inputmode="numeric">
                <input type="email" id="signup-email" oninput="validateCadastroForm()" placeholder="E-mail" class="w-full p-3 rounded-lg mb-4">
                <div class="relative mb-4">
                    <input type="password" id="signup-pin" oninput="validateCadastroForm()" placeholder="PIN de 6 dígitos" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('signup-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                </div>
                <div class="relative mb-4">
                    <input type="password" id="signup-confirm-pin" oninput="validateCadastroForm()" placeholder="Confirme o PIN" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('signup-confirm-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                </div>
                <div id="pin-error" class="text-red-500 text-sm h-4 mb-4"></div>
                <button id="create-account-btn" class="w-full py-3 btn-plan font-bold rounded-lg opacity-50" disabled onclick="handleCadastro()">Criar conta</button>
                <p class="text-xs text-gray-400 mt-4">Ao se cadastrar, você está de acordo com os <a href="#" class="underline">Termos de Uso</a> e <a href="#" class="underline">Política de Privacidade</a>.</p>
                <div class="mt-8">
                    <button class="btn-dark border border-gray-600" onclick="showLogin()">Voltar</button>
                </div>
            </div>
        `;
        openModal(cadastroHtml, 'bg-transparent border-none', 'center');
    }

    function showEsqueciSenha() {
        const esqueciSenhaHtml = `
            <div class="p-6 text-center auth-form">
                <h2 class="text-2xl font-bold text-white mb-2">Redefinir senha</h2>
                <p class="text-secondary text-sm mb-6">Tranquilo! Informe o celular utilizado no seu cadastro que lhe ajudaremos a definir uma nova senha.</p>
                <input type="tel" id="reset-phone" oninput="validateResetPhone(event)" placeholder="Telefone (celular)" class="w-full p-3 rounded-lg mb-4" inputmode="numeric">
                <div id="reset-error" class="text-red-500 text-sm h-4 mb-4"></div>
                <button id="reset-continue-btn" class="w-full py-3 btn-plan font-bold rounded-lg" onclick="handleResetPhoneSubmit()" disabled>Continuar</button>
                 <div class="mt-8">
                     <button class="btn-dark border border-gray-600" onclick="showLogin()">Voltar para Login</button>
                 </div>
            </div>
        `;
        modalContent.innerHTML = esqueciSenhaHtml;
    }
    
    function validateResetPhone(event) {
        const input = event.target;
        const button = document.getElementById('reset-continue-btn');
        const errorDiv = document.getElementById('reset-error');
        
        errorDiv.textContent = '';
        
        formatPhone(event);
        
        const cleanNumber = input.value.replace(/\D/g, '');
        
        if (cleanNumber.length === 11) {
            button.disabled = false;
        } else {
            button.disabled = true;
        }
    }

    function handleResetPhoneSubmit() {
        const phoneInput = document.getElementById('reset-phone');
        const button = document.getElementById('reset-continue-btn');
        const errorDiv = document.getElementById('reset-error');
        const cleanNumber = phoneInput.value.replace(/\D/g, '');

        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        button.disabled = true;
        
        setTimeout(() => {
            if (cleanNumber === registeredPhone) {
                showVerificarCodigo();
            } else {
                errorDiv.textContent = 'Celular não encontrado em nosso cadastro.';
                button.innerHTML = 'Continuar';
                validateResetPhone({ target: phoneInput }); 
            }
        }, 1500);
    }


    function showVerificarCodigo() {
        const verificarCodigoHtml = `
            <div class="p-6 text-center auth-form">
                <h2 class="text-2xl font-bold text-white mb-2">Código de Verificação</h2>
                <p class="text-secondary text-sm mb-6">Enviamos um código de 4 dígitos para o seu WhatsApp. Por favor, insira-o abaixo.</p>
                <div id="pin-inputs" class="flex justify-center gap-3 mb-6">
                    <input type="tel" maxlength="1" class="w-14 h-14 text-center text-2xl font-bold rounded-lg bg-[#333] border border-[#555] text-white focus:border-primary focus:ring-primary" />
                    <input type="tel" maxlength="1" class="w-14 h-14 text-center text-2xl font-bold rounded-lg bg-[#333] border border-[#555] text-white focus:border-primary focus:ring-primary" />
                    <input type="tel" maxlength="1" class="w-14 h-14 text-center text-2xl font-bold rounded-lg bg-[#333] border border-[#555] text-white focus:border-primary focus:ring-primary" />
                    <input type="tel" maxlength="1" class="w-14 h-14 text-center text-2xl font-bold rounded-lg bg-[#333] border border-[#555] text-white focus:border-primary focus:ring-primary" />
                </div>
                <button class="w-full py-3 btn-plan font-bold rounded-lg" onclick="showRedefinirSenha()">Verificar Código</button>
                <p class="text-sm text-gray-400 mt-4">Não recebeu o código? <a href="#" class="font-bold text-primary">Reenviar</a></p>
                 <div class="mt-8">
                     <button class="btn-dark border border-gray-600" onclick="showEsqueciSenha()">Voltar</button>
                 </div>
            </div>
        `;
        modalContent.innerHTML = verificarCodigoHtml;
        setupPinInputs();
    }

    function setupPinInputs() {
        const inputs = document.querySelectorAll('#pin-inputs input');
        inputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                input.value = input.value.replace(/\\D/g, '');
                if (input.value && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });
    }
    
    function showRedefinirSenha() {
        const redefinirSenhaHtml = `
            <div class="p-6 text-center auth-form">
                <h2 class="text-2xl font-bold text-white mb-2">Crie uma nova senha</h2>
                <p class="text-secondary text-sm mb-6">Sua nova senha deve ser um PIN de 6 dígitos.</p>
                <div class="relative mb-4">
                    <input type="password" id="new-pin" oninput="this.value = this.value.replace(/\\D/g, '')" placeholder="Novo PIN de 6 dígitos" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('new-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                </div>
                <div class="relative mb-6">
                    <input type="password" id="confirm-new-pin" oninput="this.value = this.value.replace(/\\D/g, '')" placeholder="Confirme o novo PIN" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('confirm-new-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                </div>
                <button class="w-full py-3 btn-plan font-bold rounded-lg" onclick="handleSenhaRedefinida()">Salvar Nova Senha</button>
            </div>
        `;
        modalContent.innerHTML = redefinirSenhaHtml;
    }

    function handleSenhaRedefinida() {
        const successHtml = `
            <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-6xl text-primary mb-4"></i>
                <h2 class="text-2xl font-bold mb-4 modal-title">Senha Redefinida!</h2>
                <p class="text-secondary mb-6">Sua senha foi alterada com sucesso. Você já pode fazer o login com seu novo PIN.</p>
                <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="showLogin()">Ir para Login</button>
            </div>
        `;
        modalContent.innerHTML = successHtml;
    }
    
    function formatPhone(event) {
        let input = event.target;
        let value = input.value.replace(/\D/g, '');
        value = value.substring(0, 11);
        let formatted = '';
        if (value.length > 0) {
            formatted = '(' + value.substring(0, 2);
        }
        if (value.length > 2) {
            formatted += ') ' + value.substring(2, 3);
        }
        if (value.length > 3) {
            formatted += ' ' + value.substring(3, 7);
        }
        if (value.length > 7) {
            formatted += '-' + value.substring(7, 11);
        }
        input.value = formatted;
    }

    function validateCadastroForm() {
        const name = document.getElementById('signup-name');
        const phone = document.getElementById('signup-phone');
        const email = document.getElementById('signup-email');
        const pin = document.getElementById('signup-pin');
        const confirmPin = document.getElementById('signup-confirm-pin');
        const errorDiv = document.getElementById('pin-error');
        const createBtn = document.getElementById('create-account-btn');

        pin.value = pin.value.replace(/\D/g, '');
        confirmPin.value = confirmPin.value.replace(/\D/g, '');

        let allValid = true;

        if (pin.value.length > 0 && confirmPin.value.length > 0 && pin.value !== confirmPin.value) {
            errorDiv.textContent = 'Os PINs não conferem.';
            allValid = false;
        } else {
            errorDiv.textContent = '';
        }

        if (name.value.trim().split(' ').length < 2) allValid = false;
        if (phone.value.replace(/\D/g, '').length !== 11) allValid = false;
        if (!email.value.includes('@')) allValid = false;
        if (pin.value.length !== 6) allValid = false;
        if (confirmPin.value.length !== 6) allValid = false;

        if (allValid) {
            createBtn.disabled = false;
            createBtn.classList.remove('opacity-50');
        } else {
            createBtn.disabled = true;
            createBtn.classList.add('opacity-50');
        }
    }

    function togglePinVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.parentElement.querySelector('i');
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function showWelcomeModal(firstName) {
        const welcomeHtml = `
            <div class="info-card text-center p-6 flex flex-col justify-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-6xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4 modal-title">Bem-vindo, ${firstName}!</h2>
                <p class="text-secondary mb-8">Sua conta foi criada com sucesso. Agora ficou ainda mais fácil agendar seu horário!</p>
                <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="handleWelcomeContinue()">Continuar Agendamento</button>
            </div>
        `;
        openModal(welcomeHtml, '', 'center');
    }

    function handleWelcomeContinue() {
        userLoggedIn = true;
        saveState();
        closeModal(showResumoAgendamentoModal);
    }

    function handleCadastro() {
        const nameInput = document.getElementById('signup-name');
        const firstName = nameInput ? nameInput.value.trim().split(' ')[0] : '';
        userLoggedIn = true;
        saveState();
        closeModal(() => showWelcomeModal(firstName));
    }
    
    function handleLogout() {
        showLogoutConfirmationModal();
    }

    function resgatarMetaServico(serviceId) {
        const servicoMeta = servicos.find(s => s.id === serviceId);
        if (!servicoMeta) return;

        resetSelections();
        selection.servico = servicoMeta;
        selection.isFromCreditRedemption = true; // Usamos a mesma flag para indicar que é uma cortesia

        showResgateMetaConfirmacaoModal(servicoMeta.nome);
    }
    
    function showResgateMetaConfirmacaoModal(serviceName) {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-gift text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Resgatar Recompensa</h2>
                <p class="text-secondary mb-6">Parabéns! Você está prestes a resgatar sua <strong>${serviceName}</strong>. Vamos agendar seu horário?</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Depois</button>
                    <button class="w-full py-2 font-semibold rounded-lg btn-plan" onclick="handleResgateDeMeta()">Agendar Agora</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }
    
    function handleResgateDeMeta() {
        closeModal(() => {
            renderView('agendar');
            // Inicia o fluxo de agendamento, como se o usuário tivesse clicado no primeiro passo
            setTimeout(() => {
                const unidadeStep = document.getElementById('select-unidade');
                if (unidadeStep && !unidadeStep.classList.contains('disabled')) {
                    unidadeStep.click();
                }
            }, 100);
        });
    }


    function showResgatarCreditoModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-gift text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Resgatar Crédito</h2>
                <p class="text-secondary mb-6">Você está prestes a usar R$ 50,00 dos seus créditos para resgatar um <strong>Corte de Cabelo</strong>. Deseja continuar?</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Cancelar</button>
                    <button class="w-full py-2 font-semibold rounded-lg btn-plan" onclick="handleResgateDeCredito()">Sim, Resgatar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function handleResgateDeCredito() {
        if (userInfo.referralCredits < 50) return;
        userInfo.referralCredits -= 50;
        saveState();
        
        resetSelections();
        const corteDeCabelo = servicos.find(s => s.id === 1); // ID 1 = Corte de Cabelo
        if (corteDeCabelo) {
            selection.servico = corteDeCabelo;
        }
        selection.isFromCreditRedemption = true; 
        
        closeModal(() => {
            renderView('agendar');
            setTimeout(() => {
                const unidadeStep = document.getElementById('select-unidade');
                if (unidadeStep && !unidadeStep.classList.contains('disabled')) {
                    unidadeStep.click();
                }
            }, 100);
        });
    }

    function confirmLogout() {
        userLoggedIn = false;
        resetSelections();
        closeModal(() => {
            renderView('perfil');
        });
    }

    function showLogoutConfirmationModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-door-open text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Confirmar Saída</h2>
                <p class="text-secondary mb-6">Você tem certeza que deseja sair da sua conta?</p>
                <div class="flex justify-center space-x-4">
                    <button class="py-2 px-6 font-bold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Ficar</button>
                    <button class="py-2 px-6 font-bold rounded-lg bg-red-600 text-white" onclick="confirmLogout()">Sair</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    // --- MODAIS DO PERFIL E AVALIAÇÃO ---
    
    function rebookAppointment(id) {
        const appointmentToRebook = agendamentos.historico.find(ag => ag.id === id);
        if (!appointmentToRebook) return;

        resetSelections();

        selection.unidade = appointmentToRebook.unidade;
        selection.barbeiro = appointmentToRebook.barbeiro;
        selection.servico = appointmentToRebook.servico;

        renderView('agendar');

        setTimeout(() => {
            const dataStepElement = document.getElementById('select-data');
            if (dataStepElement) {
                dataStepElement.click();
            }
        }, 100);
    }

    function copyReferralCode() {
        const codeElement = document.getElementById('referral-code');
        if (!codeElement) return;

        const code = codeElement.innerText;
        navigator.clipboard.writeText(code).then(() => {
            const button = document.querySelector('#referral-code-box button');
            if(button) {
                button.textContent = 'COPIADO!';
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = 'COPIAR';
                    button.disabled = false;
                }, 2000);
            }
        }).catch(err => {
            console.error('Falha ao copiar o código: ', err);
        });
    }

    function showIndiqueAmigoModal() {
        const referralCode = userInfo.referralCode || "VSBARBEARIA10";
        const message = `Fala, mestre! ✂️ Estou te dando um desconto de 20% no seu primeiro serviço na VS Barbearia. Use meu código *${referralCode}* no agendamento. Baixe o app e agende seu horário: https://vsbarbearia.com.br`;
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px; max-height: 90vh;">
                <div class="text-center mb-6">
                    <i class="fas fa-gift text-5xl text-primary mb-3"></i>
                    <h2 class="text-2xl font-bold modal-title">Indique e Ganhe!</h2>
                    <p class="text-secondary text-sm">Convide seus amigos e ganhem benefícios juntos.</p>
                </div>
                
                <div class="flex-grow overflow-y-auto pr-2 modal-scroll-hidden space-y-4">
                    <div class="bg-[#2a2a2a] p-4 rounded-lg flex items-start">
                        <i class="fas fa-percent text-primary text-xl w-8 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Seu amigo ganha 20% OFF</h3>
                            <p class="text-sm text-secondary">Ele aproveita um desconto especial no primeiro serviço ao usar seu código.</p>
                        </div>
                    </div>
                     <div class="bg-[#2a2a2a] p-4 rounded-lg flex items-start">
                        <i class="fas fa-hand-holding-usd text-primary text-xl w-8 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Você ganha R$10 de crédito</h3>
                            <p class="text-sm text-secondary">Após o primeiro serviço do seu amigo, você recebe R$10 de crédito.</p>
                        </div>
                    </div>

                    <div class="bg-[#2a2a2a] p-4 rounded-lg">
                        <h3 class="font-bold text-primary text-center mb-3">Metas de Indicação</h3>
                        <div class="space-y-3 text-sm">
                            <p><i class="fas fa-star text-yellow-400 mr-2"></i><strong>5 amigos:</strong> Ganhe uma Hidratação Grátis.</p>
                            <p><i class="fas fa-star text-yellow-400 mr-2"></i><strong>8 amigos:</strong> Ganhe um Brinde Exclusivo.</p>
                            <p><i class="fas fa-star text-yellow-400 mr-2"></i><strong>12 amigos:</strong> Ganhe um Shampoo Jaboque.</p>
                        </div>
                    </div>

                    <div class="text-center pt-4">
                        <p class="text-sm text-gray-400 mb-2">Seu código de indicação</p>
                        <div id="referral-code-box" class="flex items-center justify-between p-3 bg-[#111] border-2 border-dashed border-gray-600 rounded-lg">
                            <span id="referral-code" class="text-2xl font-bold tracking-widest text-white">${referralCode}</span>
                            <button onclick="copyReferralCode()" class="bg-primary text-black font-bold py-2 px-4 rounded-md text-sm transition-transform duration-200 hover:scale-105">COPIAR</button>
                        </div>
                    </div>
                </div>

                <div class="mt-auto pt-6 space-y-3">
                    <a href="${whatsappUrl}" target="_blank" class="btn-plan flex items-center justify-center w-full !bg-green-500 hover:!bg-green-600 !text-white text-base py-3">
                        <i class="fab fa-whatsapp mr-2"></i>Compartilhar via WhatsApp
                    </a>
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none p-0', 'center');
    }

    function formatBirthdate(event) {
        const input = event.target;
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 2) {
            value = `${value.substring(0, 2)}/${value.substring(2)}`;
        }
        if (value.length > 5) {
            value = `${value.substring(0, 5)}/${value.substring(5, 9)}`;
        }
        
        input.value = value;
    }

    function showEditarPerfilModal() {
        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Editar Perfil</h2>

                <div class="flex flex-col items-center mb-8">
                    <img id="modal-edit-pic" src="${userInfo.profilePic}" class="w-24 h-24 rounded-full object-cover mb-2 border-2 border-gray-600">
                    <button class="text-primary text-sm font-semibold" onclick="showTrocarFotoModal()">Trocar foto</button>
                </div>

                <form class="space-y-4 auth-form flex-grow">
                    <input type="text" id="edit-name" value="${userInfo.name}" oninput="validateProfileForm()" placeholder="Nome" class="w-full p-3 rounded-lg">
                    <input type="tel" id="edit-phone" value="${userInfo.phone}" oninput="formatPhone(event); validateProfileForm();" placeholder="Telefone (celular)" class="w-full p-3 rounded-lg">
                    <input type="email" id="edit-email" value="${userInfo.email}" oninput="validateProfileForm()" placeholder="E-mail" class="w-full p-3 rounded-lg">
                    <div>
                        <input type="text" id="edit-birthdate" value="${userInfo.birthdate || ''}" oninput="formatBirthdate(event); validateProfileForm();" placeholder="Data de aniversário (DD/MM/AAAA)" class="w-full p-3 rounded-lg" maxlength="10" inputmode="numeric">
                        <p class="text-xs text-gray-400 mt-3 text-center"><i class="fas fa-gift mr-1 text-primary"></i>Informe seu aniversário para ganhar mimos e descontos especiais!</p>
                    </div>
                </form>

                <div class="mt-auto grid grid-cols-2 gap-4 pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button id="save-profile-btn" class="w-full py-3 font-semibold rounded-lg btn-plan opacity-50" onclick="showSaveProfileConfirmation()" disabled>Salvar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function validateProfileForm() {
        const nameInput = document.getElementById('edit-name');
        const phoneInput = document.getElementById('edit-phone');
        const emailInput = document.getElementById('edit-email');
        const birthdateInput = document.getElementById('edit-birthdate');
        const saveBtn = document.getElementById('save-profile-btn');

        const nameChanged = nameInput.value !== userInfo.name;
        const phoneChanged = phoneInput.value !== userInfo.phone;
        const emailChanged = emailInput.value !== userInfo.email;
        const birthdateChanged = birthdateInput.value !== (userInfo.birthdate || '');

        // A mudança na data de aniversário só é considerada válida para salvar se o campo estiver vazio ou completo (10 chars).
        const isBirthdateChangeValid = birthdateChanged && (birthdateInput.value.length === 0 || birthdateInput.value.length === 10);

        const enableButton = nameChanged || phoneChanged || emailChanged || isBirthdateChangeValid;

        if (enableButton) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-50');
        } else {
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50');
        }
    }

    function showSaveProfileConfirmation() {
        const newName = document.getElementById('edit-name').value;
        const newPhone = document.getElementById('edit-phone').value;
        const newEmail = document.getElementById('edit-email').value;
        const newBirthdate = document.getElementById('edit-birthdate').value;

        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-save text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Confirmar Alterações</h2>
                <p class="text-secondary mb-6">Deseja salvar as alterações feitas no seu perfil?</p>
                <div class="flex justify-center space-x-4">
                    <button class="py-2 px-6 font-bold rounded-lg btn-dark border border-gray-600" onclick="showEditarPerfilModal()">Cancelar</button>
                    <button id="confirm-save-profile-btn" class="py-2 px-6 font-bold rounded-lg btn-plan" onclick="handleProfileUpdate('${newName}', '${newPhone}', '${newEmail}', '${newBirthdate}')">Salvar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function handleProfileUpdate(newName, newPhone, newEmail, newBirthdate) {
        const confirmBtn = document.getElementById('confirm-save-profile-btn');
        if (confirmBtn) {
            confirmBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            confirmBtn.disabled = true;
        }

        setTimeout(() => {
            userInfo.name = newName;
            userInfo.phone = newPhone;
            userInfo.email = newEmail;
            userInfo.birthdate = newBirthdate;
            saveState();
            
            const successHtml = `
                <div class="info-card text-center p-6">
                    <i class="far fa-check-circle text-6xl text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold mb-4 modal-title">Perfil Atualizado!</h2>
                    <p class="text-secondary mb-6">Suas informações foram salvas com sucesso.</p>
                    <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="closeModal()">Fechar</button>
                </div>
            `;
            modalContent.innerHTML = successHtml;

            setTimeout(() => {
                closeModal();
                renderView('perfil');
            }, 2500);
        }, 1500);
    }

    function showNotificacoesModal() {
        // Estado inicial e atual das notificações
        let currentNotificationsState = { email: true, push: true };
        const initialNotificationsState = { ...currentNotificationsState };

        const updateToggleUI = (toggleId, isActive) => {
            const toggleElement = document.getElementById(toggleId);
            if (!toggleElement) return;
            const bgDiv = toggleElement.querySelector('.toggle-bg');
            const ballDiv = toggleElement.querySelector('.toggle-ball');
            if (isActive) {
                bgDiv.classList.remove('bg-gray-600');
                bgDiv.classList.add('bg-primary');
                ballDiv.classList.add('translate-x-5');
            } else {
                bgDiv.classList.remove('bg-primary');
                bgDiv.classList.add('bg-gray-600');
                ballDiv.classList.remove('translate-x-5');
            }
        };

        const validateNotificationChanges = () => {
            const saveBtn = document.getElementById('save-notifications-btn');
            const hasChanged = currentNotificationsState.email !== initialNotificationsState.email || 
                               currentNotificationsState.push !== initialNotificationsState.push;

            if (hasChanged) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50');
            }
        };

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-2 modal-title">Notificações</h2>
                <p class="text-center text-secondary text-sm mb-8">Defina suas preferências de notificação.</p>
                <div class="space-y-4 flex-grow">
                    <div id="email-notif-toggle" class="flex justify-between items-center p-4 rounded-lg cursor-pointer bg-[#2a2a2a]">
                        <span class="text-white font-medium">Notificações por e-mail</span>
                        <div class="relative w-11 h-6 rounded-full transition-colors duration-300 ease-in-out toggle-bg">
                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 ease-in-out transform toggle-ball"></div>
                        </div>
                    </div>
                    <div id="push-notif-toggle" class="flex justify-between items-center p-4 rounded-lg cursor-pointer bg-[#2a2a2a]">
                        <span class="text-white font-medium">Notificações por push</span>
                        <div class="relative w-11 h-6 rounded-full transition-colors duration-300 ease-in-out toggle-bg">
                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 ease-in-out transform toggle-ball"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-auto grid grid-cols-2 gap-4 pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button id="save-notifications-btn" class="w-full py-3 font-semibold rounded-lg btn-plan opacity-50" onclick="closeModal()" disabled>Salvar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
        
        // Inicializa a UI com o estado atual e adiciona os listeners
        updateToggleUI('email-notif-toggle', currentNotificationsState.email);
        updateToggleUI('push-notif-toggle', currentNotificationsState.push);

        document.getElementById('email-notif-toggle').addEventListener('click', () => {
            currentNotificationsState.email = !currentNotificationsState.email;
            updateToggleUI('email-notif-toggle', currentNotificationsState.email);
            validateNotificationChanges();
        });
        document.getElementById('push-notif-toggle').addEventListener('click', () => {
            currentNotificationsState.push = !currentNotificationsState.push;
            updateToggleUI('push-notif-toggle', currentNotificationsState.push);
            validateNotificationChanges();
        });
    }

    function showAlterarPinModal() {
        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col auth-form" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Alterar PIN</h2>
                
                <div class="space-y-4 flex-grow">
                    <div class="relative">
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">PIN Atual</label>
                        <input type="password" id="current-pin" oninput="validatePinChangeForm()" placeholder="••••••" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                        <span class="absolute top-9 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('current-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                    </div>
                     <div class="relative">
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Novo PIN</label>
                        <input type="password" id="new-pin" oninput="validatePinChangeForm()" placeholder="••••••" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                        <span class="absolute top-9 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('new-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                    </div>
                    <div class="relative">
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Confirmar Novo PIN</label>
                        <input type="password" id="confirm-new-pin" oninput="validatePinChangeForm()" placeholder="••••••" class="w-full p-3 rounded-lg" maxlength="6" inputmode="numeric">
                         <span class="absolute top-9 right-0 flex items-center pr-3 cursor-pointer" onclick="togglePinVisibility('confirm-new-pin')"><i class="fas fa-eye text-gray-400"></i></span>
                    </div>
                    <div id="pin-change-error" class="text-red-500 text-sm h-4"></div>
                </div>

                <div class="mt-auto grid grid-cols-2 gap-4 pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button id="save-pin-btn" class="w-full py-3 font-semibold rounded-lg btn-plan opacity-50" onclick="handlePinChange()" disabled>Salvar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function validatePinChangeForm() {
        const currentPin = document.getElementById('current-pin');
        const newPin = document.getElementById('new-pin');
        const confirmNewPin = document.getElementById('confirm-new-pin');
        const errorDiv = document.getElementById('pin-change-error');
        const saveBtn = document.getElementById('save-pin-btn');

        currentPin.value = currentPin.value.replace(/\D/g, '');
        newPin.value = newPin.value.replace(/\D/g, '');
        confirmNewPin.value = confirmNewPin.value.replace(/\D/g, '');

        let allValid = true;
        errorDiv.textContent = ''; // Limpa o erro

        if (newPin.value.length === 6 && newPin.value === currentPin.value) {
            errorDiv.textContent = 'O novo PIN não pode ser igual ao atual.';
            allValid = false;
        }
        else if (newPin.value.length > 0 && confirmNewPin.value.length > 0 && newPin.value !== confirmNewPin.value) {
            errorDiv.textContent = 'Os novos PINs não conferem.';
            allValid = false;
        }

        if (currentPin.value.length !== 6) allValid = false;
        if (newPin.value.length !== 6) allValid = false;
        if (confirmNewPin.value.length !== 6) allValid = false;

        if (allValid) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-50');
        } else {
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50');
        }
    }

    function handlePinChange() {
        const saveBtn = document.getElementById('save-pin-btn');
        if (saveBtn) {
            saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            saveBtn.disabled = true;
        }

        setTimeout(() => {
            showPinChangeSuccessModal();
        }, 1500);
    }

    function showPinChangeSuccessModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-key text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">PIN Alterado!</h2>
                <p class="text-secondary mb-6">Seu PIN foi atualizado com sucesso. Use-o no seu próximo login.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="closeModal()">Fechar</button>
            </div>
        `;
        modalContent.innerHTML = modalHtml;
    }


    let currentRating = 0;
    function setRating(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll('.rating-stars i');
        const commentLabel = document.getElementById('comment-label');
        const submitBtn = document.getElementById('submit-avaliacao-btn');

        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('selected');
            } else {
                star.classList.remove('selected');
            }
        });

        if(submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
        }

        if(commentLabel) {
            commentLabel.style.opacity = 0;
            setTimeout(() => {
                if (rating > 0 && rating < 3) {
                    commentLabel.textContent = 'Algo em que podemos melhorar?';
                } else {
                    commentLabel.textContent = 'Deixar um comentário (opcional)';
                }
                commentLabel.style.opacity = 1;
            }, 150);
        }
    }

    function showAvaliacaoModal(id) {
        const agendamento = agendamentos.historico.find(ag => ag.id === id);
        if (!agendamento) return;
        currentRating = 0;

        const modalHtml = `
            <div class="p-6 text-white relative auth-form" style="background-color: #1e1e1e; border-radius: 1rem;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Avaliar atendimento</h2>
                
                <div class="text-left space-y-4 text-sm mb-6">
                    <p><strong class="text-gray-400">Profissional:</strong><br><span class="text-white">${agendamento.barbeiro.nome}</span></p>
                    <p><strong class="text-gray-400">Serviço:</strong><br><span class="text-white">${agendamento.servico.nome}</span></p>
                </div>

                <div class="border-t border-b border-gray-700 py-6">
                    <p class="text-center font-semibold mb-4">Como foi seu atendimento?</p>
                    <div class="flex justify-center items-center text-4xl rating-stars space-x-2">
                        <i class="fas fa-star" onclick="setRating(1)"></i>
                        <i class="fas fa-star" onclick="setRating(2)"></i>
                        <i class="fas fa-star" onclick="setRating(3)"></i>
                        <i class="fas fa-star" onclick="setRating(4)"></i>
                        <i class="fas fa-star" onclick="setRating(5)"></i>
                    </div>
                </div>

                <div class="mt-6">
                    <p id="comment-label" class="font-semibold mb-2 comment-label">Deixar um comentário (opcional)</p>
                    <textarea id="comment" rows="3" placeholder="Deixe seu comentário aqui..." class="w-full p-3 rounded-lg"></textarea>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-4">
                     <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                     <button id="submit-avaliacao-btn" class="w-full py-3 btn-plan font-bold rounded-lg opacity-50" onclick="handleAvaliacaoSubmit(${id})" disabled>Avaliar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function handleAvaliacaoSubmit(id) {
        const submitBtn = document.getElementById('submit-avaliacao-btn');
        if (!submitBtn || submitBtn.disabled) return;

        const agendamento = agendamentos.historico.find(ag => ag.id === id);
        if (agendamento) {
            agendamento.avaliacao = currentRating;
        }
        saveState();
        updateReviewNotification();
        
        const successHtml = `
            <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-6xl text-primary mb-4"></i>
                <h2 class="text-2xl font-bold mb-4 modal-title">Avaliação Enviada!</h2>
                <p class="text-secondary mb-6">Obrigado pelo seu feedback!</p>
                <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="closeModal()">Fechar</button>
            </div>
        `;
        modalContent.innerHTML = successHtml;

        setTimeout(() => {
            closeModal();
            renderView('historico');
        }, 2000);
    }

    function updateAgendarViewFromState() {
        const steps = ['unidade', 'barbeiro', 'servico', 'data'];
        let lastSelected = -1;

        steps.forEach((step, index) => {
            const elText = document.getElementById(`${step}-text`);
            // FIX: Adicionada verificação de existência do elemento para evitar erro no fluxo de resgate,
            // onde o span de serviço é substituído.
            if (elText) { 
                if (selection[step]) {
                    lastSelected = index;
                    if (step === 'data') {
                        const date = new Date(selection.data);
                        const weekDays = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                        const dayName = weekDays[date.getDay()];
                        const dayOfMonth = date.getDate();
                        const monthName = date.toLocaleString('pt-BR', { month: 'long' });
                        elText.textContent = `${selection.hora} - ${dayName}, ${dayOfMonth} de ${monthName}`;
                    } else {
                        elText.textContent = selection[step].nome;
                    }
                    elText.classList.remove('selection-item-text');
                    elText.classList.add('selected');
                } else {
                     if (step === 'data') {
                        elText.textContent = 'Selecionar data e hora';
                     } else {
                        elText.textContent = `Selecionar ${step}`;
                     }
                    elText.classList.add('selection-item-text');
                    elText.classList.remove('selected');
                }
            } else if (step === 'servico' && selection.servico) {
                // Se o span de texto do serviço não existe, mas um serviço está selecionado,
                // significa que estamos no fluxo de resgate e o passo deve ser considerado preenchido.
                lastSelected = index;
            }
        });

        steps.forEach((step, index) => {
            const elContainer = document.getElementById(`select-${step}`);
            if (!elContainer) return; // Defensive check
            
            // Se for resgate, habilita unidade e barbeiro para o usuário poder escolher
            if (selection.isFromCreditRedemption && (step === 'unidade' || step === 'barbeiro')) {
                 elContainer.classList.remove('disabled');
            } else if (index <= lastSelected + 1) {
                elContainer.classList.remove('disabled');
            } else {
                elContainer.classList.add('disabled');
            }
        });
        
        // Desabilita a troca de serviço se for um resgate de meta
        const servicoContainer = document.getElementById('select-servico');
        if (selection.isFromCreditRedemption && selection.servico) {
            servicoContainer.classList.add('disabled');
            servicoContainer.style.borderColor = '#fbb62c'; // Destaque visual
            servicoContainer.onclick = null; // Remove o evento de clique para travar a seleção
            servicoContainer.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-gift text-primary w-6 text-center"></i>
                    <div class="ml-4">
                        <span class="text-white font-bold">${selection.servico.nome}</span>
                        <p class="text-xs text-secondary">Sua recompensa de meta!</p>
                    </div>
                </div>
                <i class="fas fa-lock text-gray-500"></i>
            `;
        } else if (servicoContainer) {
             servicoContainer.onclick = showServicos; // Restaura o evento de clique se não for resgate
        }
        
        checkAgendarButton();
    }
    
    // --- MODAIS DE PLANOS ---
    function showSubscriptionModal(planTitle) {
        const plan = planos.find(p => p.title === planTitle);
        if (!plan) return;

        const getBrandIcon = (brand) => {
            if (brand === 'visa') return '<i class="fab fa-cc-visa text-3xl text-blue-400"></i>';
            if (brand === 'mastercard') return '<i class="fab fa-cc-mastercard text-3xl text-red-500"></i>';
            return '<i class="fas fa-credit-card text-3xl text-gray-400"></i>';
        }

        const primaryMethod = paymentMethods.find(p => p.primary);

        let paymentMethodHtml = '';
        if (primaryMethod) {
            paymentMethodHtml = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        ${getBrandIcon(primaryMethod.brand)}
                        <div class="ml-4">
                            <p class="text-sm font-bold text-white">Cartão final ${primaryMethod.last4}</p>
                            <p class="text-xs text-secondary">Crédito</p>
                        </div>
                    </div>
                    <button class="text-sm text-primary font-semibold" onclick="showAlterarPagamentoModal()">Alterar</button>
                </div>
            `;
        } else {
            paymentMethodHtml = `
                <button class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center justify-between" onclick="showAdicionarCartaoForm(() => showSubscriptionModal('${planTitle}'))">
                    <span><i class="fas fa-plus-circle w-6 text-center mr-3 text-primary"></i>Adicionar forma de pagamento</span>
                    <i class="fas fa-chevron-right text-gray-500"></i>
                </button>
            `;
        }

        const price = parseFloat(plan.price.replace(',', '.'));

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col auth-form">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Confirmar Assinatura</h2>
                
                <div class="text-left space-y-4 mb-6">
                    <div>
                        <p class="text-sm font-semibold text-gray-400">Plano</p>
                        <p class="font-bold text-white text-lg">${plan.title}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-400">Forma de Pagamento</p>
                        ${paymentMethodHtml}
                    </div>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <div class="flex items-center justify-between mb-4">
                        <input type="text" id="plan-cupom-input" placeholder="Cupom de desconto" class="w-full p-2 rounded-lg mr-2">
                        <button class="px-4 py-2 btn-primary rounded-lg text-sm font-bold" onclick="applyPlanCoupon(${price})">Aplicar</button>
                    </div>
                    <div id="plan-cupom-feedback" class="text-sm h-5 mb-2"></div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-secondary">Subtotal</span>
                            <span>R$ ${plan.price}</span>
                        </div>
                        <div id="plan-desconto-cupom-row" class="flex justify-between text-green-400 hidden">
                            <span>Desconto Cupom</span>
                            <span id="plan-desconto-cupom-valor"></span>
                        </div>
                        <div class="flex justify-between font-bold text-lg border-t border-gray-700 pt-2 mt-2">
                            <span class="text-white">Total Mensal</span>
                            <span id="plan-total-valor" class="text-primary">R$ ${plan.price}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-2 gap-4">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <button id="confirm-subscription-btn" class="w-full py-3 font-bold rounded-lg btn-plan ${!primaryMethod ? 'opacity-50' : ''}" onclick="showFinalSubscriptionSummaryModal('${plan.title}', document.getElementById('plan-total-valor').textContent)" ${!primaryMethod ? 'disabled' : ''}>Continuar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function showFinalSubscriptionSummaryModal(planTitle, finalPriceText) {
        const plan = planos.find(p => p.title === planTitle);
        if (!plan) return;

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Revise sua Assinatura</h2>
                
                <div class="flex-grow space-y-5">
                    <!-- Detalhes do Plano -->
                    <div class="bg-[#2a2a2a] p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-400">Plano</p>
                        <div class="flex justify-between items-baseline mt-1">
                            <span class="font-bold text-white text-lg">${plan.title}</span>
                            <span class="font-bold text-primary text-lg">${finalPriceText}</span>
                        </div>
                    </div>

                    <!-- Informações de Cobrança -->
                    <div>
                        <h3 class="font-semibold text-gray-300 mb-3">Como funciona a cobrança</h3>
                        <div class="text-sm space-y-3 text-secondary">
                            <div class="flex items-start">
                                <i class="fas fa-calendar-alt text-primary w-5 text-center mr-3 mt-1"></i>
                                <p>Sua assinatura começa hoje e a primeira cobrança será efetuada no seu método de pagamento principal.</p>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-redo text-primary w-5 text-center mr-3 mt-1"></i>
                                <p>A renovação é automática todos os meses para sua conveniência. Você será notificado antes de cada cobrança.</p>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-times-circle text-primary w-5 text-center mr-3 mt-1"></i>
                                <p>Cancele quando quiser. Você pode gerenciar ou cancelar sua assinatura a qualquer momento na tela de Planos.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Termos e Condições -->
                    <div class="text-center text-xs text-gray-500 pt-4">
                        <p>Ao clicar em "Confirmar", você concorda com a cobrança recorrente e com nossos <a href="#" class="underline text-primary" onclick="event.stopPropagation(); showTermosModal(); return false;">Termos de Serviço</a>.</p>
                    </div>
                </div>

                <div class="mt-auto pt-6 grid grid-cols-2 gap-4">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showSubscriptionModal('${plan.title}')">Voltar</button>
                    <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="handleSubscription('${plan.title}')">Confirmar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none p-0', 'center');
    }

    function applyPlanCoupon(originalPrice) {
        const cupomInput = document.getElementById('plan-cupom-input');
        const feedbackDiv = document.getElementById('plan-cupom-feedback');
        const cupomCode = cupomInput.value.toUpperCase();

        if (cupomCode === 'PRIMEIRAASSINATURA') {
            feedbackDiv.textContent = 'Cupom de 15% aplicado!';
            feedbackDiv.className = 'text-sm h-5 mb-2 text-green-400';
            recalculatePlanTotal(originalPrice, 0.15);
        } else {
            feedbackDiv.textContent = 'Cupom inválido.';
            feedbackDiv.className = 'text-sm h-5 mb-2 text-red-500';
            recalculatePlanTotal(originalPrice, 0);
        }
    }

    function recalculatePlanTotal(originalPrice, discountPercent) {
        const valorDescontoCupom = originalPrice * discountPercent;
        const precoFinal = originalPrice - valorDescontoCupom;

        const descontoCupomRow = document.getElementById('plan-desconto-cupom-row');
        const descontoCupomValor = document.getElementById('plan-desconto-cupom-valor');
        const totalValor = document.getElementById('plan-total-valor');

        if (valorDescontoCupom > 0) {
            descontoCupomValor.textContent = `- R$ ${valorDescontoCupom.toFixed(2).replace('.', ',')}`;
            descontoCupomRow.classList.remove('hidden');
        } else {
            descontoCupomRow.classList.add('hidden');
        }

        totalValor.textContent = `R$ ${precoFinal.toFixed(2).replace('.', ',')}`;
    }

    function handleSubscription(planTitle) {
        const newPlan = planos.find(p => p.title === planTitle);
        if (!newPlan) return;

        userSubscription.active = true;
        userSubscription.plan = newPlan;
        userSubscription.usedServices = 0;
        
        const nextBilling = new Date();
        nextBilling.setMonth(nextBilling.getMonth() + 1);
        userSubscription.nextBillingDate = nextBilling.toLocaleDateString('pt-BR');

        saveState();
        showSubscriptionSuccessModal(planTitle);
    }

    function showSubscriptionSuccessModal(planTitle) {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-6xl text-primary mb-4"></i>
                <h2 class="text-2xl font-bold mb-4 modal-title">Assinatura Confirmada!</h2>
                <p class="text-secondary mb-6">Bem-vindo ao clube! Sua assinatura do plano <strong>${planTitle}</strong> está ativa.</p>
                <button class="w-full py-3 font-bold rounded-lg btn-plan" onclick="closeModal(); renderView('planos');">Ver Meu Plano</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function showBeneficiosModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-gem text-5xl text-primary mb-4"></i>
                <h2 class="text-2xl font-bold mb-2 modal-title">Benefícios do VS Clube</h2>
                <p class="text-secondary mb-8">Veja as vantagens exclusivas de ser um assinante.</p>

                <div class="text-left space-y-5">
                    <div class="flex items-start">
                        <i class="fas fa-bolt text-primary text-lg w-6 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Agilidade e Conveniência</h3>
                            <p class="text-sm text-secondary">Agende seus horários de forma rápida e fácil, sem precisar esperar.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-tags text-primary text-lg w-6 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Descontos em Produtos</h3>
                            <p class="text-sm text-secondary">Aproveite preços especiais em nossa linha de produtos para cabelo e barba.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-plus-circle text-primary text-lg w-6 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Serviços Adicionais com Desconto</h3>
                            <p class="text-sm text-secondary">Tenha acesso a descontos exclusivos em serviços como hidratação, pigmentação e muito mais.</p>
                        </div>
                    </div>
                     <div class="flex items-start">
                        <i class="fas fa-star text-primary text-lg w-6 text-center mr-4 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-white">Prioridade e Exclusividade</h3>
                            <p class="text-sm text-secondary">Seja o primeiro a saber de novidades e tenha prioridade em eventos especiais.</p>
                        </div>
                    </div>
                </div>

                <button class="w-full mt-8 py-3 font-semibold rounded-lg btn-primary" onclick="closeModal()">Entendido</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function showPagamentosModal() {
        const paymentsHtml = paymentHistory.map(p => `
            <div class="flex justify-between items-center py-4 border-b border-gray-700 last:border-b-0">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-[#2a2a2a] rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-receipt text-primary"></i>
                    </div>
                    <div>
                        <p class="font-bold text-white">Pagamento de ${new Date(p.date.split('/').reverse().join('-')).toLocaleString('pt-BR', { month: 'long' })}</p>
                        <p class="text-xs text-secondary">${p.method}</p>
                    </div>
                </div>
                <div class="text-right">
                     <p class="font-bold text-white">R$ ${p.amount}</p>
                     <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-500/20 text-green-400">${p.status}</span>
                </div>
                 <button class="text-gray-400 hover:text-white ml-4 text-lg"><i class="fas fa-download"></i></button>
            </div>
        `).join('');

        const content = `
            <div class="info-card p-6 flex flex-col" style="min-height: 550px;">
                <div class="text-center mb-6">
                    <i class="fas fa-receipt text-4xl text-primary mb-3"></i>
                    <h2 class="text-2xl font-bold modal-title">Histórico de Pagamentos</h2>
                </div>
                <div class="flex-grow space-y-2 max-h-[60vh] overflow-y-auto pr-2 service-list-scroll">
                    ${paymentsHtml || '<p class="text-secondary text-center col-span-full">Nenhum pagamento encontrado.</p>'}
                </div>
                <div class="mt-auto pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                </div>
            </div>
        `;
        openModal(content, 'bg-transparent border-none p-0', 'center');
    }

    function showGerenciarAssinaturaModal() {
        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                 <h2 class="text-2xl font-bold text-center mb-8 modal-title">Gerenciar Assinatura</h2>

                <!-- Seção Meu Plano -->
                <div class="bg-[#2a2a2a] p-5 rounded-lg mb-6">
                    <h3 class="font-bold text-lg mb-3 text-white">Meu Plano</h3>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-secondary">${userSubscription.plan.title}</span>
                        <span class="font-bold text-white">R$ ${userSubscription.plan.price}/mês</span>
                    </div>
                    <div class="border-t border-gray-700 my-4"></div>
                    <p class="text-xs text-secondary">Próxima cobrança em: ${userSubscription.nextBillingDate}</p>
                </div>

                <!-- Seção Pagamento -->
                <div class="bg-[#2a2a2a] p-5 rounded-lg mb-6">
                    <h3 class="font-bold text-lg mb-3 text-white">Pagamento</h3>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                             <i class="fab fa-cc-visa text-3xl mr-4 text-blue-400"></i>
                             <div>
                                <p class="text-sm text-white">Cartão de Crédito</p>
                                <p class="text-xs text-secondary">Final **** 1234</p>
                             </div>
                        </div>
                        <button class="text-sm text-primary font-semibold" onclick="showAlterarPagamentoModal()">Alterar</button>
                    </div>
                </div>
                
                <!-- Seção Ações -->
                 <div class="space-y-4 flex-grow">
                    <button class="w-full text-left p-5 rounded-lg bg-[#2a2a2a] flex items-center justify-between hover:bg-[#3a3a3a] transition-colors" onclick="showMudarPlanoModal()">
                        <span class="font-semibold"><i class="fas fa-exchange-alt w-6 text-center mr-3 text-primary"></i>Mudar de plano</span>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                     <button class="w-full text-left p-5 rounded-lg bg-[#2a2a2a] flex items-center justify-between hover:bg-[#3a3a3a] transition-colors" onclick="showPausarAssinaturaModal()">
                        <span class="font-semibold"><i class="fas fa-pause-circle w-6 text-center mr-3 text-primary"></i>Pausar assinatura</span>
                         <i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                    <button class="w-full text-left p-5 rounded-lg bg-[#2a2a2a] flex items-center justify-between hover:bg-[#3a3a3a] transition-colors" onclick="showCancelarAssinaturaModal()">
                        <span class="text-red-500 font-semibold"><i class="fas fa-times-circle w-6 text-center mr-3"></i>Cancelar assinatura</span>
                         <i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                </div>
                <div class="mt-auto pt-6">
                    <div class="border-t border-gray-700 my-4"></div>
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }
    
    function showCancelarAssinaturaModal(selectedReason = '') {
        const isReasonSelected = selectedReason !== '';
        const confirmButtonDisabled = isReasonSelected ? '' : 'disabled';
        const confirmButtonOpacity = isReasonSelected ? '' : 'opacity-50';

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                 <h2 class="text-2xl font-bold text-center mb-4 text-red-500">Cancelar Assinatura</h2>
                 <p class="text-center text-secondary text-sm mb-8">Lamentamos ver você partir. Por favor, conte-nos o motivo.</p>

                <div class="space-y-4 text-left flex-grow mb-4 auth-form">
                    <div id="select-cancel-reason" class="flex items-center justify-between p-3 rounded-lg cursor-pointer selection-item" onclick="showCancelReasonModal('${selectedReason}')">
                        <span id="cancel-reason-text" class="${isReasonSelected ? 'text-white' : 'selection-item-text'}">${isReasonSelected ? selectedReason : 'Selecione um motivo...'}</span>
                        <i class="fas fa-chevron-down text-gray-500"></i>
                    </div>
                    <textarea id="cancel-comment" class="w-full p-3 rounded-lg" rows="4" placeholder="Deixe um comentário (opcional)"></textarea>
                </div>

                <div class="mt-auto grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showGerenciarAssinaturaModal()">Manter Plano</button>
                    <button id="confirm-cancel-btn" class="w-full py-2 font-semibold rounded-lg bg-red-600 text-white ${confirmButtonOpacity}" onclick="handleSubscriptionCancellation()" ${confirmButtonDisabled}>Confirmar Cancelamento</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function showCancelReasonModal(currentReason) {
        const cancelReasons = [
            'O valor está muito alto',
            'Não estou usando com frequência',
            'Encontrei uma opção melhor/mais barata',
            'Qualidade do serviço/atendimento',
            'Outro'
        ];

        const reasonsHtml = cancelReasons.map(reason => {
            const isSelected = reason === currentReason;
            return `
            <div class="selection-item p-4 rounded-lg cursor-pointer hover:border-primary flex justify-between items-center ${isSelected ? 'border-primary border-2' : ''}" onclick="selectCancelReason('${reason}')">
                <span class="text-white">${reason}</span>
                ${isSelected ? '<i class="fas fa-check text-primary"></i>' : ''}
            </div>
        `}).join('');

        const modalHtml = `
            <div class="info-card p-6">
                <h2 class="text-xl font-bold mb-6 text-center modal-title">Qual o motivo do cancelamento?</h2>
                <div class="space-y-3">
                    ${reasonsHtml}
                </div>
                <button class="w-full mt-6 py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showCancelarAssinaturaModal('${currentReason}')">Voltar</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function selectCancelReason(reason) {
        showCancelarAssinaturaModal(reason);
    }

    function handleSubscriptionCancellation() {
        userSubscription.active = false;
        saveState();
        showCancelamentoConfirmadoModal();
    }

    function showCancelamentoConfirmadoModal() {
        const modalHtml = `
             <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Assinatura Cancelada</h2>
                <p class="text-secondary mb-6">Sua assinatura foi cancelada com sucesso. Esperamos ver você novamente em breve!</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="closeModal(); renderView('planos');">Fechar</button>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function showMudarPlanoModal() {
        const currentPlan = userSubscription.plan;
        const otherPlans = planos.filter(p => p.title !== currentPlan.title);

        const currentPlanHtml = `
            <div class="plan-card popular mb-6">
                 <div class="bg-[#fbb62c] text-black text-center py-1 font-bold text-sm">SEU PLANO ATUAL</div>
                 <div class="p-6">
                     <h3 class="text-xl font-bold mb-2 text-white">${currentPlan.title}</h3>
                     <div class="flex items-baseline mb-6">
                         <span class="text-4xl font-bold text-primary">R$${currentPlan.price}</span>
                         <span class="text-gray-400 ml-1">${currentPlan.period}</span>
                     </div>
                     <ul class="space-y-3 text-secondary text-sm">
                         ${currentPlan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-primary mr-3 mt-1"></i><span>${f}</span></li>`).join('')}
                     </ul>
                 </div>
            </div>
        `;

        const otherPlansHtml = otherPlans.map(plan => `
            <div class="plan-card rounded-xl overflow-hidden flex flex-col">
                 <div class="p-6 flex flex-col flex-grow">
                     <h3 class="text-xl font-bold mb-2 text-white">${plan.title}</h3>
                     <div class="flex items-baseline mb-6">
                         <span class="text-4xl font-bold text-primary">R$${plan.price}</span>
                         <span class="text-gray-400 ml-1">${plan.period}</span>
                     </div>
                     <ul class="space-y-3 mb-8 flex-grow text-secondary text-sm">
                         ${plan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-primary mr-3 mt-1"></i><span>${f}</span></li>`).join('')}
                     </ul>
                     <button class="btn-plan mt-auto" onclick="confirmarMudancaPlano('${plan.title}')">Mudar para este plano</button>
                 </div>
            </div>
        `).join('');

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px; max-height: 90vh;">
                 <h2 class="text-2xl font-bold text-center mb-4 modal-title">Mudar de Plano</h2>
                
                 <div class="flex-grow overflow-y-auto pr-2 modal-scroll-hidden">
                    ${currentPlanHtml}
                    <h3 class="text-lg font-semibold text-center my-4">Outros Planos</h3>
                    <div class="space-y-4">
                        ${otherPlansHtml}
                    </div>
                 </div>

                 <div class="mt-auto pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showGerenciarAssinaturaModal()">Continuar com o plano atual</button>
                 </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none p-0', 'center');
    }

    function confirmarMudancaPlano(newPlanTitle) {
        const currentPlan = userSubscription.plan;
        const newPlan = planos.find(p => p.title === newPlanTitle);
        const currentPrice = parseFloat(currentPlan.price.replace(',', '.'));
        const newPrice = parseFloat(newPlan.price.replace(',', '.'));

        let confirmationMessage = '';
        if (newPrice > currentPrice) {
            // Upgrade
            confirmationMessage = `Você gostaria de iniciar seu novo plano agora? A diferença de valor será cobrada hoje.`;
        } else {
            // Downgrade
            confirmationMessage = `Sua mudança para o novo plano será efetivada na próxima renovação, em ${userSubscription.nextBillingDate}.`;
        }

        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-exchange-alt text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Confirmar Mudança</h2>
                <p class="text-secondary mb-2">Você está mudando do plano <strong>${currentPlan.title}</strong> para <strong>${newPlan.title}</strong>.</p>
                <p class="text-secondary mb-6">${confirmationMessage}</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showMudarPlanoModal()">Voltar</button>
                    <button class="w-full py-2 font-semibold rounded-lg btn-plan" onclick="handlePlanChange('${newPlanTitle}')">Confirmar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }
    
    function handlePlanChange(newPlanTitle) {
        const newPlan = planos.find(p => p.title === newPlanTitle);
        userSubscription.plan = newPlan;
        saveState();

        const successHtml = `
             <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Plano Alterado!</h2>
                <p class="text-secondary mb-6">Seu plano foi alterado para <strong>${newPlan.title}</strong> com sucesso.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="closeModal(); renderView('planos');">Fechar</button>
            </div>
        `;
        modalContent.innerHTML = successHtml;
    }


    function showPausarAssinaturaModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-pause-circle text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Pausar Assinatura</h2>
                <p class="text-secondary mb-6">Funcionalidade em desenvolvimento.</p>
                 <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="showGerenciarAssinaturaModal()">Voltar</button>
            </div>
        `;
         openModal(modalHtml, 'border-none', 'center');
    }

    // --- MODAIS DE PAGAMENTO ---
    function showAlterarPagamentoModal(onCloseCallback) {
        const primaryMethod = paymentMethods.find(p => p.primary);
        const otherMethods = paymentMethods.filter(p => !p.primary);

        const getBrandIcon = (brand) => {
            if (brand === 'visa') return '<i class="fab fa-cc-visa text-3xl text-blue-400"></i>';
            if (brand === 'mastercard') return '<i class="fab fa-cc-mastercard text-3xl text-red-500"></i>';
            return '<i class="fas fa-credit-card text-3xl text-gray-400"></i>';
        }

        let primaryMethodHtml = `
            <div class="bg-[#2a2a2a] p-4 rounded-lg">
                <h3 class="font-semibold text-sm text-gray-300 mb-3">Pagamento Principal</h3>
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        ${getBrandIcon(primaryMethod.brand)}
                        <div class="ml-4">
                            <p class="text-sm font-bold text-white">Cartão final ${primaryMethod.last4}</p>
                            <p class="text-xs text-secondary">Crédito</p>
                        </div>
                    </div>
                    <span class="bg-green-500/20 text-green-400 text-xs font-semibold px-2 py-0.5 rounded-full">Principal</span>
                </div>
            </div>
        `;

        let otherMethodsHtml = otherMethods.map(p => `
            <div class="flex justify-between items-center p-3 bg-[#2a2a2a] rounded-lg">
                <div class="flex items-center">
                    ${getBrandIcon(p.brand)}
                    <div class="ml-4">
                        <p class="text-sm font-bold text-white">Cartão final ${p.last4}</p>
                        <p class="text-xs text-secondary">Crédito</p>
                    </div>
                </div>
                <button class="text-xs text-primary font-semibold" onclick="showTornarPrincipalConfirmacaoModal(${p.id})">Tornar Principal</button>
            </div>
        `).join('');
        
        const closeAction = onCloseCallback ? `(${onCloseCallback.toString()})()` : 'closeModal()';

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Formas de Pagamento</h2>
                
                <div class="space-y-4 flex-grow">
                    ${primaryMethodHtml}
                    ${otherMethods.length > 0 ? `<h3 class="font-semibold text-sm text-gray-300 pt-4">Outros métodos</h3>` : ''}
                    ${otherMethodsHtml}
                </div>

                <div class="mt-auto pt-6">
                     <div class="space-y-3">
                        <button class="w-full py-3 font-semibold rounded-lg bg-[#2a2a2a] flex items-center justify-center" onclick="showAdicionarCartaoForm(${onCloseCallback})">
                            <i class="fas fa-credit-card mr-3"></i> Adicionar Novo Cartão
                        </button>
                        <button class="w-full py-3 font-semibold rounded-lg bg-[#2a2a2a] flex items-center justify-center" onclick="showAdicionarPixForm()">
                            <i class="fab fa-pix mr-3"></i> Adicionar Chave Pix
                        </button>
                     </div>
                     <div class="border-t border-gray-700 my-4"></div>
                     <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="${closeAction}">Voltar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function showAdicionarCartaoForm(onSuccessCallback) {
        const backAction = onSuccessCallback ? `(${onSuccessCallback.toString()})()` : 'showAlterarPagamentoModal()';

        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col auth-form" style="min-height: 550px;">
                <h2 class="text-2xl font-bold text-center mb-6 modal-title">Adicionar Cartão</h2>
                
                <div class="space-y-4 flex-grow">
                    <div>
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Número do Cartão</label>
                        <input id="card-number" type="tel" placeholder="0000 0000 0000 0000" class="w-full p-3 rounded-lg" oninput="validateCardForm()">
                    </div>
                     <div>
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Nome do Titular</label>
                        <input id="card-holder" type="text" placeholder="Nome como no cartão" class="w-full p-3 rounded-lg" oninput="this.value = this.value.toUpperCase(); validateCardForm();">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-400 mb-1 block">CPF do Titular</label>
                        <input id="card-cpf" type="tel" placeholder="000.000.000-00" class="w-full p-3 rounded-lg" oninput="validateCardForm()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-400 mb-1 block">Validade</label>
                            <input id="card-expiry" type="tel" placeholder="MM/AA" class="w-full p-3 rounded-lg" oninput="validateCardForm()">
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-400 mb-1 block">CVV</label>
                            <input id="card-cvv" type="tel" placeholder="123" class="w-full p-3 rounded-lg" oninput="this.value = this.value.replace(/\\D/g, ''); validateCardForm();" maxlength="4">
                        </div>
                    </div>
                </div>

                <div class="mt-auto grid grid-cols-2 gap-4 pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="${backAction}">Voltar</button>
                    <button id="save-card-btn" class="w-full py-3 font-semibold rounded-lg btn-plan opacity-50" disabled>Salvar Cartão</button>
                </div>
            </div>
        `;
        modalContent.innerHTML = modalHtml;
        document.getElementById('save-card-btn').onclick = () => handleCardSave(onSuccessCallback);
        setupCardInputMasks();
        validateCardForm();
    }
    
    function handleCardSave(onSuccessCallback) {
        const newCard = {
            id: Date.now(),
            type: 'card',
            last4: document.getElementById('card-number').value.slice(-4),
            brand: 'visa',
            primary: false
        };
        paymentMethods.push(newCard);
        saveState();
        showCartaoSalvoModal(onSuccessCallback);
    }


    function setupCardInputMasks() {
        document.getElementById('card-number').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').substring(0, 16);
            e.target.value = value.replace(/(\d{4})/g, '$1 ').trim();
        });

        document.getElementById('card-expiry').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').substring(0, 4);
            if (value.length > 2) {
                e.target.value = `${value.substring(0, 2)}/${value.substring(2)}`;
            } else {
                e.target.value = value;
            }
        });
        
        document.getElementById('card-cpf').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').substring(0, 11);
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });
    }

    function validateCardForm() {
        const cardNumber = document.getElementById('card-number').value.replace(/\D/g, '');
        const cardHolder = document.getElementById('card-holder').value.trim();
        const cardCpf = document.getElementById('card-cpf').value.replace(/\D/g, '');
        const cardExpiry = document.getElementById('card-expiry').value.replace(/\D/g, '');
        const cardCvv = document.getElementById('card-cvv').value.replace(/\D/g, '');
        const saveBtn = document.getElementById('save-card-btn');

        const isCardNumberValid = cardNumber.length === 16;
        const isCardHolderValid = cardHolder.length > 2 && cardHolder.includes(' ');
        const isCpfValid = cardCpf.length === 11;
        const isExpiryValid = cardExpiry.length === 4;
        const isCvvValid = cardCvv.length >= 3 && cardCvv.length <= 4;

        if (isCardNumberValid && isCardHolderValid && isCpfValid && isExpiryValid && isCvvValid) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-50');
        } else {
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50');
        }
    }


    function showCartaoSalvoModal(onCloseCallback) {
        const closeAction = onCloseCallback ? `(${onCloseCallback.toString()})()` : 'showAlterarPagamentoModal()';
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-credit-card text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Cartão Salvo!</h2>
                <p class="text-secondary mb-6">Seu novo cartão foi adicionado com sucesso e já pode ser usado.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="${closeAction}">Fechar</button>
            </div>
        `;
        modalContent.innerHTML = modalHtml;
    }

    function showAdicionarPixForm() {
        const modalHtml = `
            <div class="p-6 text-white relative bg-[#1e1e1e] rounded-2xl flex flex-col text-center" style="min-height: 550px;">
                <button class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-white" onclick="showAlterarPagamentoModal()">&times;</button>
                <div class="flex-grow flex flex-col justify-center items-center">
                    <i class="fab fa-pix text-6xl text-primary mb-6"></i>
                    <h2 class="text-2xl font-bold mb-4 modal-title">Adicionar Pix</h2>
                    <p class="text-secondary mb-8">Sua cobrança será gerada via Pix na data de vencimento e você será notificado para realizar o pagamento.</p>
                </div>
                <div class="mt-auto grid grid-cols-2 gap-4 pt-6">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showAlterarPagamentoModal()">Voltar</button>
                    <button class="w-full py-3 font-semibold rounded-lg btn-plan" onclick="handlePixConfirmation()">Confirmar</button>
                </div>
            </div>
        `;
        modalContent.innerHTML = modalHtml;
    }


    function showTermosModal() {
        const termosHtml = `
            <div class="bg-white text-black rounded-lg p-6 max-h-[70vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 text-center text-black">Termos e Serviços</h2>
                <div class="space-y-4 text-sm text-left">
                    <div>
                        <h3 class="font-bold">1. OBJETIVO</h3>
                        <p>Estabelecer as regras para o fornecimento de serviços de barbearia, promoções e conteúdo da VS Barbearia (vsbarbearia.com.br) através de assinatura.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">2. DEFINIÇÕES PRINCIPAIS</h3>
                        <p><strong>Assinatura:</strong> Pagamento mensal do assinante pelos serviços contratados.</p>
                        <p><strong>Produtos:</strong> Cosméticos (pomadas, cremes, óleos) fornecidos em kits, quando disponíveis.</p>
                        <p><strong>Cupons de Desconto:</strong> Oferecidos por parceiros para compra de produtos/serviços com desconto.</p>
                        <p><strong>Serviços:</strong> Conteúdo, consultoria e promoções oferecidas periodicamente ao assinante.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">3. ADESÃO E ACEITAÇÃO</h3>
                        <p>Ao pagar pela assinatura, o assinante aceita os termos de uso e a Política de Privacidade.</p>
                        <p>Pagamento realizado via cartão de crédito, boleto ou Pix, com renovação mensal automática.</p>
                        <p>A VS Barbearia pode alterar os termos, sendo responsabilidade do assinante revisar periodicamente as mudanças.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">4. PREÇO E CONDIÇÕES DE PAGAMENTO</h3>
                        <p><strong>Pagamento Mensal:</strong> Assinatura paga com cartão de crédito (sem comprometer o limite), boleto ou Pix.</p>
                        <p><strong>Reajustes Trimestrais:</strong> Aviso prévio de 30 dias será enviado em caso de alteração no valor.</p>
                        <p><strong>Compras Únicas:</strong> Produtos ou serviços adicionais podem ser cobrados com autorização prévia via e-mail.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">5. CANCELAMENTO E PAUSA DA ASSINATURA</h3>
                        <p><strong>Cancelamento Gratuito em até 7 Dias:</strong> Possibilidade de cancelamento com reembolso, caso nenhum serviço tenha sido utilizado.</p>
                        <p><strong>Pausa de 30 Dias:</strong> O assinante pode pausar a assinatura por motivos de viagem ou férias, sem custos.</p>
                        <p><strong>Cancelamento Definitivo:</strong> Não haverá reembolso após o uso dos serviços ou se cancelado fora do prazo de arrependimento.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">6. OBRIGAÇÕES</h3>
                        <p class="font-semibold">VS BARBEARIA:</p>
                        <ul class="list-disc list-inside pl-4">
                            <li>Prestar serviços com qualidade e em conformidade com a lei.</li>
                            <li>Garantir a proteção dos dados pessoais do assinante, conforme a Política de Privacidade.</li>
                        </ul>
                        <p class="font-semibold mt-2">ASSINANTE:</p>
                         <ul class="list-disc list-inside pl-4">
                            <li>Caso a mensalidade esteja em inadimplência, o assinante não poderá utilizar nenhum serviço como membro do clube.</li>
                            <li>O assinante inadimplente poderá pagar o serviço de forma avulsa, com o desconto aplicável, ou regularizar a assinatura no momento do atendimento para usufruir dos benefícios.</li>
                            <li>Manter os dados de cadastro atualizados e realizar os pagamentos em dia.</li>
                            <li>O não pagamento resultará na suspensão imediata dos serviços.</li>
                         </ul>
                    </div>
                    <div>
                        <h3 class="font-bold">7. ATENDIMENTO AO ASSINANTE</h3>
                        <p>Disponível de terça a sábado, das 9h às 19h, via celular/WhatsApp:  (37) 9 9671-9604.</p>
                        <p>Além disso, o aplicativo de agendamento, Frizzar, também oferece suporte ao cliente para facilitar o agendamento de serviços.</p>
                    </div>
                    <div>
                        <h3 class="font-bold">8. LIMITAÇÕES DOS SERVIÇOS</h3>
                        <p>É proibida a transferência de serviços para terceiros.</p>
                        <p>Não é permitido realizar um novo agendamento sem antes de utilizar o que já está agendado.</p>
                        <p>Plano de assinatura 1 ou Plano de entrada é o único que não é ilimitado. Para os demais planos, você pode cortar o cabelo e fazer a barba quando quiser, seja diariamente, semanalmente ou quinzenalmente. O uso depende do plano escolhido.</p>
                        <p class="font-semibold mt-2">Limitações em caso de ausência:</p>
                        <ul class="list-disc list-inside pl-4">
                            <li>Se o assinante agendar o serviço e não comparecer, perderá o direito ao corte da semana correspondente, sendo necessário pagar o valor do corte avulso caso deseje realizar o serviço na mesma semana.</li>
                            <li>Para clientes avulsos, a ausência sem aviso prévio implicará na cobrança integral do serviço agendado no próximo atendimento.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold">9. DISPOSIÇÕES FINAIS</h3>
                        <p><strong>Foro Jurídico:</strong> As questões legais serão tratadas no foro da cidade de Nova Serrana - MG.</p>
                        <p><strong>Política de Dados:</strong> A VS Barbearia pode compartilhar informações do assinante com autoridades competentes.</p>
                    </div>
                </div>
                <button class="w-full mt-6 py-2 bg-black text-white font-bold rounded-lg" onclick="closeModal()">Fechar</button>
            </div>
        `;
        openModal(termosHtml, 'bg-transparent border-none p-0', 'center');
    }

    function showFaleConoscoModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fab fa-whatsapp text-5xl text-green-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Fale Conosco</h2>
                <p class="text-secondary mb-6">Deseja abrir uma conversa no WhatsApp para tirar suas dúvidas?</p>
                <div class="flex justify-center space-x-4">
                    <button class="py-2 px-8 font-bold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Voltar</button>
                    <a href="https://wa.me/5537996719604" target="_blank" class="py-2 px-8 font-bold rounded-lg bg-green-600 hover:bg-green-700 text-white flex items-center"><i class="fab fa-whatsapp mr-2"></i>WhatsApp</a>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    // --- Funções de inicialização e verificação ---
    function checkAppointments() {
        const now = new Date();
        const expiredAppointments = [];
        const openAppointments = [];

        agendamentos.abertos.forEach(ag => {
            if (new Date(ag.data) < now) {
                expiredAppointments.push(ag);
            } else {
                openAppointments.push(ag);
            }
        });

        if (expiredAppointments.length > 0) {
            agendamentos.abertos = openAppointments;
            agendamentos.historico.unshift(...expiredAppointments);
            saveState();

            const firstToReview = expiredAppointments.find(ag => ag.avaliacao === null);
            if (userLoggedIn && firstToReview) {
                setTimeout(() => showAvaliacaoModal(firstToReview.id), 1000);
            }
        }
    }

    function updateReviewNotification() {
        const notificationDot = document.getElementById('review-notification-dot');
        if (!notificationDot) return;

        const needsReview = agendamentos.historico.some(ag => ag.avaliacao === null);
        if (needsReview) {
            notificationDot.classList.remove('hidden');
        } else {
            notificationDot.classList.add('hidden');
        }
    }

    // --- NOVOS MODAIS ADICIONADOS E ATUALIZADOS ---

    function showTrocarFotoModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <h2 class="text-xl font-bold mb-8 modal-title">Alterar Foto de Perfil</h2>
                <div class="space-y-4">
                    <button id="choose-gallery-btn" class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center hover:bg-[#333] transition-colors">
                        <i class="fas fa-image w-6 text-center mr-4 text-primary"></i>
                        <span class="text-white">Escolher da galeria</span>
                    </button>
                    <button id="remove-photo-btn" class="w-full text-left p-4 rounded-lg bg-[#222] flex items-center hover:bg-[#333] transition-colors">
                        <i class="fas fa-trash-alt w-6 text-center mr-4 text-red-500"></i>
                        <span class="text-red-500">Remover foto</span>
                    </button>
                </div>
                <div class="mt-8">
                    <button class="w-full py-3 font-semibold rounded-lg btn-dark border border-gray-600" onclick="closeModal()">Cancelar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');

        document.getElementById('choose-gallery-btn').onclick = () => {
            profilePicInput.click();
        };
        document.getElementById('remove-photo-btn').onclick = () => {
            const initials = userInfo.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            userInfo.profilePic = `https://placehold.co/100x100/333333/FFFFFF?text=${initials}`;
            saveState();
            updateProfilePics();
            closeModal();
        };
    }
    
    profilePicInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                userInfo.profilePic = e.target.result;
                saveState();
                updateProfilePics();
                closeModal();
            };
            reader.readAsDataURL(file);
        }
    });

    function showTornarPrincipalConfirmacaoModal(methodId) {
        const method = paymentMethods.find(p => p.id === methodId);
        if (!method) return;

        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fas fa-credit-card text-4xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Tornar Principal</h2>
                <p class="text-secondary mb-6">Deseja definir o cartão com final <strong class="text-white">${method.last4}</strong> como sua forma de pagamento principal?</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="w-full py-2 font-semibold rounded-lg btn-dark border border-gray-600" onclick="showAlterarPagamentoModal()">Cancelar</button>
                    <button class="w-full py-2 font-semibold rounded-lg btn-plan" onclick="handleTornarPrincipal(${methodId})">Confirmar</button>
                </div>
            </div>
        `;
        openModal(modalHtml, 'border-none', 'center');
    }

    function handleTornarPrincipal(methodId) {
        paymentMethods.forEach(p => p.primary = false);
        const newPrimary = paymentMethods.find(p => p.id === methodId);
        if (newPrimary) {
            newPrimary.primary = true;
        }
        saveState();
        showTornarPrincipalSuccessModal();
    }

    function showTornarPrincipalSuccessModal() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="far fa-check-circle text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Alterado com Sucesso!</h2>
                <p class="text-secondary mb-6">Sua forma de pagamento principal foi atualizada.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="showAlterarPagamentoModal()">Fechar</button>
            </div>
        `;
        modalContent.innerHTML = modalHtml;
    }

    function handlePixConfirmation() {
        const modalHtml = `
            <div class="info-card text-center p-6">
                <i class="fab fa-pix text-5xl text-primary mb-4"></i>
                <h2 class="text-xl font-bold mb-4 modal-title">Pix Habilitado!</h2>
                <p class="text-secondary mb-6">O Pix foi adicionado com sucesso e poderá ser usado nas suas próximas cobranças.</p>
                <button class="w-full py-2 font-semibold rounded-lg btn-primary" onclick="showAlterarPagamentoModal()">Entendido</button>
            </div>
        `;
        openModal(modalHtml, 'bg-transparent border-none', 'center');
    }

    function checkSubscriptionRenewal() {
        if (userSubscription.active && userSubscription.nextBillingDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const parts = userSubscription.nextBillingDate.split('/');
            const nextBillingDate = new Date(parts[2], parts[1] - 1, parts[0]);

            if (today >= nextBillingDate) {
                userSubscription.usedServices = 0;
                const newNextBilling = new Date(nextBillingDate);
                newNextBilling.setMonth(newNextBilling.getMonth() + 1);
                userSubscription.nextBillingDate = newNextBilling.toLocaleDateString('pt-BR');
                saveState();
            }
        }
    }

    function initializeApp() {
        checkSubscriptionRenewal();
        checkAppointments();
        updateReviewNotification();
        const activeView = document.querySelector('.footer-nav-item.active')?.dataset.view || 'agendar';
        renderView(activeView);
    }


      // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        document.querySelectorAll('.footer-nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                renderView(item.dataset.view);
            });
        });
        
        // Lógica da tela de carregamento OTIMIZADA
        const loadingScreen = document.getElementById('loading-screen');
        
        // Lista de assets para pré-carregar
        const assetsToPreload = [
            'https://files.catbox.moe/fzxnia.mp4', // Vídeo de fundo
            'https://i.postimg.cc/5yBSjg1F/Bigode-3.png', // Logo principal
            ...unidades.map(u => u.img), // Imagens das unidades
            ...barbeiros.filter(b => b.img).map(b => b.img) // Imagens dos barbeiros
        ];

        // Função para pré-carregar os assets
        function preloadAssets(urls) {
            const promises = urls.map(url => {
                return new Promise((resolve) => {
                    if (!url) return resolve();
                    
                    const extension = url.split('.').pop().toLowerCase();
                    if (['mp4', 'webm'].includes(extension)) {
                        const video = document.createElement('video');
                        video.src = url;
                        video.oncanplaythrough = resolve;
                        video.onerror = () => {
                            console.warn(`Não foi possível pré-carregar o vídeo: ${url}`);
                            resolve(); // Resolve mesmo em caso de erro para não travar o app
                        };
                    } else {
                        const img = new Image();
                        img.src = url;
                        img.onload = resolve;
                        img.onerror = () => {
                            console.warn(`Não foi possível pré-carregar a imagem: ${url}`);
                            resolve(); // Resolve mesmo em caso de erro
                        };
                    }
                });
            });
            return Promise.all(promises);
        }

        const minTimePromise = new Promise(resolve => setTimeout(resolve, 2000));
        const loadAssetsPromise = preloadAssets(assetsToPreload);

        Promise.all([minTimePromise, loadAssetsPromise]).then(() => {
            loadingScreen.classList.add('fade-out');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                initializeApp(); // <--- [NOVO] Chamada da função de inicialização
            }, 500); // Corresponde à duração da animação de fade-out
        });
    });

</script>
</body>
</html>
















