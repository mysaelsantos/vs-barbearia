<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - VS Barbearia</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Interact.js for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #111111;
            color: #e0e0e0;
        }
        .hidden { display: none; }
        
        /* Estilo das Abas */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            padding-bottom: 8px;
        }
        .tab-button.active {
            border-bottom-color: #fbb62c;
            color: #fbb62c;
        }
        
        /* Estilos dos Formulários */
        .form-input, .form-textarea, .form-select {
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #fbb62c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 182, 44, 0.5);
        }
        
        /* Estilos dos Botões */
        .btn-primary {
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #e0a828;
        }
        .btn-primary:disabled {
            background-color: #4a4a4a;
            color: #888;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #333;
            border: 1px solid #555;
            color: #f0f0f0;
            font-weight: 600;
             border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #444;
        }

        /* Estilos do Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #1e1e1e;
            border-top: 2px solid #fbb62c;
        }

        /* Animação de Spinner/Loader */
        .loader {
            border: 3px solid #444;
            border-top: 3px solid #fbb62c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ESTILOS DA AGENDA --- */
        #agenda-container {
            overflow-x: auto;
        }
        .agenda-grid {
            display: flex;
            min-width: 800px;
        }
        .time-column {
            flex: 0 0 70px;
        }
        .professional-column {
            flex: 1 1 0px;
            border-left: 1px solid #444;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .professional-column.drop-active {
            background-color: rgba(251, 182, 44, 0.05);
        }
        .professional-column.drop-target {
            background-color: rgba(251, 182, 44, 0.15);
            border-left-color: #fbb62c;
        }
        .time-slot, .professional-header {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #aaa;
        }
        .professional-header {
            font-weight: 600;
            color: #fff;
            border-bottom: 1px solid #444;
        }
        .time-slot-line {
            height: 40px;
            border-bottom: 1px solid #333;
            box-sizing: border-box;
        }
        .appointment-card {
            position: absolute;
            left: 5px;
            right: 5px;
            background-color: #005c99; /* Agendado */
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            color: white;
            overflow: hidden;
            box-sizing: border-box;
            border-left: 3px solid #00bfff;
            z-index: 10;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, opacity 0.2s;
        }
        .appointment-card:hover {
            opacity: 0.9;
        }
        .appointment-card.dragging {
            opacity: 0.6;
            z-index: 20;
        }

        /* Cores por Status */
        .appointment-card.status-confirmado {
            background-color: #166534; /* green-800 */
            border-left-color: #22c55e; /* green-500 */
        }
        .appointment-card.status-finalizado {
            background-color: #4b5563; /* gray-600 */
            border-left-color: #9ca3af; /* gray-400 */
        }
        .appointment-card.status-cancelado {
            background-color: #991b1b; /* red-800 */
            border-left-color: #ef4444; /* red-500 */
        }

        .appointment-card.status-bloqueio {
            background-color: #374151; /* gray-700 */
            border-left-color: #9ca3af; /* gray-400 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .appointment-card.motivo-almoco {
            background-color: #b45309; /* amber-700 */
            border-left-color: #f59e0b; /* amber-500 */
        }
        .appointment-card.motivo-reuniao {
            background-color: #6d28d9; /* violet-700 */
            border-left-color: #8b5cf6; /* violet-500 */
        }

        .appointment-card p {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- ESTILOS PARA O MENU LATERAL --- */
        #main-container {
            position: relative;
            flex-grow: 1; 
            overflow: hidden;
        }
        #sidebar {
            width: 250px; 
            background-color: #1e1e1e;
            transition: transform 0.3s ease;
            overflow-x: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: absolute;
            z-index: 50;
        }
        #sidebar.collapsed {
            transform: translateX(calc(-100% + 70px));
        }
        #sidebar .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #a0aec0;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
        }
         #sidebar .nav-link:hover {
            background-color: rgba(251, 182, 44, 0.1);
            color: #fbb62c;
        }
        #sidebar .nav-link.active {
            color: #fbb62c;
            font-weight: 600;
        }
        #sidebar .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            width: 4px;
            background-color: #fbb62c;
            border-radius: 0 4px 4px 0;
        }
        #sidebar .nav-link .nav-text {
            margin-left: 15px;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        #sidebar.collapsed .nav-link .nav-text {
            opacity: 0;
            pointer-events: none;
        }
        #sidebar .submenu {
            padding-left: 40px;
            background-color: rgba(0,0,0,0.2);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        #sidebar .submenu.open {
            max-height: 500px;
        }
        #sidebar .submenu .nav-link {
            padding-left: 25px;
        }
        #sidebar .nav-icon {
            width: 25px;
            text-align: center;
        }
        #main-content {
            overflow-y: auto;
            height: 100%;
            padding-left: 70px;
        }
        
        /* NOVO: Estilos para as notificações (Toasts) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #2a2a2a;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border-left: 4px solid #fbb62c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards;
        }
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .toast.success { border-left-color: #22c55e; } /* green-500 */
        .toast.error { border-left-color: #ef4444; } /* red-500 */
        .toast.info { border-left-color: #3b82f6; } /* blue-500 */

    </style>
</head>
<body class="h-full bg-[#111111]">

    <!-- Seção de Login e Cadastro (Visível quando deslogado) -->
    <div id="auth-section" class="flex min-h-full flex-col justify-center px-6 py-12 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-sm text-center">
            <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-20 h-20 mx-auto mb-4">
            <h2 class="text-2xl font-bold leading-9 tracking-tight text-white">Acesse seu painel</h2>
        </div>
        <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
            <div class="space-y-6">
                <input id="email" name="email" type="email" autocomplete="email" required placeholder="E-mail" class="block w-full form-input">
                <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="Senha" class="block w-full form-input">
                <p id="auth-error" class="text-center text-sm text-red-500"></p>
                <button id="login-button" class="w-full justify-center btn-primary">Entrar</button>
                <button id="signup-button" class="w-full justify-center btn-secondary">Não tenho conta, Cadastrar</button>
            </div>
        </div>
    </div>

    <!-- Painel Principal (Visível quando logado) -->
    <div id="panel-section" class="hidden flex flex-col h-screen">
        <!-- NOVO: Cabeçalho Global -->
        <header class="bg-[#1e1e1e] shadow-lg z-40 border-b border-gray-800">
            <div class="mx-auto max-w-full px-4 py-3 sm:px-6 lg:px-8 flex justify-between items-center">
                 <div class="flex items-center space-x-4">
                    <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-8 h-8">
                    <h1 id="main-header-title" class="text-xl font-semibold tracking-tight text-white">Painel de Gestão</h1>
                </div>
                <div class="flex items-center">
                    <span id="user-email" class="text-sm text-gray-400 mr-4 hidden sm:block"></span>
                    <button id="logout-button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Sair</button>
                </div>
            </div>
        </header>

        <div id="main-container">
            <!-- NOVO: Menu Lateral -->
            <aside id="sidebar">
                <nav class="flex-grow py-4">
                    <ul>
                        <li><a href="#" class="nav-link" data-target="content-dashboard"><i class="fas fa-home nav-icon"></i><span class="nav-text">Visão Geral</span></a></li>
                        <li>
                            <a href="#" class="nav-link has-submenu" data-target="content-agenda"><i class="fas fa-calendar-alt nav-icon"></i><span class="nav-text">Agenda</span></a>
                            <ul class="submenu">
                                <li><a href="#" class="nav-link" data-target="content-agenda">Agenda Diária</a></li>
                                <li><a href="#" class="nav-link" data-target="content-caixa">Frente de Caixa</a></li>
                                <li><a href="#" class="nav-link" data-target="content-relatorios">Relatórios</a></li>
                            </ul>
                        </li>
                         <li>
                            <a href="#" class="nav-link has-submenu"><i class="fas fa-archive nav-icon"></i><span class="nav-text">Cadastros</span></a>
                            <ul class="submenu">
                                <li><a href="#" class="nav-link" data-target="content-servicos">Serviços</a></li>
                                <li><a href="#" class="nav-link" data-target="content-profissionais">Profissionais</a></li>
                                <li><a href="#" class="nav-link" data-target="content-unidades">Unidades</a></li>
                                <li><a href="#" class="nav-link" data-target="content-clientes">Clientes</a></li>
                                <li><a href="#" class="nav-link" data-target="content-planos">Planos</a></li>
                            </ul>
                        </li>
                        <li><a href="#" class="nav-link" data-target="content-metas"><i class="fas fa-bullseye nav-icon"></i><span class="nav-text">Metas & Fidelidade</span></a></li>
                        <li><a href="#" class="nav-link" data-target="content-configuracoes"><i class="fas fa-cog nav-icon"></i><span class="nav-text">Configurações</span></a></li>
                    </ul>
                </nav>
            </aside>

            <!-- Conteúdo Principal -->
            <div id="main-content">
                
                <main class="flex-1 overflow-y-auto bg-[#1e1e1e] text-white">
                    <div class="min-h-full">
                        
                        <!-- Conteúdo da Visão Geral -->
                        <div id="content-dashboard" class="p-6">
                            <h2 class="text-2xl font-bold mb-6 text-gray-300">Resumo de Hoje</h2>
                            <!-- Container dos Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

                                <!-- Card: Faturação do Dia -->
                                <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg flex items-center space-x-4">
                                    <div class="bg-green-500/20 p-3 rounded-full">
                                        <i class="fas fa-dollar-sign fa-lg text-green-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-400">Faturação do Dia</p>
                                        <p id="kpi-faturacao" class="text-2xl font-bold text-gray-100">R$ 0,00</p>
                                    </div>
                                </div>

                                <!-- Card: Agendamentos de Hoje -->
                                <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg flex items-center space-x-4">
                                    <div class="bg-blue-500/20 p-3 rounded-full">
                                        <i class="fas fa-calendar-check fa-lg text-blue-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-400">Agendamentos de Hoje</p>
                                        <p id="kpi-agendamentos" class="text-2xl font-bold text-gray-100">0</p>
                                    </div>
                                </div>

                                <!-- Card: Clientes Atendidos -->
                                <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg flex items-center space-x-4">
                                    <div class="bg-indigo-500/20 p-3 rounded-full">
                                        <i class="fas fa-users fa-lg text-indigo-400"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-400">Clientes Atendidos</o>
                                        <p id="kpi-clientes" class="text-2xl font-bold text-gray-100">0</p>
                                    </div>
                                </div>

                            </div>

                            <!-- ATUALIZADO: Layout de duas colunas para as listas -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                                <!-- Coluna Próximos Agendamentos -->
                                <div>
                                    <h3 class="text-xl font-bold mb-4 text-gray-300">Próximos Agendamentos do Dia</h3>
                                    <div id="proximos-agendamentos-list" class="space-y-3">
                                        <div class="bg-[#2a2a2a] p-4 rounded-lg text-center text-gray-500">A carregar...</div>
                                    </div>
                                </div>
                                <!-- NOVO: Coluna Aniversariantes do Dia -->
                                <div>
                                    <h3 class="text-xl font-bold mb-4 text-gray-300">Aniversariantes do Dia</h3>
                                    <div id="aniversariantes-list" class="space-y-3">
                                        <div class="bg-[#2a2a2a] p-4 rounded-lg text-center text-gray-500">A carregar...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba Serviços -->
                        <div id="content-servicos" class="hidden">
                            <h1 class="text-2xl font-bold text-primary mb-6">Gerenciar Serviços</h1>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Novo Serviço</h3>
                                    <form id="add-service-form" class="space-y-4">
                                        <input type="text" id="service-name" required placeholder="Nome do Serviço" class="form-input w-full">
                                        <input type="number" step="0.01" id="service-value" required placeholder="Valor (R$)" class="form-input w-full">
                                        <input type="number" step="0.01" id="service-promo-value" placeholder="Valor Promocional (Opcional)" class="form-input w-full">
                                        <input type="number" id="service-duration" required placeholder="Duração (min)" class="form-input w-full">
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Serviço</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Serviços Cadastrados</h3>
                                    <div id="services-list" class="space-y-4">
                                        <p id="loading-services" class="text-gray-400">A carregar serviços...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo da Aba Profissionais -->
                        <div id="content-profissionais" class="hidden">
                            <h1 class="text-2xl font-bold text-primary mb-6">Gerenciar Profissionais</h1>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Novo Profissional</h3>
                                    <form id="add-professional-form" class="space-y-4">
                                        <input type="text" id="professional-name" required placeholder="Nome do Profissional" class="form-input w-full">
                                        <input type="text" id="professional-function" required placeholder="Função" class="form-input w-full">
                                        <input type="url" id="professional-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                                        <input type="number" id="professional-commission-services" step="1" min="0" max="100" placeholder="Comissão Serviços (%)" class="form-input w-full">
                                        <input type="number" id="professional-commission-products" step="1" min="0" max="100" placeholder="Comissão Produtos (%)" class="form-input w-full">
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Profissional</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Profissionais Cadastrados</h3>
                                    <div id="professionals-list" class="space-y-4">
                                        <p id="loading-professionals" class="text-gray-400">A carregar profissionais...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba Unidades -->
                        <div id="content-unidades" class="hidden">
                            <h1 class="text-2xl font-bold text-primary mb-6">Gerenciar Unidades</h1>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Unidade</h3>
                                    <form id="add-unit-form" class="space-y-4">
                                        <input type="text" id="unit-name" required placeholder="Nome da Unidade" class="form-input w-full">
                                        <input type="text" id="unit-address" required placeholder="Endereço" class="form-input w-full">
                                        <input type="url" id="unit-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                                        <input type="url" id="unit-maps" placeholder="Link do Google Maps (Opcional)" class="form-input w-full">
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Unidade</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Unidades Cadastradas</h3>
                                    <div id="units-list" class="space-y-4">
                                        <p id="loading-units" class="text-gray-400">A carregar unidades...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo da Aba Agenda -->
                        <div id="content-agenda" class="hidden p-6">
                            <div class="bg-[#1e1e1e] rounded-lg border border-gray-800">
                                <!-- Cabeçalho da Agenda -->
                                <div class="p-4 sm:p-6 flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-gray-700">
                                    <h3 id="agenda-title" class="text-lg font-bold text-primary">Agenda</h3>
                                    <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
                                        <select id="professional-filter" class="form-select !p-2">
                                            <option value="all">Todos Profissionais</option>
                                        </select>
                                        <button id="prev-day-btn" class="btn-secondary px-3 py-2"><i class="fas fa-chevron-left"></i></button>
                                        <input type="date" id="date-picker" class="form-input !p-2 text-center">
                                        <button id="next-day-btn" class="btn-secondary px-3 py-2"><i class="fas fa-chevron-right"></i></button>
                                        <button id="add-appointment-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Agendamento</button>
                                    </div>
                                </div>
                                <!-- Container da Grade da Agenda -->
                                <div id="agenda-container" class="p-4">
                                     <div id="loading-agenda" class="text-center p-8">
                                        <div class="loader mx-auto mb-4" style="width: 30px; height: 30px;"></div>
                                        <p class="text-gray-400">A carregar agenda...</p>
                                    </div>
                                    <div id="agenda-grid-view" class="hidden">
                                        <!-- A grade será gerada pelo JavaScript aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo da Aba Clientes -->
                        <div id="content-clientes" class="hidden">
                            <h1 class="text-2xl font-bold text-primary mb-6">Gerenciar Clientes</h1>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Novo Cliente</h3>
                                    <form id="add-client-form" class="space-y-4">
                                        <input type="text" id="client-name" required placeholder="Nome do Cliente" class="form-input w-full">
                                        <input type="tel" id="client-phone" required placeholder="Telefone" class="form-input w-full">
                                        <input type="email" id="client-email" placeholder="E-mail (Opcional)" class="form-input w-full">
                                        <label for="client-birthdate" class="block text-sm font-medium text-gray-300 -mb-3 pt-2">Data de Nascimento (Opcional)</label>
                                        <input type="date" id="client-birthdate" class="form-input w-full">
                                        <!-- NOVO: Campo de Indicação -->
                                        <label for="client-referrer" class="block text-sm font-medium text-gray-300 -mb-3 pt-2">Indicado por (Opcional)</label>
                                        <select id="client-referrer" class="form-select w-full">
                                            <option value="">Ninguém</option>
                                            <!-- Populado via JS -->
                                        </select>
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Cliente</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Clientes Cadastrados</h3>
                                    <div id="clients-list" class="space-y-4">
                                        <p id="loading-clients" class="text-gray-400">A carregar clientes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo da Aba Planos -->
                        <div id="content-planos" class="hidden">
                             <h1 class="text-2xl font-bold text-primary mb-6">Gerenciar Planos</h1>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Novo Plano</h3>
                                    <form id="add-plan-form" class="space-y-4">
                                        <input type="text" id="plan-title" required placeholder="Título do Plano" class="form-input w-full">
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="text" id="plan-price" required placeholder="Preço (ex: 129,90)" class="form-input w-full">
                                            <input type="text" id="plan-period" required placeholder="Período (ex: /mês)" class="form-input w-full">
                                        </div>
                                        <textarea id="plan-features" required placeholder="Características (uma por linha)" rows="4" class="form-textarea w-full"></textarea>
                                        <div class="flex items-center">
                                            <input id="plan-popular" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                                            <label for="plan-popular" class="ml-2 block text-sm text-gray-300">Marcar como "Mais Popular"?</label>
                                        </div>
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Plano</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Planos Cadastrados</h3>
                                    <div id="plans-list" class="space-y-4">
                                        <p id="loading-plans" class="text-gray-400">A carregar planos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- Conteúdo da Aba Metas -->
                        <div id="content-metas" class="hidden">
                             <h1 class="text-2xl font-bold text-primary mb-6">Fidelidade e Metas</h1>
                            
                            <!-- NOVO: Seção do Programa de Indicação -->
                            <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg border border-gray-800 mb-8">
                                <h3 class="text-lg font-bold text-gray-300 mb-4 flex items-center"><i class="fas fa-gift mr-3 text-primary"></i>Programa de Indicação</h3>
                                <form id="referral-settings-form" class="space-y-4">
                                    <p class="text-sm text-gray-400">Defina o valor em créditos que um cliente ganha ao indicar um novo cliente que complete um serviço.</p>
                                    <div>
                                        <label for="referral-credit-value" class="block text-sm font-medium text-gray-300 mb-1">Valor do Crédito por Indicação (R$)</label>
                                        <input type="number" step="0.01" id="referral-credit-value" placeholder="10,00" class="form-input w-full max-w-xs">
                                    </div>
                                    <div class="text-left">
                                        <button type="submit" class="btn-primary">
                                            <span class="btn-text">Salvar Configuração</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Adicionar Nova Meta de Indicação</h3>
                                    <form id="add-goal-form" class="space-y-4">
                                        <input type="number" id="goal-target" required placeholder="Nº de Indicações (ex: 5)" class="form-input w-full">
                                        <input type="text" id="goal-prize" required placeholder="Prêmio (ex: Hidratação Grátis)" class="form-input w-full">
                                        <input type="text" id="goal-icon" required placeholder="Ícone (ex: fas fa-tint)" class="form-input w-full">
                                        <select id="goal-service-id" class="form-select w-full">
                                            <option value="">Prêmio sem serviço vinculado</option>
                                            <!-- Opções de serviços serão populadas aqui -->
                                        </select>
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Salvar Meta</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Metas Cadastradas</h3>
                                    <div id="goals-list" class="space-y-4">
                                        <p id="loading-goals" class="text-gray-400">A carregar metas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- Conteúdo da Aba Configurações -->
                        <div id="content-configuracoes" class="hidden">
                            <h1 class="text-2xl font-bold text-primary mb-6">Configurações</h1>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Seção Minha Conta -->
                                <div class="bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Minha Conta</h3>
                                    <form id="change-password-form" class="space-y-4">
                                        <p class="text-sm text-gray-400">Altere sua senha de acesso ao painel.</p>
                                        <input type="password" id="current-password" required placeholder="Senha Atual" class="form-input w-full">
                                        <input type="password" id="new-password" required placeholder="Nova Senha" class="form-input w-full">
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Alterar Senha</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- Seção Usuários do Painel -->
                                <div class="bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                    <h3 class="text-lg font-bold mb-4">Usuários do Painel</h3>
                                    <form id="add-panel-user-form" class="space-y-4">
                                        <input type="email" id="panel-user-email" required placeholder="Email do novo usuário" class="form-input w-full">
                                        <input type="password" id="panel-user-password" required placeholder="Senha provisória" class="form-input w-full">
                                        <select id="panel-user-role" class="form-select w-full">
                                            <option value="gestor">Gestor</option>
                                            <option value="profissional">Profissional</option>
                                        </select>
                                        <p class="text-xs text-gray-500">O novo usuário deverá alterar esta senha no primeiro acesso.</p>
                                        <button type="submit" class="w-full justify-center btn-primary">
                                            <span class="btn-text">Criar Usuário</span>
                                            <div class="loader hidden"></div>
                                        </button>
                                    </form>
                                    <div class="mt-6 pt-4 border-t border-gray-700">
                                        <h4 class="text-md font-bold mb-4">Usuários Ativos</h4>
                                        <div id="panel-users-list" class="space-y-3">
                                           <p id="loading-panel-users">A carregar...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Seção Configurações da Agenda -->
                                <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                                     <h3 class="text-lg font-bold mb-4">Configurações da Agenda</h3>
                                     <form id="agenda-settings-form" class="space-y-4">
                                         </form>
                                </div>
                            </div>
                        </div>
                         <!-- PÁGINA FRENTE DE CAIXA -->
                        <div id="content-caixa" class="hidden p-6">
                             <h1 class="text-2xl font-bold text-primary mb-4">Frente de Caixa</h1>
                             <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg border border-gray-800">
                                <h3 class="text-lg font-bold text-gray-300 mb-4">Vendas e Comandas do Dia</h3>
                                <!-- Tabela de Comandas -->
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-400">
                                        <thead class="text-xs text-gray-400 uppercase bg-[#333]">
                                            <tr>
                                                <th scope="col" class="px-6 py-3">Cliente</th>
                                                <th scope="col" class="px-6 py-3">Serviço</th>
                                                <th scope="col" class="px-6 py-3">Profissional</th>
                                                <th scope="col" class="px-6 py-3">Valor</th>
                                                <th scope="col" class="px-6 py-3">Status Pagamento</th>
                                                <th scope="col" class="px-6 py-3">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="caixa-list">
                                            <!-- Linhas serão inseridas pelo JavaScript -->
                                            <tr id="loading-caixa">
                                                <td colspan="6" class="text-center p-8">A carregar comandas...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                             </div>
                        </div>
                        <div id="content-relatorios" class="hidden p-6">
                             <h1 class="text-2xl font-bold text-primary mb-6">Relatórios</h1>

                            <!-- Abas de Navegação dos Relatórios -->
                            <div class="border-b border-gray-700 mb-6">
                                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                    <button id="tab-faturamento" class="tab-button active">Faturação</button>
                                    <button id="tab-servicos" class="tab-button text-gray-400 hover:text-gray-200">Serviços</button>
                                    <button id="tab-clientes" class="tab-button text-gray-400 hover:text-gray-200">Clientes</button>
                                </nav>
                            </div>

                            <!-- Conteúdo da Aba Faturamento -->
                            <div id="content-tab-faturamento">
                                <!-- Filtros -->
                                <div class="bg-[#2a2a2a] p-4 rounded-xl shadow-lg border border-gray-800 mb-6 flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <input type="date" id="report-start-date" class="form-input !p-2">
                                        <span class="text-gray-400">até</span>
                                        <input type="date" id="report-end-date" class="form-input !p-2">
                                        <button id="generate-report-btn" class="btn-primary !py-2">Gerar Relatório</button>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button class="btn-secondary !py-2 text-sm" data-range="today">Hoje</button>
                                        <button class="btn-secondary !py-2 text-sm" data-range="this_month">Este Mês</button>
                                        <button class="btn-secondary !py-2 text-sm" data-range="last_month">Mês Passado</button>
                                    </div>
                                </div>

                                <!-- Resultados -->
                                <div id="report-results" class="hidden">
                                    <!-- Cards de Resumo -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                        <!-- Card Faturação Bruta -->
                                        <div class="bg-[#2a2a2a] p-5 rounded-xl">
                                            <p class="text-sm font-medium text-gray-400">Faturação Bruta</p>
                                            <p id="report-total-bruto" class="text-2xl font-bold text-green-400 mt-1">R$ 0,00</p>
                                        </div>
                                        <!-- Card Comissões -->
                                        <div class="bg-[#2a2a2a] p-5 rounded-xl">
                                            <p class="text-sm font-medium text-gray-400">Total Comissões</p>
                                            <p id="report-total-comissao" class="text-2xl font-bold text-red-400 mt-1">R$ 0,00</p>
                                        </div>
                                        <!-- Card Descontos -->
                                        <div class="bg-[#2a2a2a] p-5 rounded-xl">
                                            <p class="text-sm font-medium text-gray-400">Total Descontos</p>
                                            <p id="report-total-desconto" class="text-2xl font-bold text-yellow-400 mt-1">R$ 0,00</p>
                                        </div>
                                        <!-- Card Faturação Líquida -->
                                        <div class="bg-[#2a2a2a] p-5 rounded-xl">
                                            <p class="text-sm font-medium text-gray-400">Faturação Líquida</p>
                                            <p id="report-total-liquido" class="text-2xl font-bold text-primary mt-1">R$ 0,00</p>
                                        </div>
                                    </div>

                                    <!-- Tabela por Profissional -->
                                    <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg border border-gray-800">
                                        <h3 class="text-lg font-bold text-gray-300 mb-4">Desempenho por Profissional</h3>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm text-left text-gray-400">
                                                <thead class="text-xs text-gray-400 uppercase bg-[#333]">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3">Profissional</th>
                                                        <th scope="col" class="px-6 py-3">Serviços Realizados</th>
                                                        <th scope="col" class="px-6 py-3">Faturação Bruta</th>
                                                        <th scope="col" class="px-6 py-3">Comissão Paga</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="report-by-professional-list">
                                                    <!-- Linhas geradas via JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div id="report-placeholder" class="text-center py-16 text-gray-500">
                                    <i class="fas fa-chart-line fa-3x mb-4"></i>
                                    <p>Selecione um período para gerar o relatório.</p>
                                </div>
                            </div>

                             <!-- NOVO: Conteúdo da Aba Serviços -->
                            <div id="content-tab-servicos" class="hidden">
                                <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg border border-gray-800">
                                    <h3 class="text-lg font-bold text-gray-300 mb-4">Ranking de Serviços</h3>
                                     <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-400">
                                            <thead class="text-xs text-gray-400 uppercase bg-[#333]">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">#</th>
                                                    <th scope="col" class="px-6 py-3">Serviço</th>
                                                    <th scope="col" class="px-6 py-3">Nº de Vezes Realizado</th>
                                                    <th scope="col" class="px-6 py-3">Faturação Total (Bruta)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="report-by-service-list">
                                                <!-- Linhas geradas via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                             <!-- NOVO: Conteúdo da Aba Clientes -->
                            <div id="content-tab-clientes" class="hidden">
                                <div class="bg-[#2a2a2a] p-6 rounded-xl shadow-lg border border-gray-800">
                                    <h3 class="text-lg font-bold text-gray-300 mb-4">Ranking de Clientes</h3>
                                     <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-400">
                                            <thead class="text-xs text-gray-400 uppercase bg-[#333]">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">#</th>
                                                    <th scope="col" class="px-6 py-3">Cliente</th>
                                                    <th scope="col" class="px-6 py-3">Nº de Visitas</th>
                                                    <th scope="col" class="px-6 py-3">Gasto Total (Bruto)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="report-by-client-list">
                                                <!-- Linhas geradas via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- NOVO: Container para as Notificações Toast -->
    <div id="toast-container"></div>

    <!-- Modal de Lançamento de Pagamento -->
    <div id="payment-modal" class="hidden fixed inset-0 z-[60] overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-primary">Lançar Pagamento</h3>
                        <p id="payment-subtitle" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="close-payment-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="payment-form" class="space-y-4 text-left">
                    <input type="hidden" id="payment-appointment-id">
                    <input type="hidden" id="payment-client-id">

                    <!-- Resumo da Venda -->
                    <div class="bg-black/20 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Serviço:</span>
                            <span id="payment-summary-service" class="font-semibold text-white"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Valor Original:</span>
                            <span id="payment-summary-value" class="font-semibold text-white"></span>
                        </div>
                         <div class="flex justify-between items-center border-t border-gray-700 pt-2">
                            <span class="text-lg font-bold text-primary">Total a Pagar:</span>
                            <span id="payment-summary-total" class="text-lg font-bold text-primary"></span>
                        </div>
                    </div>

                    <!-- Opções de Pagamento -->
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                           <label for="payment-method" class="block text-sm font-medium text-gray-300 mb-1">Forma de Pagamento</label>
                           <select id="payment-method" required class="form-select w-full">
                               <option value="Dinheiro">Dinheiro</option>
                               <option value="Cartão de Crédito">Cartão de Crédito</option>
                               <option value="Cartão de Débito">Cartão de Débito</option>
                               <option value="Pix">Pix</option>
                           </select>
                        </div>
                        <div>
                           <label for="payment-discount" class="block text-sm font-medium text-gray-300 mb-1">Desconto (R$)</label>
                           <input type="number" step="0.01" id="payment-discount" placeholder="0,00" class="form-input w-full">
                        </div>
                    </div>

                    <!-- Créditos e Troco -->
                    <div id="payment-credits-section" class="hidden">
                        <label class="flex items-center space-x-3">
                           <input type="checkbox" id="payment-use-credits" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                           <span id="payment-credits-label" class="text-sm text-gray-300"></span>
                        </label>
                    </div>
                    <div id="payment-cash-section">
                        <label for="payment-cash-paid" class="block text-sm font-medium text-gray-300 mb-1">Valor Pago (Dinheiro)</label>
                        <input type="number" step="0.01" id="payment-cash-paid" placeholder="0,00" class="form-input w-full">
                        <div class="text-right mt-2">
                            <span class="text-gray-400">Troco:</span>
                            <span id="payment-change" class="font-semibold text-white">R$ 0,00</span>
                        </div>
                    </div>
                </form>
                <div class="mt-8 flex justify-end">
                    <button id="confirm-payment-button" class="btn-primary w-full sm:w-auto">
                        <span class="btn-text"><i class="fas fa-check-circle mr-2"></i>Confirmar Pagamento</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico do Cliente -->
    <div id="client-history-modal" class="hidden fixed inset-0 z-[60] overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-2xl">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-primary">Histórico do Cliente</h3>
                        <p id="client-history-name" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="close-client-history-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="client-history-content" class="max-h-[60vh] overflow-y-auto pr-2">
                    <p id="loading-client-history" class="text-center text-gray-400 p-8">A carregar histórico...</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Modais de Edição -->
    <div id="edit-service-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Serviço</h3>
                <form id="edit-service-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-service-id">
                    <input type="text" id="edit-service-name" required placeholder="Nome" class="form-input w-full">
                    <input type="number" step="0.01" id="edit-service-value" required placeholder="Valor (R$)" class="form-input w-full">
                    <input type="number" step="0.01" id="edit-service-promo-value" placeholder="Valor Promocional (Opcional)" class="form-input w-full">
                    <input type="number" id="edit-service-duration" required placeholder="Duração (min)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-professional-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Profissional</h3>
                <form id="edit-professional-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-professional-id">
                    <input type="text" id="edit-professional-name" required placeholder="Nome do Profissional" class="form-input w-full">
                    <input type="text" id="edit-professional-function" required placeholder="Função" class="form-input w-full">
                    <input type="url" id="edit-professional-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                    <input type="number" id="edit-professional-commission-services" step="1" min="0" max="100" placeholder="Comissão Serviços (%)" class="form-input w-full">
                    <input type="number" id="edit-professional-commission-products" step="1" min="0" max="100" placeholder="Comissão Produtos (%)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-professional-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-professional-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-unit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Unidade</h3>
                <form id="edit-unit-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-unit-id">
                    <input type="text" id="edit-unit-name" required placeholder="Nome da Unidade" class="form-input w-full">
                    <input type="text" id="edit-unit-address" required placeholder="Endereço" class="form-input w-full">
                    <input type="url" id="edit-unit-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                    <input type="url" id="edit-unit-maps" placeholder="Link do Google Maps (Opcional)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-unit-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-unit-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-plan-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Plano</h3>
                <form id="edit-plan-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-plan-id">
                    <input type="text" id="edit-plan-title" required placeholder="Título do Plano" class="form-input w-full">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="edit-plan-price" required placeholder="Preço (ex: 129,90)" class="form-input w-full">
                        <input type="text" id="edit-plan-period" required placeholder="Período (ex: /mês)" class="form-input w-full">
                    </div>
                    <textarea id="edit-plan-features" required placeholder="Características (uma por linha)" rows="4" class="form-textarea w-full"></textarea>
                    <div class="flex items-center">
                        <input id="edit-plan-popular" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                        <label for="edit-plan-popular" class="ml-2 block text-sm text-gray-300">Marcar como "Mais Popular"?</label>
                    </div>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-plan-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-plan-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-goal-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Meta</h3>
                <form id="edit-goal-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-goal-id">
                    <input type="number" id="edit-goal-target" required placeholder="Nº de Indicações" class="form-input w-full">
                    <input type="text" id="edit-goal-prize" required placeholder="Prêmio" class="form-input w-full">
                    <input type="text" id="edit-goal-icon" required placeholder="Ícone" class="form-input w-full">
                    <select id="edit-goal-service-id" class="form-select w-full">
                        <option value="">Prêmio sem serviço vinculado</option>
                    </select>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-goal-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-goal-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-client-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Cliente</h3>
                <form id="edit-client-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-client-id">
                    <input type="text" id="edit-client-name" required placeholder="Nome do Cliente" class="form-input w-full">
                    <input type="tel" id="edit-client-phone" required placeholder="Telefone" class="form-input w-full">
                    <input type="email" id="edit-client-email" placeholder="E-mail" class="form-input w-full">
                    <label for="edit-client-birthdate" class="block text-sm font-medium text-gray-300 -mb-3 pt-2">Data de Nascimento</label>
                    <input type="date" id="edit-client-birthdate" class="form-input w-full">
                    <input type="number" id="edit-client-credits" step="0.01" placeholder="Créditos de Indicação (R$)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-client-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-client-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[100] overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-white text-center mb-4">Confirmar Ação</h3>
                <p id="confirmation-message" class="text-center text-gray-300 mb-8">Você tem certeza?</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-confirmation-button" class="btn-secondary">Cancelar</button>
                    <button id="confirm-action-button" class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Agendamento -->
    <div id="add-appointment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Adicionar Agendamento Manual</h3>
                <form id="add-appointment-form" class="space-y-4 text-left">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="appt-client-select" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                            <select id="appt-client-select" required class="form-select w-full"></select>
                        </div>
                         <div>
                            <label for="appt-professional-select" class="block text-sm font-medium text-gray-300 mb-1">Profissional</label>
                            <select id="appt-professional-select" required class="form-select w-full"></select>
                        </div>
                    </div>
                    <div>
                        <label for="appt-service-select" class="block text-sm font-medium text-gray-300 mb-1">Serviço</label>
                        <select id="appt-service-select" required class="form-select w-full"></select>
                    </div>
                     <div>
                        <label for="appt-datetime-input" class="block text-sm font-medium text-gray-300 mb-1">Data e Hora</label>
                        <input type="datetime-local" id="appt-datetime-input" required class="form-input w-full">
                    </div>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-add-appointment-button" class="btn-secondary">Cancelar</button>
                    <button id="save-add-appointment-button" class="btn-primary">
                        <span class="btn-text">Salvar Agendamento</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO Modal de Edição de Agendamento -->
    <div id="edit-appointment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">Gerenciar Agendamento</h3>
                    <button id="close-edit-appointment-modal" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <form id="edit-appointment-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-appointment-id">
                    <div>
                        <label for="edit-appt-status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select id="edit-appt-status" required class="form-select w-full">
                            <option value="agendado">Agendado</option>
                            <option value="confirmado">Confirmado</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit-appt-datetime" class="block text-sm font-medium text-gray-300 mb-1">Data e Hora</label>
                        <input type="datetime-local" id="edit-appt-datetime" required class="form-input w-full">
                    </div>
                </form>
                <div class="mt-8 flex flex-wrap justify-between gap-4">
                    <div>
                        <button id="delete-appointment-button" class="btn-secondary !bg-red-800 !border-red-700 hover:!bg-red-700"><i class="fas fa-trash-alt mr-2"></i>Remover</button>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button id="whatsapp-reminder-button" class="btn-secondary !bg-green-700 !border-green-600 hover:!bg-green-600"><i class="fab fa-whatsapp mr-2"></i>Lembrete</button>
                        <button id="save-edit-appointment-button" class="btn-primary">
                            <span class="btn-text">Salvar Alterações</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO Modal de Ação de Slot (Agendar/Folga) -->
    <div id="slot-action-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-primary">Novo Evento</h3>
                        <p id="slot-action-subtitle" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="close-slot-action-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                
                <!-- Abas do Modal -->
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="slot-tab-agendar" class="tab-button active">Agendar</button>
                        <button id="slot-tab-bloqueio" class="tab-button text-gray-400 hover:text-gray-200">Bloqueio</button>
                    </nav>
                </div>

                <!-- Conteúdo da Aba AGENDAR -->
                <div id="slot-content-agendar">
                    <form id="slot-appointment-form" class="space-y-4 text-left">
                        <input type="hidden" id="slot-professional-id">
                        <input type="hidden" id="slot-datetime">
                        <div>
                            <label for="slot-client-select" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                            <div class="flex items-center gap-2">
                                <select id="slot-client-select" required class="form-select w-full flex-grow"></select>
                                <button type="button" id="open-quick-client-modal-btn" class="btn-secondary px-3" title="Cadastrar Novo Cliente"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div>
                            <label for="slot-service-select" class="block text-sm font-medium text-gray-300 mb-1">Serviço</label>
                            <select id="slot-service-select" required class="form-select w-full"></select>
                        </div>
                        <!-- NOVO: Opções de Recorrência -->
                        <div class="pt-2">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="slot-recurring-checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                                <span class="text-sm text-gray-300">Repetir agendamento?</span>
                            </label>
                            <div id="slot-recurring-options" class="hidden mt-3 p-3 bg-black/20 rounded-md grid grid-cols-3 gap-3">
                                <input type="number" id="slot-recurring-frequency" value="1" class="form-input" placeholder="A cada...">
                                <select id="slot-recurring-period" class="form-select col-span-1">
                                    <option value="weeks">Semana(s)</option>
                                    <option value="months">Mes(es)</option>
                                </select>
                                <input type="number" id="slot-recurring-count" value="4" class="form-input" placeholder="Nº de vezes">
                            </div>
                        </div>
                    </form>
                    <div class="mt-8 flex justify-end">
                        <button type="submit" form="slot-appointment-form" id="save-slot-appointment-button" class="btn-primary">
                            <span class="btn-text">Salvar Agendamento</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Conteúdo da Aba BLOQUEIO -->
                <div id="slot-content-bloqueio" class="hidden">
                    <form id="slot-block-form" class="space-y-4 text-left">
                         <div>
                            <label for="slot-block-reason" class="block text-sm font-medium text-gray-300 mb-1">Motivo do Bloqueio</label>
                            <select id="slot-block-reason" class="form-select w-full">
                                <option value="folga">Folga</option>
                                <option value="almoco">Almoço</option>
                                <option value="reuniao">Reunião</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                         <div>
                            <label for="slot-block-duration" class="block text-sm font-medium text-gray-300 mb-1">Duração (em minutos)</label>
                            <input type="number" id="slot-block-duration" value="30" step="15" min="15" class="form-input w-full">
                        </div>
                        <p class="text-xs text-gray-500">O bloqueio será criado a partir do horário selecionado.</p>
                    </form>
                    <div class="mt-8 flex justify-end">
                        <button type="submit" form="slot-block-form" id="save-slot-block-button" class="btn-secondary !bg-teal-700 !border-teal-600 hover:!bg-teal-600">
                            <span class="btn-text"><i class="fas fa-lock mr-2"></i>Salvar Bloqueio</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal de Edição de Bloqueio -->
    <div id="edit-block-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-start mb-4">
                     <div>
                        <h3 class="text-xl font-bold text-primary">Gerenciar Bloqueio</h3>
                        <p id="edit-block-subtitle" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="close-edit-block-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="edit-block-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-block-id">
                    <div>
                        <label for="edit-block-reason" class="block text-sm font-medium text-gray-300 mb-1">Motivo do Bloqueio</label>
                        <select id="edit-block-reason" class="form-select w-full">
                            <option value="folga">Folga</option>
                            <option value="almoco">Almoço</option>
                            <option value="reuniao">Reunião</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit-block-duration" class="block text-sm font-medium text-gray-300 mb-1">Duração (em minutos)</label>
                        <input type="number" id="edit-block-duration" value="30" step="15" min="15" class="form-input w-full">
                    </div>
                </form>
                <div class="mt-8 flex justify-between items-center">
                    <button id="delete-block-button" class="btn-secondary !bg-red-800 !border-red-700 hover:!bg-red-700"><i class="fas fa-trash-alt mr-2"></i>Remover Bloqueio</button>
                    <button id="save-edit-block-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO Modal de Cadastro Rápido de Cliente -->
    <div id="add-quick-client-modal" class="hidden fixed inset-0 z-[60] overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Cadastrar Novo Cliente</h3>
                <form id="add-quick-client-form" class="space-y-4 text-left">
                    <div>
                        <label for="quick-client-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Cliente</label>
                        <input type="text" id="quick-client-name" required class="form-input w-full">
                    </div>
                    <div>
                        <label for="quick-client-phone" class="block text-sm font-medium text-gray-300 mb-1">Telefone</label>
                        <input type="tel" id="quick-client-phone" required class="form-input w-full">
                    </div>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-quick-client-button" class="btn-secondary">Cancelar</button>
                    <button id="save-quick-client-button" class="btn-primary">
                        <span class="btn-text">Salvar Cliente</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- SDK do Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDoc, query, where, getDocs, serverTimestamp, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBSB03qbus51od3i1ipHJ_Wf6O6rf-1UeY",
            authDomain: "agenda-vs-barbearia.firebaseapp.com",
            projectId: "agenda-vs-barbearia",
            storageBucket: "agenda-vs-barbearia.firebasestorage.app",
            messagingSenderId: "1052414878320",
            appId: "1:1052414878320:web:6bb826bc64b16f9e5b8ab5",
            measurementId: "G-1FYTSFFPYV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Estado global e caches
        let agendaState = {
            currentDate: new Date(),
            interval: 30,
            professionals: [],
            appointments: []
        };
        let localServicesCache = [];
        let localProfessionalsCache = [];
        let localClientsCache = [];
        let isDragging = false; // Flag para controlar o estado de arrastar


        // --- Lógica de Autenticação ---
        const authSection = document.getElementById('auth-section');
        const panelSection = document.getElementById('panel-section');
        const userEmailSpan = document.getElementById('user-email');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const authError = document.getElementById('auth-error');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.classList.add('hidden');
                panelSection.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                initializeGlobalEventListeners(); 
                initializeDropzones(); 
                document.querySelector('#sidebar .nav-link[data-target="content-dashboard"]').click();
                loadAgendaSettings(user.uid);
            } else {
                authSection.classList.remove('hidden');
                panelSection.classList.add('hidden');
            }
        });
        
        signupButton.addEventListener('click', async () => { const email = emailInput.value; const password = passwordInput.value; authError.textContent = ''; try { await createUserWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Erro no cadastro:", error); authError.textContent = "Erro ao cadastrar. Verifique o email e a senha (mínimo 6 caracteres)."; } });
        loginButton.addEventListener('click', async () => { const email = emailInput.value; const password = passwordInput.value; authError.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Erro no login:", error); authError.textContent = "Email ou senha inválidos."; } });
        logoutButton.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Erro no logout:", error); } });

        // --- CRUD DE SERVIÇOS ---
        const addServiceForm = document.getElementById('add-service-form');
        const servicesListDiv = document.getElementById('services-list');
        const loadingServicesP = document.getElementById('loading-services');
        const editServiceModal = document.getElementById('edit-service-modal');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const saveEditButton = document.getElementById('save-edit-button');
        
        addServiceForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const user = auth.currentUser; if (!user) return;
            const submitBtn = addServiceForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            const serviceName = document.getElementById('service-name').value; 
            const serviceValue = parseFloat(document.getElementById('service-value').value); 
            const servicePromoValueInput = document.getElementById('service-promo-value');
            const serviceDuration = parseInt(document.getElementById('service-duration').value);
            const data = { nome: serviceName, valor: serviceValue, duracaoMinutos: serviceDuration, gestorId: user.uid };
            if (servicePromoValueInput.value) { data.promocao = parseFloat(servicePromoValueInput.value); }
            try { 
                await addDoc(collection(db, "servicos"), data); 
                addServiceForm.reset();
                showToast('Serviço salvo com sucesso!', 'success');
            } 
            catch (error) { 
                console.error("Erro ao adicionar serviço: ", error); 
                showToast('Erro ao salvar serviço.', 'error');
            } 
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        let unsubscribeServices = null;
        function loadServices(userId) {
            if (unsubscribeServices) unsubscribeServices();
            const q = query(collection(db, "servicos"), where("gestorId", "==", userId));
            unsubscribeServices = onSnapshot(q, (snapshot) => {
                loadingServicesP.classList.add('hidden');
                servicesListDiv.innerHTML = '';
                localServicesCache = [];
                if (snapshot.empty) { servicesListDiv.innerHTML = '<p class="text-gray-400">Nenhum serviço cadastrado.</p>'; return; }
                snapshot.forEach((doc) => {
                    const servico = {id: doc.id, ...doc.data()};
                    localServicesCache.push(servico);
                    let priceHtml = '';
                    if (servico.promocao && typeof servico.promocao === 'number') {
                        priceHtml = `<span class="font-bold text-primary">R$ ${servico.promocao.toFixed(2).replace('.',',')}</span> <span class="text-xs line-through text-gray-500">R$ ${servico.valor.toFixed(2).replace('.',',')}</span>`;
                    } else { priceHtml = `R$ ${servico.valor.toFixed(2).replace('.',',')}`; }
                    const servicoCard = document.createElement('div');
                    servicoCard.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex justify-between items-center';
                    servicoCard.innerHTML = `
                        <div>
                            <p class="font-bold text-white">${servico.nome}</p>
                            <p class="text-sm text-gray-400">${priceHtml} - ${servico.duracaoMinutos} min</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${servico.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${servico.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    servicesListDiv.appendChild(servicoCard);
                });
            });
        }
        
        servicesListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
            if (action === 'delete') {
                window.deleteDocument('servicos', id);
            }
            if (action === 'edit') {
                const serviceDoc = await getDoc(doc(db, "servicos", id));
                if (serviceDoc.exists()) {
                    const data = serviceDoc.data();
                    document.getElementById('edit-service-id').value = id;
                    document.getElementById('edit-service-name').value = data.nome;
                    document.getElementById('edit-service-value').value = data.valor;
                    document.getElementById('edit-service-promo-value').value = data.promocao || '';
                    document.getElementById('edit-service-duration').value = data.duracaoMinutos;
                    editServiceModal.classList.remove('hidden');
                }
            }
        });

        cancelEditButton.addEventListener('click', () => editServiceModal.classList.add('hidden'));

        saveEditButton.addEventListener('click', async () => {
            const btnText = saveEditButton.querySelector('.btn-text'); const loader = saveEditButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditButton.disabled = true; cancelEditButton.disabled = true;
            const id = document.getElementById('edit-service-id').value;
            const servicePromoValueInput = document.getElementById('edit-service-promo-value');
            const servicoRef = doc(db, "servicos", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-service-name').value,
                valor: parseFloat(document.getElementById('edit-service-value').value),
                duracaoMinutos: parseInt(document.getElementById('edit-service-duration').value),
                promocao: servicePromoValueInput.value ? parseFloat(servicePromoValueInput.value) : null
            };
            try { 
                await updateDoc(servicoRef, dataToUpdate); 
                editServiceModal.classList.add('hidden');
                showToast('Serviço atualizado!', 'success');
            } 
            catch (error) { 
                console.error("Erro ao atualizar serviço:", error);
                showToast('Erro ao atualizar.', 'error');
            } 
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditButton.disabled = false; cancelEditButton.disabled = false; }
        });

        // --- CRUD DE PROFISSIONAIS ---
        const addProfessionalForm = document.getElementById('add-professional-form');
        const professionalsListDiv = document.getElementById('professionals-list');
        const editProfessionalModal = document.getElementById('edit-professional-modal');
        const cancelEditProfessionalButton = document.getElementById('cancel-edit-professional-button');
        const saveEditProfessionalButton = document.getElementById('save-edit-professional-button');
        let unsubscribeProfessionals = null;
        
        addProfessionalForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addProfessionalForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const name = document.getElementById('professional-name').value;
            const func = document.getElementById('professional-function').value;
            const photoUrl = document.getElementById('professional-photo').value;
            const comissaoServicos = document.getElementById('professional-commission-services').value;
            const comissaoProdutos = document.getElementById('professional-commission-products').value;

            const data = { 
                nome: name, 
                funcao: func, 
                imgUrl: photoUrl,
                comissaoServicos: comissaoServicos ? parseInt(comissaoServicos) : 0,
                comissaoProdutos: comissaoProdutos ? parseInt(comissaoProdutos) : 0,
                gestorId: user.uid 
            };

            try { 
                await addDoc(collection(db, "profissionais"), data); 
                addProfessionalForm.reset(); 
                showToast('Profissional salvo!', 'success');
            } 
            catch (error) { 
                console.error("Erro ao adicionar profissional:", error); 
                showToast('Erro ao salvar profissional.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadProfessionals(userId) {
            if (unsubscribeProfessionals) unsubscribeProfessionals();
            const q = query(collection(db, "profissionais"), where("gestorId", "==", userId));
            unsubscribeProfessionals = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-professionals').classList.add('hidden');
                professionalsListDiv.innerHTML = '';
                localProfessionalsCache = [];
                if (snapshot.empty) { professionalsListDiv.innerHTML = '<p class="text-gray-400">Nenhum profissional cadastrado.</p>'; return; }
                snapshot.forEach(doc => {
                    const professional = {id: doc.id, ...doc.data()};
                    localProfessionalsCache.push(professional);
                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${professional.nome.charAt(0)}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <img src="${professional.imgUrl || placeholderImg}" alt="${professional.nome}" class="w-16 h-16 rounded-full mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${professional.nome}</p>
                            <p class="text-sm text-gray-400">${professional.funcao || 'Sem função'}</p>
                            <div class="text-xs text-gray-500 mt-2 flex gap-4">
                                <span><i class="fas fa-cut mr-1 text-primary/70"></i> Serv.: ${professional.comissaoServicos || 0}%</span>
                                <span><i class="fas fa-box mr-1 text-primary/70"></i> Prod.: ${professional.comissaoProdutos || 0}%</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    professionalsListDiv.appendChild(card);
                });
            });
        }

        professionalsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('profissionais', id);
            }
            if (action === 'edit') {
                const professionalDoc = await getDoc(doc(db, "profissionais", id));
                if (professionalDoc.exists()) {
                    const data = professionalDoc.data();
                    document.getElementById('edit-professional-id').value = id;
                    document.getElementById('edit-professional-name').value = data.nome;
                    document.getElementById('edit-professional-function').value = data.funcao || '';
                    document.getElementById('edit-professional-photo').value = data.imgUrl || '';
                    document.getElementById('edit-professional-commission-services').value = data.comissaoServicos || '';
                    document.getElementById('edit-professional-commission-products').value = data.comissaoProdutos || '';
                    editProfessionalModal.classList.remove('hidden');
                }
            }
        });
        
        cancelEditProfessionalButton.addEventListener('click', () => editProfessionalModal.classList.add('hidden'));

        saveEditProfessionalButton.addEventListener('click', async () => {
            const btnText = saveEditProfessionalButton.querySelector('.btn-text'); const loader = saveEditProfessionalButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditProfessionalButton.disabled = true; cancelEditProfessionalButton.disabled = true;
            
            const id = document.getElementById('edit-professional-id').value;
            const professionalRef = doc(db, "profissionais", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-professional-name').value,
                funcao: document.getElementById('edit-professional-function').value,
                imgUrl: document.getElementById('edit-professional-photo').value,
                comissaoServicos: parseInt(document.getElementById('edit-professional-commission-services').value) || 0,
                comissaoProdutos: parseInt(document.getElementById('edit-professional-commission-products').value) || 0,
            };

            try { 
                await updateDoc(professionalRef, dataToUpdate); 
                editProfessionalModal.classList.add('hidden'); 
                showToast('Profissional atualizado!', 'success');
            }
            catch(error) { 
                console.error("Erro ao atualizar profissional:", error); 
                showToast('Erro ao atualizar.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditProfessionalButton.disabled = false; cancelEditProfessionalButton.disabled = false; }
        });


        // --- CRUD DE PLANOS ---
        const addPlanForm = document.getElementById('add-plan-form');
        const plansListDiv = document.getElementById('plans-list');
        const loadingPlansP = document.getElementById('loading-plans');
        const editPlanModal = document.getElementById('edit-plan-modal');
        const cancelEditPlanButton = document.getElementById('cancel-edit-plan-button');
        const saveEditPlanButton = document.getElementById('save-edit-plan-button');
        let unsubscribePlans = null;

        addPlanForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addPlanForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const data = {
                title: document.getElementById('plan-title').value,
                price: document.getElementById('plan-price').value,
                period: document.getElementById('plan-period').value,
                features: document.getElementById('plan-features').value.split('\n').filter(f => f.trim() !== ''),
                isPopular: document.getElementById('plan-popular').checked,
                gestorId: user.uid
            };

            try { 
                await addDoc(collection(db, "planos"), data); 
                addPlanForm.reset(); 
                showToast('Plano salvo com sucesso!', 'success');
            }
            catch(error) { 
                console.error("Erro ao adicionar plano:", error); 
                showToast('Erro ao salvar plano.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadPlans(userId) {
            if (unsubscribePlans) unsubscribePlans();
            const q = query(collection(db, "planos"), where("gestorId", "==", userId));
            unsubscribePlans = onSnapshot(q, (snapshot) => {
                loadingPlansP.classList.add('hidden');
                plansListDiv.innerHTML = '';
                if (snapshot.empty) { plansListDiv.innerHTML = '<p class="text-gray-400">Nenhum plano cadastrado.</p>'; return; }
                snapshot.forEach(doc => {
                    const plan = {id: doc.id, ...doc.data()};
                    const card = document.createElement('div');
                    card.className = `p-6 bg-[#2a2a2a] rounded-lg flex flex-col border ${plan.isPopular ? 'border-primary' : 'border-gray-700'} relative`;
                    
                    let popularBadge = '';
                    if (plan.isPopular) {
                        popularBadge = '<div class="absolute top-0 right-4 -mt-3 bg-primary text-black text-xs font-bold px-3 py-1 rounded-full">MAIS POPULAR</div>';
                    }

                    const featuresHtml = plan.features.map(f => `<li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>${f}</li>`).join('');

                    card.innerHTML = `
                        ${popularBadge}
                        <h4 class="text-lg font-bold text-white mb-2">${plan.title}</h4>
                        <div class="mb-4">
                            <span class="text-3xl font-extrabold text-primary">${plan.price}</span>
                            <span class="text-base font-medium text-gray-400">${plan.period}</span>
                        </div>
                        <ul class="space-y-2 text-gray-300 flex-grow mb-6">
                            ${featuresHtml}
                        </ul>
                        <div class="flex justify-end gap-4 mt-auto pt-4 border-t border-gray-700">
                             <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${plan.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                             <button class="text-sm text-red-500 hover:text-red-400 font-semibold" data-id="${plan.id}" data-action="delete"><i class="fas fa-trash-alt mr-1"></i>Excluir</button>
                        </div>
                    `;
                    plansListDiv.appendChild(card);
                });
            });
        }

        plansListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('planos', id);
            }

            if (action === 'edit') {
                const planDoc = await getDoc(doc(db, "planos", id));
                if (planDoc.exists()) {
                    const data = planDoc.data();
                    document.getElementById('edit-plan-id').value = id;
                    document.getElementById('edit-plan-title').value = data.title;
                    document.getElementById('edit-plan-price').value = data.price;
                    document.getElementById('edit-plan-period').value = data.period;
                    document.getElementById('edit-plan-features').value = data.features.join('\n');
                    document.getElementById('edit-plan-popular').checked = data.isPopular;
                    editPlanModal.classList.remove('hidden');
                }
            }
        });

        cancelEditPlanButton.addEventListener('click', () => editPlanModal.classList.add('hidden'));

        saveEditPlanButton.addEventListener('click', async () => {
            const btnText = saveEditPlanButton.querySelector('.btn-text'); const loader = saveEditPlanButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditPlanButton.disabled = true; cancelEditPlanButton.disabled = true;

            const id = document.getElementById('edit-plan-id').value;
            const planRef = doc(db, "planos", id);
            const dataToUpdate = {
                title: document.getElementById('edit-plan-title').value,
                price: document.getElementById('edit-plan-price').value,
                period: document.getElementById('edit-plan-period').value,
                features: document.getElementById('edit-plan-features').value.split('\n').filter(f => f.trim() !== ''),
                isPopular: document.getElementById('edit-plan-popular').checked
            };

            try { 
                await updateDoc(planRef, dataToUpdate); 
                editPlanModal.classList.add('hidden'); 
                showToast('Plano atualizado!', 'success');
            }
            catch(error) { 
                console.error("Erro ao atualizar plano:", error); 
                showToast('Erro ao atualizar.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditPlanButton.disabled = false; cancelEditPlanButton.disabled = false; }
        });


        // --- CRUD DE UNIDADES ---
        const addUnitForm = document.getElementById('add-unit-form');
        const unitsListDiv = document.getElementById('units-list');
        const editUnitModal = document.getElementById('edit-unit-modal');
        const cancelEditUnitButton = document.getElementById('cancel-edit-unit-button');
        const saveEditUnitButton = document.getElementById('save-edit-unit-button');
        let unsubscribeUnits = null;

        addUnitForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addUnitForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const name = document.getElementById('unit-name').value;
            const address = document.getElementById('unit-address').value;
            const photoUrl = document.getElementById('unit-photo').value;
            const mapsUrl = document.getElementById('unit-maps').value;
            
            const data = { nome: name, endereco: address, imgUrl: photoUrl, mapsUrl: mapsUrl, gestorId: user.uid };

            try { 
                await addDoc(collection(db, "unidades"), data); 
                addUnitForm.reset(); 
                showToast('Unidade salva!', 'success');
            } 
            catch (error) { 
                console.error("Erro ao adicionar unidade:", error); 
                showToast('Erro ao salvar unidade.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadUnits(userId) {
            if (unsubscribeUnits) unsubscribeUnits();
            const q = query(collection(db, "unidades"), where("gestorId", "==", userId));
            unsubscribeUnits = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-units').classList.add('hidden');
                unitsListDiv.innerHTML = '';
                if (snapshot.empty) { unitsListDiv.innerHTML = '<p class="text-gray-400">Nenhuma unidade cadastrada.</p>'; return; }
                snapshot.forEach(doc => {
                    const unit = doc.data();
                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${unit.nome.slice(0, 2).toUpperCase()}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    
                    const addressHtml = unit.mapsUrl 
                        ? `<a href="${unit.mapsUrl}" target="_blank" class="hover:text-primary transition-colors">${unit.endereco} <i class="fas fa-external-link-alt text-xs ml-1"></i></a>` 
                        : unit.endereco;

                    card.innerHTML = `
                        <img src="${unit.imgUrl || placeholderImg}" alt="${unit.nome}" class="w-20 h-20 rounded-lg mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${unit.nome}</p>
                            <p class="text-sm text-gray-400">${addressHtml}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    unitsListDiv.appendChild(card);
                });
            });
        }
        
        unitsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('unidades', id);
            }
            if (action === 'edit') {
                const unitDoc = await getDoc(doc(db, "unidades", id));
                if (unitDoc.exists()) {
                    const data = unitDoc.data();
                    document.getElementById('edit-unit-id').value = id;
                    document.getElementById('edit-unit-name').value = data.nome;
                    document.getElementById('edit-unit-address').value = data.endereco || '';
                    document.getElementById('edit-unit-photo').value = data.imgUrl || '';
                    document.getElementById('edit-unit-maps').value = data.mapsUrl || '';
                    editUnitModal.classList.remove('hidden');
                }
            }
        });
        
        cancelEditUnitButton.addEventListener('click', () => editUnitModal.classList.add('hidden'));

        saveEditUnitButton.addEventListener('click', async () => {
            const btnText = saveEditUnitButton.querySelector('.btn-text'); const loader = saveEditUnitButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditUnitButton.disabled = true; cancelEditUnitButton.disabled = true;
            
            const id = document.getElementById('edit-unit-id').value;
            const unitRef = doc(db, "unidades", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-unit-name').value,
                endereco: document.getElementById('edit-unit-address').value,
                imgUrl: document.getElementById('edit-unit-photo').value,
                mapsUrl: document.getElementById('edit-unit-maps').value,
            };

            try { 
                await updateDoc(unitRef, dataToUpdate); 
                editUnitModal.classList.add('hidden'); 
                showToast('Unidade atualizada!', 'success');
            }
            catch(error) { 
                console.error("Erro ao atualizar unidade:", error); 
                showToast('Erro ao atualizar.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditUnitButton.disabled = false; cancelEditUnitButton.disabled = false; }
        });


        // --- LÓGICA DA AGENDA (CORRIGIDA E FUNCIONAL) ---
        const datePicker = document.getElementById('date-picker');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const agendaTitle = document.getElementById('agenda-title');
        const agendaGridView = document.getElementById('agenda-grid-view');
        const loadingAgenda = document.getElementById('loading-agenda');
        const professionalFilter = document.getElementById('professional-filter');
        const addAppointmentBtn = document.getElementById('add-appointment-btn');
        const addAppointmentModal = document.getElementById('add-appointment-modal');
        const cancelAddAppointmentButton = document.getElementById('cancel-add-appointment-button');
        const saveAddAppointmentButton = document.getElementById('save-add-appointment-button');
        let unsubscribeAgenda = null;

        function initializeGlobalEventListeners() {
            prevDayBtn.addEventListener('click', () => {
                agendaState.currentDate.setDate(agendaState.currentDate.getDate() - 1);
                updateDateDisplay();
                loadAgendaData(auth.currentUser.uid);
            });
            nextDayBtn.addEventListener('click', () => {
                agendaState.currentDate.setDate(agendaState.currentDate.getDate() + 1);
                updateDateDisplay();
                loadAgendaData(auth.currentUser.uid);
            });
            datePicker.addEventListener('change', () => {
                const [year, month, day] = datePicker.value.split('-').map(Number);
                agendaState.currentDate = new Date(year, month - 1, day);
                updateDateDisplay();
                loadAgendaData(auth.currentUser.uid);
            });
            professionalFilter.addEventListener('change', renderAgendaGrid);
            
            const agendaContainer = document.getElementById('agenda-container');
            agendaContainer.addEventListener('click', (e) => {
                const blockBtn = e.target.closest('.block-day-btn');
                if (blockBtn) {
                    const profId = blockBtn.dataset.profId;
                    const professional = localProfessionalsCache.find(p => p.id === profId);
                    if (professional) {
                        blockEntireDay(profId, professional.nome);
                    }
                }
            });
            
            addAppointmentBtn.addEventListener('click', () => openAddAppointmentModal());
            
            cancelAddAppointmentButton.addEventListener('click', () => addAppointmentModal.classList.add('hidden'));
            addAppointmentModal.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = saveAddAppointmentButton;
                const btnText = btn.querySelector('.btn-text');
                const loader = btn.querySelector('.loader');
                btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;

                try {
                    const clientId = document.getElementById('appt-client-select').value;
                    const professionalId = document.getElementById('appt-professional-select').value;
                    const serviceId = document.getElementById('appt-service-select').value;
                    const dateTime = new Date(document.getElementById('appt-datetime-input').value);

                    const client = localClientsCache.find(c => c.id === clientId);
                    const professional = localProfessionalsCache.find(p => p.id === professionalId);
                    const service = localServicesCache.find(s => s.id === serviceId);
                    
                    if (!client || !professional || !service) throw new Error("Dados inválidos selecionados.");

                    const newAppointment = {
                        cliente: { id: client.id, nome: client.name },
                        barbeiro: { id: professional.id, nome: professional.nome },
                        servico: { id: service.id, nome: service.nome, duracaoMinutos: service.duracaoMinutos },
                        data: dateTime,
                        status: 'agendado',
                        gestorId: auth.currentUser.uid,
                        createdAt: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, "agendamentos"), newAppointment);
                    addAppointmentModal.classList.add('hidden');
                    showToast('Agendamento salvo!', 'success');

                } catch (error) {
                    console.error("Erro ao salvar agendamento manual:", error);
                    showToast("Erro ao salvar.", 'error');
                } finally {
                    btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
                }
            });
        }
        
        function blockEntireDay(professionalId, professionalName) {
            const message = `Tem certeza que deseja bloquear a agenda inteira de ${professionalName} para este dia? Isto irá criar um bloqueio de dia inteiro e não pode ser desfeito facilmente.`;
            showConfirmationModal(message, async () => {
                try {
                    const professional = localProfessionalsCache.find(p => p.id === professionalId);
                    if (!professional) throw new Error("Profissional não encontrado.");

                    const startTime = 8; // 08:00
                    const endTime = 20;  // 20:00
                    const duration = (endTime - startTime) * 60; // Duração em minutos

                    const blockDateTime = new Date(agendaState.currentDate);
                    blockDateTime.setHours(startTime, 0, 0, 0);

                    await addDoc(collection(db, "agendamentos"), {
                        barbeiro: { id: professional.id, nome: professional.nome },
                        data: blockDateTime,
                        status: 'bloqueio',
                        motivo: 'folga',
                        duracaoMinutos: duration,
                        gestorId: auth.currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    
                    showToast(`Agenda de ${professionalName} bloqueada.`, 'info');

                } catch (error) {
                    console.error("Erro ao bloquear o dia inteiro:", error);
                    showToast('Erro ao tentar bloquear a agenda.', 'error');
                }
            });
        }

        async function openAddAppointmentModal() {
            const form = addAppointmentModal.querySelector('form');
            form.reset();
            
            const clientSelect = document.getElementById('appt-client-select');
            const profSelect = document.getElementById('appt-professional-select');
            const serviceSelect = document.getElementById('appt-service-select');
            
            clientSelect.innerHTML = '<option value="">Carregando...</option>';
            profSelect.innerHTML = '<option value="">Carregando...</option>';
            serviceSelect.innerHTML = '<option value="">Carregando...</option>';

            addAppointmentModal.classList.remove('hidden');

            try {
                await populateCaches(auth.currentUser.uid);

                clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
                localClientsCache.forEach(c => clientSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

                profSelect.innerHTML = '<option value="">Selecione um profissional</option>';
                localProfessionalsCache.forEach(p => profSelect.innerHTML += `<option value="${p.id}">${p.nome}</option>`);

                serviceSelect.innerHTML = '<option value="">Selecione um serviço</option>';
                localServicesCache.forEach(s => serviceSelect.innerHTML += `<option value="${s.id}">${s.nome}</option>`);

                const dateTimeInput = document.getElementById('appt-datetime-input');
                const now = new Date(agendaState.currentDate);
                now.setHours(9, 0, 0, 0);
                dateTimeInput.value = formatDateTimeForInput(now);

            } catch (error) {
                console.error("Erro ao abrir modal de agendamento:", error);
                showToast("Erro ao carregar dados.", 'error');
            }
        }

        async function populateCaches(userId) {
            try {
                const cachePromises = [];
                if (localServicesCache.length === 0) {
                    cachePromises.push(getDocs(query(collection(db, "servicos"), where("gestorId", "==", userId))).then(snap => {
                        localServicesCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }));
                }
                if (localClientsCache.length === 0) {
                    cachePromises.push(getDocs(query(collection(db, "users"), where("gestorId", "==", userId))).then(snap => {
                        localClientsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }));
                }
                 if (localProfessionalsCache.length === 0) {
                     cachePromises.push(getDocs(query(collection(db, "profissionais"), where("gestorId", "==", userId))).then(snap => {
                        localProfessionalsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }));
                }
                await Promise.all(cachePromises);
            } catch (error) {
                console.error("Falha ao carregar dados de suporte da agenda:", error);
            }
        }
        
        function formatDateTimeForInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function updateDateDisplay() {
            datePicker.value = formatDateForInput(agendaState.currentDate);
            agendaTitle.textContent = `Agenda - ${agendaState.currentDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}`;
        }

        async function initializeAgenda(userId) {
            await populateCaches(userId);
            updateDateDisplay();
            loadAgendaData(userId);
        }

        function populateProfessionalFilter() {
            const currentVal = professionalFilter.value;
            professionalFilter.innerHTML = '<option value="all">Todos Profissionais</option>';
            agendaState.professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.nome;
                if (prof.id === currentVal) {
                    option.selected = true;
                }
                professionalFilter.appendChild(option);
            });
        }
        professionalFilter.addEventListener('change', renderAgendaGrid);


        async function loadAgendaData(userId) {
            loadingAgenda.classList.remove('hidden');
            agendaGridView.classList.add('hidden');

            if (unsubscribeAgenda) unsubscribeAgenda();

            try {
                const professionalsQuery = query(collection(db, "profissionais"), where("gestorId", "==", userId));
                const professionalsSnapshot = await getDocs(professionalsQuery);
                agendaState.professionals = professionalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateProfessionalFilter();

                const allAppointmentsQuery = query(collection(db, "agendamentos"), where("gestorId", "==", userId));

                unsubscribeAgenda = onSnapshot(allAppointmentsQuery, (snapshot) => {
                    const startOfDay = new Date(agendaState.currentDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(agendaState.currentDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    const appointmentsForDay = snapshot.docs.filter(doc => {
                        const apptDate = doc.data().data.toDate();
                        return apptDate >= startOfDay && apptDate <= endOfDay;
                    });

                    agendaState.appointments = appointmentsForDay.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAgendaGrid();
                }, (error) => {
                    console.error("Erro no listener de agendamentos:", error);
                    agendaGridView.innerHTML = '<p class="text-center text-red-500 p-8">Ocorreu um erro ao carregar os agendamentos.</p>';
                    loadingAgenda.classList.add('hidden');
                    agendaGridView.classList.remove('hidden');
                });
            } catch (error) {
                console.error("Erro ao carregar dados da agenda:", error);
                agendaGridView.innerHTML = `<p class="text-center text-red-500 p-8">Ocorreu um erro. Verifique o console.</p>`;
                loadingAgenda.classList.add('hidden');
                agendaGridView.classList.remove('hidden');
            }
        }
        
        function renderAgendaGrid() {
            agendaGridView.innerHTML = '';
            
            const selectedProfId = professionalFilter.value;
            const professionalsToRender = selectedProfId === 'all'
                ? agendaState.professionals
                : agendaState.professionals.filter(p => p.id === selectedProfId);

            if (professionalsToRender.length === 0) {
                 agendaGridView.innerHTML = '<p class="text-center text-gray-400 p-8">Nenhum profissional para exibir. Adicione um na aba "Profissionais".</p>';
                 loadingAgenda.classList.add('hidden');
                 agendaGridView.classList.remove('hidden');
                 return;
            }

            const grid = document.createElement('div');
            grid.className = 'agenda-grid';

            const timeColumn = document.createElement('div');
            timeColumn.className = 'time-column';
            const timeHeader = document.createElement('div');
            timeHeader.className = 'professional-header';
            timeHeader.innerHTML = `<i class="far fa-clock"></i>`;
            timeColumn.appendChild(timeHeader);
            
            const timeSlotsContainer = document.createElement('div');
            const startTime = 8;
            const endTime = 20;
            for (let hour = startTime; hour < endTime; hour++) {
                for (let minute = 0; minute < 60; minute += agendaState.interval) {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    timeSlotsContainer.appendChild(timeSlot);
                }
            }
            timeColumn.appendChild(timeSlotsContainer);
            grid.appendChild(timeColumn);

            professionalsToRender.forEach(prof => {
                const profColumn = document.createElement('div');
                profColumn.className = 'professional-column';
                profColumn.dataset.professionalId = prof.id;

                const profHeader = document.createElement('div');
                profHeader.className = 'professional-header !justify-between !px-2';
                profHeader.innerHTML = `
                    <span class="font-bold text-white">${prof.nome.split(' ')[0]}</span>
                    <button data-prof-id="${prof.id}" class="block-day-btn text-xs h-6 w-6 flex items-center justify-center bg-gray-700/50 hover:bg-gray-700 rounded-full transition-colors" title="Bloquear dia inteiro">
                        <i class="fas fa-ban"></i>
                    </button>
                `;
                profColumn.appendChild(profHeader);
                
                const linesContainer = document.createElement('div');
                for (let hour = startTime; hour < endTime; hour++) {
                    for (let minute = 0; minute < 60; minute += agendaState.interval) {
                         const line = document.createElement('div');
                         line.className = 'time-slot-line';
                         line.style.cursor = 'pointer';
                         line.addEventListener('click', () => {
                            const slotTime = new Date(agendaState.currentDate);
                            slotTime.setHours(hour, minute, 0, 0);
                            openSlotActionModal(prof.id, slotTime);
                         });
                         linesContainer.appendChild(line);
                    }
                }
                profColumn.appendChild(linesContainer);
                grid.appendChild(profColumn);
            });
            
            agendaGridView.appendChild(grid);
            placeAppointments();

            loadingAgenda.classList.add('hidden');
            agendaGridView.classList.remove('hidden');
        }

        function placeAppointments() {
            agendaState.appointments.forEach(appt => {
                const professionalId = appt.barbeiro?.id;
                if (!professionalId) return;

                const column = agendaGridView.querySelector(`.professional-column[data-professional-id="${professionalId}"]`);
                if (!column) return;

                const apptDate = appt.data.toDate();
                const startHour = 8;
                const totalMinutesFromStart = (apptDate.getHours() - startHour) * 60 + apptDate.getMinutes();

                const slotHeight = 40;
                const pixelsPerMinute = slotHeight / agendaState.interval;

                const topPosition = totalMinutesFromStart * pixelsPerMinute;
                
                let duration;
                if(appt.status === 'bloqueio') {
                    duration = appt.duracaoMinutos || agendaState.interval;
                } else {
                    duration = appt.servico?.duracaoMinutos || agendaState.interval;
                }
                const height = duration * pixelsPerMinute;

                const card = document.createElement('div');
                let cardContent = '';

                if (appt.status === 'bloqueio') {
                    const motivo = appt.motivo || 'folga';
                    card.className = `appointment-card status-bloqueio motivo-${motivo}`;
                    cardContent = `<i class="fas ${motivo === 'almoco' ? 'fa-utensils' : 'fa-coffee'} mr-2"></i> ${(appt.motivo || 'bloqueio').toUpperCase()}`;
                    card.dataset.id = appt.id;
                    card.addEventListener('click', () => {
                        if (isDragging) return;
                        openEditBlockModal(appt.id);
                    });
                } else {
                    card.className = `appointment-card status-${appt.status || 'agendado'}`;
                    cardContent = `
                        <p class="font-bold">${appt.cliente?.nome || 'Cliente'}</p>
                        <p class="text-xs">${appt.servico?.nome || 'Serviço'}</p>
                    `;
                    card.dataset.id = appt.id;
                    card.addEventListener('click', () => {
                        if (isDragging) return;
                        openEditAppointmentModal(appt.id);
                    });
                    makeDraggable(card);
                }
            
                card.style.top = `${topPosition}px`;
                card.style.height = `${height}px`;
                card.innerHTML = cardContent;

                const linesContainer = column.querySelector('div:not(.professional-header)');
                if (linesContainer) {
                    linesContainer.style.position = 'relative';
                    linesContainer.appendChild(card);
                }
            });
        }
        
        // --- CRUD DE CLIENTES ---
        const addClientForm = document.getElementById('add-client-form');
        const clientsListDiv = document.getElementById('clients-list');
        const loadingClientsP = document.getElementById('loading-clients');
        const editClientModal = document.getElementById('edit-client-modal');
        const cancelEditClientButton = document.getElementById('cancel-edit-client-button');
        const saveEditClientButton = document.getElementById('save-edit-client-button');
        let unsubscribeClients = null;

        addClientForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addClientForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const referrerId = document.getElementById('client-referrer').value;
            const referrer = localClientsCache.find(c => c.id === referrerId);

            const data = {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                email: document.getElementById('client-email').value,
                birthDate: document.getElementById('client-birthdate').value,
                referralCredits: 0,
                gestorId: user.uid,
                createdAt: serverTimestamp(),
                referrer: referrer ? { id: referrer.id, name: referrer.name } : null,
                firstServiceCompleted: false
            };
            
            try { 
                await addDoc(collection(db, "users"), data); 
                addClientForm.reset(); 
                showToast('Cliente salvo com sucesso!', 'success');
            }
            catch(error) { 
                console.error("Erro ao adicionar cliente:", error); 
                showToast('Erro ao salvar cliente.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadClients(userId) {
            if (unsubscribeClients) unsubscribeClients();
            const q = query(collection(db, "users"), where("gestorId", "==", userId));
            unsubscribeClients = onSnapshot(q, (snapshot) => {
                loadingClientsP.classList.add('hidden');
                clientsListDiv.innerHTML = '';
                localClientsCache = [];
                const referrerSelect = document.getElementById('client-referrer');
                const currentReferrerValue = referrerSelect.value;
                referrerSelect.innerHTML = '<option value="">Ninguém</option>';

                if (snapshot.empty) {
                    clientsListDiv.innerHTML = '<p class="text-gray-400">Nenhum cliente cadastrado.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const client = {id: doc.id, ...doc.data()};
                    localClientsCache.push(client);

                    referrerSelect.innerHTML += `<option value="${client.id}">${client.name}</option>`;

                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${client.name ? client.name.charAt(0) : 'C'}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <img src="${client.profilePic || placeholderImg}" alt="${client.name}" class="w-16 h-16 rounded-full mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${client.name || 'Nome não informado'}</p>
                            <p class="text-sm text-gray-400">${client.phone || 'Telefone não informado'}</p>
                        </div>
                        <div class="text-right mr-4">
                             <p class="text-sm text-gray-400">Créditos</p>
                             <p class="font-bold text-primary text-lg">R$ ${(client.referralCredits || 0).toFixed(2).replace('.',',')}</p>
                        </div>
                        <div class="flex items-center gap-4">
                             <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="history"><i class="fas fa-history mr-1"></i>Histórico</button>
                             <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                             <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                 <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                             </button>
                        </div>`;
                    clientsListDiv.appendChild(card);
                });
            });
        }
        
        clientsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('users', id);
            }
            if (action === 'edit') {
                const clientDoc = await getDoc(doc(db, "users", id));
                if (clientDoc.exists()) {
                    const data = clientDoc.data();
                    document.getElementById('edit-client-id').value = id;
                    document.getElementById('edit-client-name').value = data.name || '';
                    document.getElementById('edit-client-phone').value = data.phone || '';
                    document.getElementById('edit-client-email').value = data.email || '';
                    document.getElementById('edit-client-birthdate').value = data.birthDate || '';
                    document.getElementById('edit-client-credits').value = data.referralCredits || '';
                    editClientModal.classList.remove('hidden');
                }
            }
            if (action === 'history') {
                openClientHistoryModal(id);
            }
        });
        
        cancelEditClientButton.addEventListener('click', () => editClientModal.classList.add('hidden'));

        saveEditClientButton.addEventListener('click', async () => {
            const btnText = saveEditClientButton.querySelector('.btn-text'); const loader = saveEditClientButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditClientButton.disabled = true; cancelEditClientButton.disabled = true;
            
            const id = document.getElementById('edit-client-id').value;
            const clientRef = doc(db, "users", id);
            const dataToUpdate = {
                name: document.getElementById('edit-client-name').value,
                phone: document.getElementById('edit-client-phone').value,
                email: document.getElementById('edit-client-email').value,
                birthDate: document.getElementById('edit-client-birthdate').value,
                referralCredits: parseFloat(document.getElementById('edit-client-credits').value) || 0
            };

            try { 
                await updateDoc(clientRef, dataToUpdate); 
                editClientModal.classList.add('hidden'); 
                showToast('Cliente atualizado!', 'success');
            }
            catch(error) { 
                console.error("Erro ao atualizar cliente:", error); 
                showToast('Erro ao atualizar.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditClientButton.disabled = false; cancelEditClientButton.disabled = false; }
        });
        
        // --- LÓGICA DE FIDELIDADE ---
        const referralSettingsForm = document.getElementById('referral-settings-form');
        
        referralSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const submitBtn = referralSettingsForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            
            try {
                const creditValue = parseFloat(document.getElementById('referral-credit-value').value);
                if (isNaN(creditValue) || creditValue < 0) {
                    throw new Error("Valor inválido.");
                }
                
                const settingsRef = doc(db, 'configuracoes', user.uid);
                await setDoc(settingsRef, { referralCreditValue: creditValue, updatedAt: serverTimestamp() }, { merge: true });

                showToast('Configuração de indicação salva!', 'success');

            } catch (error) {
                console.error("Erro ao salvar config. de indicação:", error);
                showToast('Erro ao salvar. Verifique o valor.', 'error');
            } finally {
                btnText.classList.remove('hidden');
                loader.classList.remove('hidden');
                submitBtn.disabled = false;
            }
        });

        async function loadReferralSettings(userId) {
            const settingsRef = doc(db, 'configuracoes', userId);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists() && docSnap.data().referralCreditValue) {
                document.getElementById('referral-credit-value').value = docSnap.data().referralCreditValue.toFixed(2);
            }
        }

        // --- NOVO: LÓGICA DE RELATÓRIOS ---
        function initializeReports(userId) {
            const startDateInput = document.getElementById('report-start-date');
            const endDateInput = document.getElementById('report-end-date');
            const generateBtn = document.getElementById('generate-report-btn');
            const tabFaturamento = document.getElementById('tab-faturamento');
            const tabServicos = document.getElementById('tab-servicos');
            const tabClientes = document.getElementById('tab-clientes');
            const contentFaturamento = document.getElementById('content-tab-faturamento');
            const contentServicos = document.getElementById('content-tab-servicos');
            const contentClientes = document.getElementById('content-tab-clientes');

            const today = new Date();
            startDateInput.value = formatDateForInput(new Date(today.getFullYear(), today.getMonth(), 1));
            endDateInput.value = formatDateForInput(today);
            
            document.querySelectorAll('[data-range]').forEach(button => {
                button.addEventListener('click', () => {
                    const range = button.dataset.range;
                    const today = new Date();
                    let start = new Date();
                    let end = new Date();

                    if (range === 'today') { start = today; end = today; } 
                    else if (range === 'this_month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today.getFullYear(), today.getMonth() + 1, 0); } 
                    else if (range === 'last_month') { start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
                    
                    startDateInput.value = formatDateForInput(start);
                    endDateInput.value = formatDateForInput(end);
                    generateBillingReport(userId);
                });
            });
            
            generateBtn.addEventListener('click', () => generateBillingReport(userId));
            
            const tabs = [tabFaturamento, tabServicos, tabClientes];
            const contents = [contentFaturamento, contentServicos, contentClientes];

            tabs.forEach((clickedTab, index) => {
                clickedTab.addEventListener('click', () => {
                    tabs.forEach(tab => tab.classList.remove('active'));
                    contents.forEach(content => content.classList.add('hidden'));
                    
                    clickedTab.classList.add('active');
                    contents[index].classList.remove('hidden');

                    if(document.getElementById('report-by-professional-list').innerHTML === '') {
                         generateBillingReport(userId);
                    }
                });
            });
        }

        async function generateBillingReport(userId) {
            const resultsDiv = document.getElementById('report-results');
            const placeholderDiv = document.getElementById('report-placeholder');
            const professionalTableBody = document.getElementById('report-by-professional-list');
            const serviceTableBody = document.getElementById('report-by-service-list');
            const clientTableBody = document.getElementById('report-by-client-list');
            
            placeholderDiv.innerHTML = '<div class="loader mx-auto"></div><p class="mt-4">A gerar relatório...</p>';
            resultsDiv.classList.add('hidden');
            [serviceTableBody.parentElement.parentElement.parentElement, clientTableBody.parentElement.parentElement.parentElement].forEach(el => el.classList.add('hidden'));
            placeholderDiv.classList.remove('hidden');
            
            try {
                const startDateValue = document.getElementById('report-start-date').value;
                const endDateValue = document.getElementById('report-end-date').value;

                const startDate = new Date(`${startDateValue}T00:00:00`);
                const endDate = new Date(`${endDateValue}T23:59:59`);


                if (isNaN(startDate) || isNaN(endDate)) throw new Error("Datas inválidas.");

                const q = query(
                    collection(db, "agendamentos"),
                    where("gestorId", "==", userId),
                    where("status", "==", "finalizado")
                );
                
                const querySnapshot = await getDocs(q);

                let totalBruto = 0, totalComissao = 0, totalDesconto = 0;
                const professionalPerformance = {};
                const servicePerformance = {};
                const clientPerformance = {};

                const agendamentosNoPeriodo = querySnapshot.docs.filter(doc => {
                    const appt = doc.data();
                    if (!appt.dataPagamento) return false;
                    const dataPagamento = appt.dataPagamento.toDate();
                    return dataPagamento >= startDate && dataPagamento <= endDate;
                });

                agendamentosNoPeriodo.forEach(doc => {
                    const appt = doc.data();
                    const bruto = appt.valorServico || 0;
                    const comissao = appt.valorComissao || 0;
                    const desconto = appt.desconto || 0;
                    const profId = appt.barbeiro.id;
                    const serviceId = appt.servico.id;
                    const clientId = appt.cliente.id;

                    totalBruto += bruto;
                    totalComissao += comissao;
                    totalDesconto += desconto;
                    
                    if (!professionalPerformance[profId]) { professionalPerformance[profId] = { nome: appt.barbeiro.nome, servicos: 0, faturamento: 0, comissao: 0 }; }
                    professionalPerformance[profId].servicos++;
                    professionalPerformance[profId].faturamento += bruto;
                    professionalPerformance[profId].comissao += comissao;
                    
                    if (!servicePerformance[serviceId]) { servicePerformance[serviceId] = { nome: appt.servico.nome, count: 0, faturamento: 0 }; }
                    servicePerformance[serviceId].count++;
                    servicePerformance[serviceId].faturamento += bruto;

                    if (!clientPerformance[clientId]) { clientPerformance[clientId] = { nome: appt.cliente.nome, visits: 0, totalSpent: 0 }; }
                    clientPerformance[clientId].visits++;
                    clientPerformance[clientId].totalSpent += bruto;
                });
                
                const totalLiquido = totalBruto - totalComissao;

                document.getElementById('report-total-bruto').textContent = `R$ ${totalBruto.toFixed(2).replace('.', ',')}`;
                document.getElementById('report-total-comissao').textContent = `R$ ${totalComissao.toFixed(2).replace('.', ',')}`;
                document.getElementById('report-total-desconto').textContent = `R$ ${totalDesconto.toFixed(2).replace('.', ',')}`;
                document.getElementById('report-total-liquido').textContent = `R$ ${totalLiquido.toFixed(2).replace('.', ',')}`;
                
                professionalTableBody.innerHTML = '';
                if (Object.keys(professionalPerformance).length === 0) {
                     professionalTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">Nenhum dado encontrado para este período.</td></tr>';
                } else {
                    for (const profId in professionalPerformance) {
                        const data = professionalPerformance[profId];
                        professionalTableBody.innerHTML += `
                             <tr class="bg-[#1e1e1e] border-b border-gray-700">
                                <td class="px-6 py-4 font-medium text-white">${data.nome}</td>
                                <td class="px-6 py-4">${data.servicos}</td>
                                <td class="px-6 py-4">R$ ${data.faturamento.toFixed(2).replace('.', ',')}</td>
                                <td class="px-6 py-4 text-red-400">R$ ${data.comissao.toFixed(2).replace('.', ',')}</td>
                            </tr>`;
                    }
                }
                
                serviceTableBody.innerHTML = '';
                const sortedServices = Object.values(servicePerformance).sort((a, b) => b.count - a.count);

                if (sortedServices.length === 0) {
                    serviceTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">Nenhum serviço encontrado para este período.</td></tr>';
                } else {
                    sortedServices.forEach((service, index) => {
                        serviceTableBody.innerHTML += `
                            <tr class="bg-[#1e1e1e] border-b border-gray-700">
                                <td class="px-6 py-4 font-medium text-white">${index + 1}</td>
                                <td class="px-6 py-4">${service.nome}</td>
                                <td class="px-6 py-4">${service.count}</td>
                                <td class="px-6 py-4 font-semibold">R$ ${service.faturamento.toFixed(2).replace('.', ',')}</td>
                            </tr>`;
                    });
                }
                
                clientTableBody.innerHTML = '';
                const sortedClients = Object.values(clientPerformance).sort((a, b) => b.totalSpent - a.totalSpent);

                if (sortedClients.length === 0) {
                    clientTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">Nenhum cliente encontrado para este período.</td></tr>';
                } else {
                    sortedClients.forEach((client, index) => {
                        clientTableBody.innerHTML += `
                            <tr class="bg-[#1e1e1e] border-b border-gray-700">
                                <td class="px-6 py-4 font-medium text-white">${index + 1}</td>
                                <td class="px-6 py-4">${client.nome}</td>
                                <td class="px-6 py-4">${client.visits}</td>
                                <td class="px-6 py-4 font-semibold text-primary">R$ ${client.totalSpent.toFixed(2).replace('.', ',')}</td>
                            </tr>`;
                    });
                }

                placeholderDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
                [serviceTableBody.parentElement.parentElement.parentElement, clientTableBody.parentElement.parentElement.parentElement].forEach(el => el.classList.remove('hidden'));


            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                placeholderDiv.innerHTML = '<p class="text-red-500">Ocorreu um erro ao gerar o relatório.</p>';
            }
        }

        // --- LÓGICA DO HISTÓRICO DE CLIENTE ---
        const clientHistoryModal = document.getElementById('client-history-modal');
        const closeClientHistoryModalBtn = document.getElementById('close-client-history-modal');

        async function openClientHistoryModal(clientId) {
            const client = localClientsCache.find(c => c.id === clientId);
            if (!client) {
                console.error("Cliente não encontrado no cache.");
                return;
            }

            document.getElementById('client-history-name').textContent = client.name;
            const contentDiv = document.getElementById('client-history-content');
            const loadingP = document.getElementById('loading-client-history');
            contentDiv.innerHTML = '';
            contentDiv.appendChild(loadingP);
            loadingP.classList.remove('hidden');
            
            clientHistoryModal.classList.remove('hidden');

            try {
                const q = query(
                    collection(db, "agendamentos"), 
                    where("cliente.id", "==", clientId),
                    where("status", "==", "finalizado")
                );
                
                const querySnapshot = await getDocs(q);
                loadingP.classList.add('hidden');

                if (querySnapshot.empty) {
                    contentDiv.innerHTML = '<p class="text-center text-gray-500 p-8">Nenhum serviço finalizado encontrado para este cliente.</p>';
                    return;
                }
                
                let historyHtml = '<div class="space-y-4">';
                const historyData = querySnapshot.docs.map(doc => doc.data());
                historyData.sort((a,b) => b.data.toDate() - a.data.toDate());

                historyData.forEach(appt => {
                    const date = appt.data.toDate().toLocaleDateString('pt-BR', {day: '2-digit', month: 'long', year: 'numeric'});
                    const value = (appt.valorFinal !== undefined) ? appt.valorFinal : (appt.valorServico || 0);
                    
                    historyHtml += `
                        <div class="bg-[#1e1e1e] p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-white">${appt.servico.nome}</p>
                                    <p class="text-sm text-gray-400">com ${appt.barbeiro.nome}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-primary">R$ ${value.toFixed(2).replace('.', ',')}</p>
                                    <p class="text-xs text-gray-500">${date}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                historyHtml += '</div>';
                contentDiv.innerHTML = historyHtml;

            } catch (error) {
                console.error("Erro ao buscar histórico do cliente:", error);
                loadingP.classList.add('hidden');
                contentDiv.innerHTML = '<p class="text-center text-red-500 p-8">Erro ao carregar o histórico.</p>';
            }
        }

        closeClientHistoryModalBtn.addEventListener('click', () => clientHistoryModal.classList.add('hidden'));

        // --- CRUD DE METAS ---
        const addGoalForm = document.getElementById('add-goal-form');
        const goalsListDiv = document.getElementById('goals-list');
        const loadingGoalsP = document.getElementById('loading-goals');
        const editGoalModal = document.getElementById('edit-goal-modal');
        const cancelEditGoalButton = document.getElementById('cancel-edit-goal-button');
        const saveEditGoalButton = document.getElementById('save-edit-goal-button');
        let unsubscribeGoals = null;

        addGoalForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addGoalForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const data = {
                target: parseInt(document.getElementById('goal-target').value),
                prize: document.getElementById('goal-prize').value,
                icon: document.getElementById('goal-icon').value,
                serviceId: document.getElementById('goal-service-id').value,
                gestorId: user.uid
            };

            try { 
                await addDoc(collection(db, "metas"), data); 
                addGoalForm.reset(); 
                showToast('Nova meta salva!', 'success');
            }
            catch(error) { 
                console.error("Erro ao adicionar meta:", error); 
                showToast('Erro ao salvar meta.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });
        
        function populateServicesSelect(selectElement, selectedValue = '') {
            selectElement.innerHTML = '<option value="">Prêmio sem serviço vinculado</option>';
            localServicesCache.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.nome;
                if (service.id === selectedValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        async function loadGoals(userId) {
            if (localServicesCache.length === 0) {
                const servicesQuery = query(collection(db, "servicos"), where("gestorId", "==", userId));
                const querySnapshot = await getDocs(servicesQuery);
                querySnapshot.forEach(doc => {
                    localServicesCache.push({ id: doc.id, ...doc.data() });
                });
            }
            populateServicesSelect(document.getElementById('goal-service-id'));
            
            if (unsubscribeGoals) unsubscribeGoals();
            const q = query(collection(db, "metas"), where("gestorId", "==", userId));
            unsubscribeGoals = onSnapshot(q, (snapshot) => {
                loadingGoalsP.classList.add('hidden');
                goalsListDiv.innerHTML = '';
                if (snapshot.empty) { goalsListDiv.innerHTML = '<p class="text-gray-400">Nenhuma meta cadastrada.</p>'; return; }
                snapshot.forEach(doc => {
                    const goal = doc.data();
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <div class="w-12 h-12 rounded-full flex items-center justify-center bg-primary/20 mr-4">
                            <i class="${goal.icon || 'fas fa-star'} text-xl text-primary"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-white">${goal.prize}</p>
                            <p class="text-sm text-gray-400">Meta: ${goal.target} indicações</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    goalsListDiv.appendChild(card);
                });
            });
        }

        goalsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('metas', id);
            }

            if (action === 'edit') {
                const goalDoc = await getDoc(doc(db, "metas", id));
                if (goalDoc.exists()) {
                    const data = goalDoc.data();
                    document.getElementById('edit-goal-id').value = id;
                    document.getElementById('edit-goal-target').value = data.target;
                    document.getElementById('edit-goal-prize').value = data.prize;
                    document.getElementById('edit-goal-icon').value = data.icon;
                    populateServicesSelect(document.getElementById('edit-goal-service-id'), data.serviceId);
                    editGoalModal.classList.remove('hidden');
                }
            }
        });

        cancelEditGoalButton.addEventListener('click', () => editGoalModal.classList.add('hidden'));

        saveEditGoalButton.addEventListener('click', async () => {
            const btnText = saveEditGoalButton.querySelector('.btn-text'); const loader = saveEditGoalButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditGoalButton.disabled = true; cancelEditGoalButton.disabled = true;

            const id = document.getElementById('edit-goal-id').value;
            const goalRef = doc(db, "metas", id);
            const dataToUpdate = {
                target: parseInt(document.getElementById('edit-goal-target').value),
                prize: document.getElementById('edit-goal-prize').value,
                icon: document.getElementById('edit-goal-icon').value,
                serviceId: document.getElementById('edit-goal-service-id').value,
            };

            try { 
                await updateDoc(goalRef, dataToUpdate); 
                editGoalModal.classList.add('hidden'); 
                showToast('Meta atualizada!', 'success');
            }
            catch(error) { 
                console.error("Erro ao atualizar meta:", error); 
                showToast('Erro ao atualizar.', 'error');
            }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditGoalButton.disabled = false; cancelEditGoalButton.disabled = false; }
        });
        
        // --- CONFIGURAÇÕES ---
        const changePasswordForm = document.getElementById('change-password-form');
        const agendaSettingsForm = document.getElementById('agenda-settings-form');
        
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const user = auth.currentUser;

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showToast('Senha alterada com sucesso!', 'success');
                changePasswordForm.reset();
            } catch(error) {
                console.error("Erro ao alterar senha:", error);
                showToast('Senha atual incorreta.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
        
        agendaSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser; if (!user) return;
            const submitBtn = agendaSettingsForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const newInterval = parseInt(document.getElementById('agenda-interval').value);
            if (isNaN(newInterval) || newInterval <= 0) {
                 showToast('Por favor, insira um valor válido.', 'error');
                 btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
                 return;
            }
            
            const settingsRef = doc(db, 'configuracoes', user.uid);
            try {
                await setDoc(settingsRef, { agendaInterval: newInterval, updatedAt: serverTimestamp() }, { merge: true });
                agendaState.interval = newInterval;
                showToast('Configurações da agenda salvas!', 'success');
            } catch(error) {
                 console.error("Erro ao salvar configurações:", error);
                 showToast('Erro ao salvar configurações.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
        
        async function loadAgendaSettings(userId) {
            const settingsRef = doc(db, 'configuracoes', userId);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const settings = docSnap.data();
                agendaState.interval = settings.agendaInterval || 30;
                const intervalInput = document.getElementById('agenda-interval');
                if (intervalInput) intervalInput.value = agendaState.interval;
            } else {
                try {
                    await setDoc(settingsRef, { agendaInterval: 30, createdAt: serverTimestamp() });
                } catch(error) { console.error("Erro ao criar doc de config:", error); }
            }
        }

        // --- GESTÃO DE USUÁRIOS DO PAINEL ---
        const addPanelUserForm = document.getElementById('add-panel-user-form');
        const panelUsersListDiv = document.getElementById('panel-users-list');
        const loadingPanelUsersP = document.getElementById('loading-panel-users');
        
        addPanelUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = addPanelUserForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const email = document.getElementById('panel-user-email').value;
            const password = document.getElementById('panel-user-password').value;
            const role = document.getElementById('panel-user-role').value;
            
            try {
                await addDoc(collection(db, "panel_users"), { email: email, role: role, createdAt: serverTimestamp(), gestorId: auth.currentUser.uid });
                showToast(`Convite enviado para ${email}!`, 'success');
                addPanelUserForm.reset();
            } catch (error) {
                console.error("Erro ao convidar usuário:", error);
                showToast('Erro ao convidar usuário.', 'error');
            } finally {
                btnText.classList.remove('hidden');
                loader.classList.remove('hidden');
                submitBtn.disabled = false;
            }
        });
        
        function loadPanelUsers(userId) {
            const q = query(collection(db, "panel_users"), where("gestorId", "==", userId));
            onSnapshot(q, (snapshot) => {
                loadingPanelUsersP.classList.add('hidden');
                panelUsersListDiv.innerHTML = '';
                if(snapshot.empty) {
                    panelUsersListDiv.innerHTML = '<p class="text-sm text-gray-500">Nenhum usuário adicional.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const card = document.createElement('div');
                    card.className = 'flex justify-between items-center bg-[#2a2a2a] p-3 rounded-lg';
                    card.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${user.email}</p>
                            <p class="text-xs text-gray-400 capitalize">${user.role}</p>
                        </div>
                        <button class="text-xs text-red-500 hover:text-red-400 font-semibold" onclick="window.deleteDocument('panel_users', '${doc.id}')">Remover</button>
                    `;
                    panelUsersListDiv.appendChild(card);
                });
            });
        }

        // --- FUNÇÕES GLOBAIS ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationButton = document.getElementById('cancel-confirmation-button');
        const confirmActionButton = document.getElementById('confirm-action-button');
        let confirmationCallback = null;

        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        cancelConfirmationButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        confirmActionButton.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        window.deleteDocument = (collectionName, docId) => {
            const message = `Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.`;
            showConfirmationModal(message, async () => {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    showToast('Item excluído com sucesso!', 'success');
                } catch(e) {
                    console.error("Erro ao deletar:", e);
                    showToast('Erro ao excluir item.', 'error');
                }
            });
        };
        
        // NOVO: Função para exibir notificações (Toasts)
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-exclamation-circle';

            toast.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        // --- LÓGICA DE NAVEGAÇÃO DO MENU LATERAL (ATUALIZADA) ---
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('#sidebar .nav-link');
        const contentPanels = document.querySelectorAll('#main-content main > div > div');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();

                const isCurrentlyActive = link.classList.contains('active');
                const sidebarIsCollapsed = sidebar.classList.contains('collapsed');
                const isSubmenuTrigger = link.classList.contains('has-submenu');
                const targetId = link.dataset.target;

                if (sidebarIsCollapsed) {
                    sidebar.classList.remove('collapsed');
                } else if (isCurrentlyActive && !isSubmenuTrigger) {
                    sidebar.classList.add('collapsed');
                    document.querySelectorAll('#sidebar .submenu.open').forEach(sub => sub.classList.remove('open'));
                    return;
                }

                if (isSubmenuTrigger) {
                    const submenu = link.nextElementSibling;
                    document.querySelectorAll('#sidebar .submenu.open').forEach(sub => {
                        if (sub !== submenu) sub.classList.remove('open');
                    });
                    submenu.classList.toggle('open');
                }
                
                if (targetId) {
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    const parentMenu = link.closest('.submenu');
                    if (parentMenu) {
                        parentMenu.previousElementSibling.classList.add('active');
                    }

                    contentPanels.forEach(panel => panel.classList.add('hidden'));

                    const targetPanel = document.getElementById(targetId);
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                        
                        const user = auth.currentUser;
                        if (!user) return;
                        switch (targetId) {
                            case 'content-dashboard': loadDashboardData(user.uid); break;
                            case 'content-agenda': initializeAgenda(user.uid); break;
                            case 'content-caixa': loadCaixaData(user.uid); break; 
                            case 'content-relatorios': initializeReports(user.uid); break;
                            case 'content-servicos': loadServices(user.uid); break;
                            case 'content-profissionais': loadProfessionals(user.uid); break;
                            case 'content-unidades': loadUnits(user.uid); break;
                            case 'content-planos': loadPlans(user.uid); break;
                            case 'content-metas': loadGoals(user.uid); loadReferralSettings(user.uid); break;
                            case 'content-configuracoes': loadPanelUsers(user.uid); break;
                        }
                    }
                } // Fecha o if(targetId)
            });
        });

// ...

        // --- LÓGICA DO DASHBOARD (VISÃO GERAL) ---
        let unsubscribeDashboard = null;
        async function loadDashboardData(userId) {
            if (localServicesCache.length === 0 || localProfessionalsCache.length === 0 || localClientsCache.length === 0) {
                await populateCaches(userId);
            }

            if (unsubscribeDashboard) unsubscribeDashboard();

            const q = query(
                collection(db, "agendamentos"),
                where("gestorId", "==", userId)
            );

            unsubscribeDashboard = onSnapshot(q, (snapshot) => {
                const startOfDay = new Date();
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date();
                endOfDay.setHours(23, 59, 59, 999);

                let faturacaoDia = 0;
                let agendamentosHoje = 0;
                const clientesAtendidos = new Set();
                const now = new Date();
                const proximosAgendamentos = [];

                const agendamentosDoDia = snapshot.docs.filter(doc => {
                    const data = doc.data().data.toDate();
                    return data >= startOfDay && data <= endOfDay;
                });

                agendamentosDoDia.forEach(doc => {
                    const agendamento = {id: doc.id, ...doc.data()};

                    if (agendamento.status !== 'cancelado' && agendamento.status !== 'bloqueio') {
                        agendamentosHoje++;
                    }
                    if (agendamento.status === 'finalizado' && agendamento.servico?.id) {
                        clientesAtendidos.add(agendamento.cliente.id);
                        const servico = localServicesCache.find(s => s.id === agendamento.servico.id);
                        if (servico) { faturacaoDia += servico.promocao || servico.valor || 0; }
                    }

                    const apptDate = agendamento.data.toDate();
                    if (apptDate >= now && agendamento.status !== 'finalizado' && agendamento.status !== 'cancelado' && agendamento.status !== 'bloqueio') {
                        proximosAgendamentos.push(agendamento);
                    }
                });

                document.getElementById('kpi-faturacao').textContent = `R$ ${faturacaoDia.toFixed(2).replace('.', ',')}`;
                document.getElementById('kpi-agendamentos').textContent = agendamentosHoje;
                document.getElementById('kpi-clientes').textContent = clientesAtendidos.size;

                renderProximosAgendamentos(proximosAgendamentos);
                
                renderAniversariantes();

            }, (error) => {
                console.error("Erro ao carregar dados do dashboard:", error);
                showToast('Erro ao carregar dados do dashboard.', 'error');
            });
        }
        
        // --- LÓGICA DA FRENTE DE CAIXA ---
        let unsubscribeCaixa = null;
        function loadCaixaData(userId) {
            if (unsubscribeCaixa) unsubscribeCaixa();
            
            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);

            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);

            const q = query(
                collection(db, "agendamentos"),
                where("gestorId", "==", userId),
                where("status", "==", "finalizado")
            );

            const caixaListBody = document.getElementById('caixa-list');
            const loadingRow = document.getElementById('loading-caixa');

            unsubscribeCaixa = onSnapshot(q, (snapshot) => {
                caixaListBody.innerHTML = ''; 

                const comandasDoDia = snapshot.docs.filter(doc => {
                    const data = doc.data().data.toDate();
                    return data >= startOfDay && data <= endOfDay;
                });

                if (comandasDoDia.length === 0) {
                    caixaListBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhum serviço finalizado hoje.</td></tr>';
                    return;
                }

                comandasDoDia.forEach(doc => {
                    const comanda = doc.data();
                    const valor = comanda.valorServico || 0;
                    const statusPagamento = comanda.pagamentoStatus || 'Pendente';
                    
                    let statusClass = 'text-yellow-400';
                    if (statusPagamento === 'Pago') {
                        statusClass = 'text-green-400';
                    } else if (statusPagamento === 'Cancelado') {
                         statusClass = 'text-red-500';
                    }

                    const row = `
                        <tr class="bg-[#2a2a2a] border-b border-gray-700">
                            <td class="px-6 py-4 font-medium text-white">${comanda.cliente.nome}</td>
                            <td class="px-6 py-4">${comanda.servico.nome}</td>
                            <td class="px-6 py-4">${comanda.barbeiro.nome}</td>
                            <td class="px-6 py-4 font-semibold">R$ ${valor.toFixed(2).replace('.', ',')}</td>
                            <td class="px-6 py-4 font-bold ${statusClass}">${statusPagamento}</td>
                            <td class="px-6 py-4">
                                <button data-id="${doc.id}" class="btn-primary !px-3 !py-1.5 text-xs" ${statusPagamento !== 'Pendente' ? 'disabled' : ''}>
                                    <i class="fas fa-cash-register mr-1"></i> Lançar Pagamento
                                </button>
                            </td>
                        </tr>
                    `;
                    caixaListBody.innerHTML += row;
                });

                caixaListBody.querySelectorAll('button[data-id]').forEach(button => {
                    button.addEventListener('click', () => {
                        openPaymentModal(button.dataset.id);
                    });
                });

            }, (error) => {
                console.error("Erro ao carregar dados da frente de caixa:", error);
                showToast('Erro ao carregar dados da frente de caixa.', 'error');
            });
        }

        // --- LÓGICA DO MODAL DE PAGAMENTO ---
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentModalBtn = document.getElementById('close-payment-modal');
        const paymentForm = document.getElementById('payment-form');
        const confirmPaymentBtn = document.getElementById('confirm-payment-button');
        
        let currentSaleData = {};

        async function openPaymentModal(appointmentId) {
            paymentForm.reset();
            document.getElementById('payment-cash-section').style.display = 'block';

            const appointmentDoc = await getDoc(doc(db, "agendamentos", appointmentId));
            if (!appointmentDoc.exists()) {
                showToast("Agendamento não encontrado!", 'error');
                return;
            }
            const appointment = { id: appointmentDoc.id, ...appointmentDoc.data() };

            const clientDoc = await getDoc(doc(db, "users", appointment.cliente.id));
            const client = clientDoc.exists() ? { id: clientDoc.id, ...clientDoc.data() } : null;

            currentSaleData = {
                appointment,
                client,
                originalValue: appointment.valorServico || 0,
            };

            document.getElementById('payment-subtitle').textContent = `Cliente: ${appointment.cliente.nome}`;
            document.getElementById('payment-summary-service').textContent = appointment.servico.nome;
            document.getElementById('payment-summary-value').textContent = `R$ ${currentSaleData.originalValue.toFixed(2).replace('.', ',')}`;
            
            const creditsSection = document.getElementById('payment-credits-section');
            if (client && client.referralCredits > 0) {
                document.getElementById('payment-credits-label').textContent = `Usar R$ ${client.referralCredits.toFixed(2).replace('.', ',')} de crédito?`;
                creditsSection.classList.remove('hidden');
            } else {
                creditsSection.classList.add('hidden');
            }

            document.getElementById('payment-appointment-id').value = appointmentId;
            document.getElementById('payment-client-id').value = client ? client.id : '';

            updateTotal();
            paymentModal.classList.remove('hidden');
        }
        
        function updateTotal() {
            let total = currentSaleData.originalValue;
            
            const discount = parseFloat(document.getElementById('payment-discount').value) || 0;
            total -= discount;

            const useCredits = document.getElementById('payment-use-credits').checked;
            if (useCredits && currentSaleData.client) {
                total -= currentSaleData.client.referralCredits;
            }
            total = Math.max(0, total);
            
            document.getElementById('payment-summary-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

            const cashPaid = parseFloat(document.getElementById('payment-cash-paid').value) || 0;
            const change = cashPaid > total ? cashPaid - total : 0;
            document.getElementById('payment-change').textContent = `R$ ${change.toFixed(2).replace('.', ',')}`;
        }
        
        ['payment-discount', 'payment-use-credits', 'payment-cash-paid'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateTotal);
        });
        document.getElementById('payment-method').addEventListener('change', (e) => {
            document.getElementById('payment-cash-section').style.display = e.target.value === 'Dinheiro' ? 'block' : 'none';
            updateTotal();
        });


        closePaymentModalBtn.addEventListener('click', () => paymentModal.classList.add('hidden'));

        confirmPaymentBtn.addEventListener('click', async () => {
            const btn = confirmPaymentBtn;
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;
            
            try {
                const appointmentId = document.getElementById('payment-appointment-id').value;
                const clientId = document.getElementById('payment-client-id').value;

                let total = currentSaleData.originalValue;
                const discount = parseFloat(document.getElementById('payment-discount').value) || 0;
                total -= discount;

                let creditsUsed = 0;
                const useCredits = document.getElementById('payment-use-credits').checked;
                if (useCredits && currentSaleData.client) {
                    creditsUsed = Math.min(total, currentSaleData.client.referralCredits);
                    total -= creditsUsed;
                }
                 total = Math.max(0, total);

                const dataToUpdate = {
                    pagamentoStatus: 'Pago',
                    metodoPagamento: document.getElementById('payment-method').value,
                    valorFinal: total,
                    desconto: discount,
                    creditosUsados: creditsUsed,
                    dataPagamento: serverTimestamp()
                };
                
                const settingsRef = doc(db, 'configuracoes', auth.currentUser.uid);
                const settingsSnap = await getDoc(settingsRef);
                const referralCreditValue = settingsSnap.exists() ? (settingsSnap.data().referralCreditValue || 0) : 0;
                
                if (referralCreditValue > 0 && currentSaleData.client && !currentSaleData.client.firstServiceCompleted && currentSaleData.client.referrer?.id) {
                    
                    const referrerRef = doc(db, "users", currentSaleData.client.referrer.id);
                    const referrerSnap = await getDoc(referrerRef);
                    
                    if(referrerSnap.exists()) {
                        const referrerData = referrerSnap.data();
                        const newCredits = (referrerData.referralCredits || 0) + referralCreditValue;
                        const batch = writeBatch(db);
                        batch.update(referrerRef, { referralCredits: newCredits });
                        batch.update(doc(db, "users", clientId), { firstServiceCompleted: true });
                        await batch.commit();
                        showToast(`${referrerData.name} ganhou R$${referralCreditValue.toFixed(2)} em créditos!`, 'info');
                    }
                }

                await updateDoc(doc(db, "agendamentos", appointmentId), dataToUpdate);

                if (creditsUsed > 0 && clientId) {
                    const newCreditBalance = currentSaleData.client.referralCredits - creditsUsed;
                    await updateDoc(doc(db, "users", clientId), { referralCredits: newCreditBalance });
                }

                paymentModal.classList.add('hidden');
                showToast('Pagamento confirmado!', 'success');
                
            } catch (error) {
                console.error("Erro ao confirmar pagamento:", error);
                showToast('Erro ao salvar pagamento.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });


        function renderProximosAgendamentos(proximosAgendamentos) {
            proximosAgendamentos.sort((a, b) => a.data.toDate() - b.data.toDate());
            const listContainer = document.getElementById('proximos-agendamentos-list');
            listContainer.innerHTML = '';

            if (proximosAgendamentos.length === 0) {
                listContainer.innerHTML = '<div class="bg-[#2a2a2a] p-4 rounded-lg text-center text-gray-500">Nenhum agendamento futuro para hoje.</div>';
            } else {
                proximosAgendamentos.slice(0, 5).forEach(appt => {
                    const apptDate = appt.data.toDate();
                    const timeStr = apptDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const professional = localProfessionalsCache.find(p => p.id === appt.barbeiro.id) || appt.barbeiro;
                    const placeholderImg = `https://placehold.co/40x40/333333/FFFFFF?text=${professional.nome.charAt(0)}`;
                    listContainer.innerHTML += `
                        <div class="bg-[#2a2a2a] p-3 rounded-lg flex items-center justify-between transition-all hover:bg-[#333]">
                            <div class="flex items-center space-x-3">
                                <img src="${professional.imgUrl || placeholderImg}" alt="${professional.nome}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                <div>
                                    <p class="font-semibold text-white">${appt.cliente.nome}</p>
                                    <p class="text-xs text-gray-400">${appt.servico.nome}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                 <p class="font-bold text-lg text-primary">${timeStr}</p>
                                 <p class="text-xs text-gray-500">com ${professional.nome.split(' ')[0]}</p>
                            </div>
                        </div>`;
                });
            }
        }

        function renderAniversariantes() {
            const listContainer = document.getElementById('aniversariantes-list');
            listContainer.innerHTML = '';
            const today = new Date();
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();

            const aniversariantesDoDia = localClientsCache.filter(client => {
                if (!client.birthDate || typeof client.birthDate !== 'string') return false;
                
                const parts = client.birthDate.split('-');
                if (parts.length !== 3) return false;
                
                const birthMonth = parseInt(parts[1], 10);
                const birthDay = parseInt(parts[2], 10);

                return birthMonth === todayMonth && birthDay === todayDay;
            });

            if (aniversariantesDoDia.length === 0) {
                listContainer.innerHTML = '<div class="bg-[#2a2a2a] p-4 rounded-lg text-center text-gray-500">Nenhum aniversariante hoje.</div>';
            } else {
                aniversariantesDoDia.forEach(client => {
                    const placeholderImg = `https://placehold.co/40x40/333333/FFFFFF?text=${client.name.charAt(0)}`;
                    listContainer.innerHTML += `
                        <div class="bg-[#2a2a2a] p-3 rounded-lg flex items-center justify-between transition-all hover:bg-[#333]">
                            <div class="flex items-center space-x-3">
                                <img src="${client.profilePic || placeholderImg}" alt="${client.name}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                <div>
                                    <p class="font-semibold text-white">${client.name}</p>
                                    <p class="text-xs text-gray-400">${client.phone || 'Sem telefone'}</p>
                                </div>
                            </div>
                            <div class="text-right text-primary">
                                 <i class="fas fa-birthday-cake fa-lg"></i>
                            </div>
                        </div>`;
                });
            }
        }

        // --- LÓGICA DOS MODAIS DA AGENDA (RESTABELECIDA) ---
        const slotActionModal = document.getElementById('slot-action-modal');
        const closeSlotActionModalBtn = document.getElementById('close-slot-action-modal');
        const slotTabAgendar = document.getElementById('slot-tab-agendar');
        const slotTabBloqueio = document.getElementById('slot-tab-bloqueio');
        const slotContentAgendar = document.getElementById('slot-content-agendar');
        const slotContentBloqueio = document.getElementById('slot-content-bloqueio');
        const slotAppointmentForm = document.getElementById('slot-appointment-form');
        const slotBlockForm = document.getElementById('slot-block-form');
        const editAppointmentModal = document.getElementById('edit-appointment-modal');
        const closeEditAppointmentModalBtn = document.getElementById('close-edit-appointment-modal');
        const saveEditAppointmentBtn = document.getElementById('save-edit-appointment-button');
        const deleteAppointmentBtn = document.getElementById('delete-appointment-button');
        const whatsappReminderBtn = document.getElementById('whatsapp-reminder-button');
        const editBlockModal = document.getElementById('edit-block-modal');
        const closeEditBlockModalBtn = document.getElementById('close-edit-block-modal');
        const saveEditBlockBtn = document.getElementById('save-edit-block-button');
        const deleteBlockBtn = document.getElementById('delete-block-button');
        const quickClientModal = document.getElementById('add-quick-client-modal');
        const cancelQuickClientBtn = document.getElementById('cancel-quick-client-button');
        const saveQuickClientBtn = document.getElementById('save-quick-client-button');

        closeSlotActionModalBtn.addEventListener('click', () => slotActionModal.classList.add('hidden'));

        slotTabAgendar.addEventListener('click', () => {
            slotTabAgendar.classList.add('active'); slotTabBloqueio.classList.remove('active');
            slotContentAgendar.classList.remove('hidden'); slotContentBloqueio.classList.add('hidden');
        });
        slotTabBloqueio.addEventListener('click', () => {
            slotTabBloqueio.classList.add('active'); slotTabAgendar.classList.remove('active');
            slotContentBloqueio.classList.remove('hidden'); slotContentAgendar.classList.add('hidden');
        });
        document.getElementById('slot-recurring-checkbox').addEventListener('change', (e) => {
            document.getElementById('slot-recurring-options').classList.toggle('hidden', !e.target.checked);
        });
        
        slotAppointmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-slot-appointment-button');
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;

            try {
                const professionalId = document.getElementById('slot-professional-id').value;
                const baseDateTime = new Date(document.getElementById('slot-datetime').value);
                const clientId = document.getElementById('slot-client-select').value;
                const serviceId = document.getElementById('slot-service-select').value;
                const isRecurring = document.getElementById('slot-recurring-checkbox').checked;

                const client = localClientsCache.find(c => c.id === clientId);
                const professional = localProfessionalsCache.find(p => p.id === professionalId);
                const service = localServicesCache.find(s => s.id === serviceId);

                if (!client || !professional || !service) {
                    throw new Error("Cliente, profissional ou serviço inválido.");
                }

                if (isRecurring) {
                    const frequency = parseInt(document.getElementById('slot-recurring-frequency').value) || 1;
                    const period = document.getElementById('slot-recurring-period').value;
                    const count = parseInt(document.getElementById('slot-recurring-count').value) || 4;
                    const batch = writeBatch(db);

                    for (let i = 0; i < count; i++) {
                        let newDate = new Date(baseDateTime);
                        if (period === 'weeks') {
                            newDate.setDate(newDate.getDate() + (i * frequency * 7));
                        } else if (period === 'months') {
                            newDate.setMonth(newDate.getMonth() + (i * frequency));
                        }
                        const newDocRef = doc(collection(db, "agendamentos"));
                        batch.set(newDocRef, {
                            cliente: { id: client.id, nome: client.name },
                            barbeiro: { id: professional.id, nome: professional.nome },
                            servico: { id: service.id, nome: service.nome, duracaoMinutos: service.duracaoMinutos },
                            data: newDate,
                            status: 'agendado',
                            gestorId: auth.currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                    }
                    await batch.commit();
                    showToast(`${count} agendamentos recorrentes criados!`, 'success');

                } else {
                    await addDoc(collection(db, "agendamentos"), {
                        cliente: { id: client.id, nome: client.name },
                        barbeiro: { id: professional.id, nome: professional.nome },
                        servico: { id: service.id, nome: service.nome, duracaoMinutos: service.duracaoMinutos },
                        data: baseDateTime,
                        status: 'agendado',
                        gestorId: auth.currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    showToast('Agendamento criado com sucesso!', 'success');
                }
                
                slotActionModal.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao agendar:", error);
                showToast('Erro ao salvar agendamento.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });

        slotBlockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-slot-block-button');
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;

            try {
                const professionalId = document.getElementById('slot-professional-id').value;
                const dateTime = new Date(document.getElementById('slot-datetime').value);
                const reason = document.getElementById('slot-block-reason').value;
                const duration = parseInt(document.getElementById('slot-block-duration').value);
                const professional = localProfessionalsCache.find(p => p.id === professionalId);

                await addDoc(collection(db, "agendamentos"), {
                    barbeiro: { id: professional.id, nome: professional.nome },
                    data: dateTime,
                    status: 'bloqueio',
                    motivo: reason,
                    duracaoMinutos: duration,
                    gestorId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                slotActionModal.classList.add('hidden');
                showToast('Horário bloqueado com sucesso!', 'info');
            } catch (error) {
                console.error("Erro ao bloquear horário:", error);
                showToast('Erro ao salvar bloqueio.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });
        
        // Modais de Edição
        closeEditAppointmentModalBtn.addEventListener('click', () => editAppointmentModal.classList.add('hidden'));
        saveEditAppointmentBtn.addEventListener('click', async () => {
            const btn = saveEditAppointmentBtn;
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;
            
            try {
                const appointmentId = document.getElementById('edit-appointment-id').value;
                const newStatus = document.getElementById('edit-appt-status').value;
                const newDateTime = new Date(document.getElementById('edit-appt-datetime').value);
                
                const dataToUpdate = {
                    status: newStatus,
                    data: newDateTime
                };

                if (newStatus === 'finalizado') {
                    const appointmentDoc = await getDoc(doc(db, "agendamentos", appointmentId));
                    if (appointmentDoc.exists()) {
                        const appointmentData = appointmentDoc.data();
                        const professional = localProfessionalsCache.find(p => p.id === appointmentData.barbeiro.id);
                        const service = localServicesCache.find(s => s.id === appointmentData.servico.id);

                        if (professional && service) {
                            const serviceValue = service.promocao || service.valor;
                            const commissionRate = (professional.comissaoServicos || 0) / 100;
                            dataToUpdate.valorServico = serviceValue;
                            dataToUpdate.valorComissao = serviceValue * commissionRate;
                        }
                    }
                }
                
                await updateDoc(doc(db, "agendamentos", appointmentId), dataToUpdate);
                editAppointmentModal.classList.add('hidden');
                showToast('Agendamento atualizado!', 'success');
            } catch (error) {
                 console.error("Erro ao atualizar agendamento:", error);
                 showToast('Erro ao salvar.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });
        deleteAppointmentBtn.addEventListener('click', () => {
            const appointmentId = document.getElementById('edit-appointment-id').value;
            window.deleteDocument('agendamentos', appointmentId);
            editAppointmentModal.classList.add('hidden');
        });
        
        whatsappReminderBtn.addEventListener('click', () => {
            const appointmentId = document.getElementById('edit-appointment-id').value;
            const appt = agendaState.appointments.find(a => a.id === appointmentId);

            if (!appt || !appt.cliente.nome) return;
            
            const client = localClientsCache.find(c => c.id === appt.cliente.id);
            if (!client || !client.phone) {
                showToast('Este cliente não tem um telefone cadastrado.', 'error');
                return;
            }
            const dateStr = appt.data.toDate().toLocaleDateString('pt-BR');
            const timeStr = appt.data.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            const message = `Olá, ${appt.cliente.nome}! Passando para lembrar do seu agendamento na VS Barbearia no dia ${dateStr} às ${timeStr}h. Confirma sua presença?`;
            const whatsappUrl = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });
        
        // Modais de Bloqueio
        closeEditBlockModalBtn.addEventListener('click', () => editBlockModal.classList.add('hidden'));
        saveEditBlockBtn.addEventListener('click', async () => {
             const btn = saveEditBlockBtn;
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;
            try {
                const blockId = document.getElementById('edit-block-id').value;
                await updateDoc(doc(db, "agendamentos", blockId), {
                    motivo: document.getElementById('edit-block-reason').value,
                    duracaoMinutos: parseInt(document.getElementById('edit-block-duration').value)
                });
                editBlockModal.classList.add('hidden');
                showToast('Bloqueio atualizado!', 'info');
            } catch (error) {
                console.error("Erro ao salvar bloqueio:", error);
                showToast('Erro ao salvar.', 'error');
            } finally {
                 btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });
        deleteBlockBtn.addEventListener('click', () => {
            const blockId = document.getElementById('edit-block-id').value;
            window.deleteDocument('agendamentos', blockId);
            editBlockModal.classList.add('hidden');
        });
        
        // Modal de Cadastro Rápido de Cliente
        document.getElementById('open-quick-client-modal-btn').addEventListener('click', () => quickClientModal.classList.remove('hidden'));
        cancelQuickClientBtn.addEventListener('click', () => quickClientModal.classList.add('hidden'));
        document.getElementById('add-quick-client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = saveQuickClientBtn;
            const btnText = btn.querySelector('.btn-text'); const loader = btn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); btn.disabled = true;

            try {
                const newClient = {
                    name: document.getElementById('quick-client-name').value,
                    phone: document.getElementById('quick-client-phone').value,
                    gestorId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, "users"), newClient);
                const clientForCache = { id: docRef.id, ...newClient };
                localClientsCache.push(clientForCache);
                
                const clientSelect = document.getElementById('slot-client-select');
                clientSelect.innerHTML += `<option value="${docRef.id}" selected>${newClient.name}</option>`;
                
                quickClientModal.classList.add('hidden');
                showToast('Cliente cadastrado com rapidez!', 'success');
            } catch (error) {
                console.error("Erro no cadastro rápido:", error);
                showToast('Erro ao salvar cliente.', 'error');
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); btn.disabled = false;
            }
        });

        // --- LÓGICA DE ARRASTAR E SOLTAR (DRAG AND DROP) ---
        function makeDraggable(element) {
            interact(element)
                .draggable({
                    inertia: true,
                    listeners: {
                        start(event) {
                            isDragging = true;
                            event.target.classList.add('dragging');
                        },
                        move(event) {
                            const target = event.target;
                            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                            target.style.transform = `translate(${x}px, ${y}px)`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        },
                        end(event) {
                            const target = event.target;
                            target.classList.remove('dragging');
                            target.style.transform = '';
                            target.removeAttribute('data-x');
                            target.removeAttribute('data-y');

                            setTimeout(() => { isDragging = false; }, 100);
                        }
                    }
                })
                .resizable(false);
        }
        
        function initializeDropzones() {
            interact('.professional-column').dropzone({
                accept: '.appointment-card',
                overlap: 0.25,

                ondrop: function (event) {
                    const dropzone = event.target;
                    const draggableElement = event.relatedTarget;

                    const rect = dropzone.querySelector('div:not(.professional-header)').getBoundingClientRect();
                    const newTop = event.dragEvent.clientY - rect.top;
                                    
                    const slotHeight = 40;
                    const slotIndex = Math.round(newTop / slotHeight);
                    const minutesFromStart = slotIndex * agendaState.interval;
                    
                    const startHour = 8;
                    const newHour = startHour + Math.floor(minutesFromStart / 60);
                    const newMinute = minutesFromStart % 60;

                    const newDateTime = new Date(agendaState.currentDate);
                    newDateTime.setHours(newHour, newMinute, 0, 0);

                    const newProfessionalId = dropzone.dataset.professionalId;
                    const appointmentId = draggableElement.dataset.id;
                    
                    updateAppointmentOnDrop(appointmentId, newDateTime, newProfessionalId);
                },

                ondragenter: (event) => { event.target.classList.add('drop-target'); },
                ondragleave: (event) => { event.target.classList.remove('drop-target'); },
                ondropactivate: (event) => { event.target.classList.add('drop-active'); },
                ondropdeactivate: (event) => {
                    event.target.classList.remove('drop-active');
                    event.target.classList.remove('drop-target');
                }
            });
        }

        async function updateAppointmentOnDrop(appointmentId, newDateTime, newProfessionalId) {
            try {
                const professional = localProfessionalsCache.find(p => p.id === newProfessionalId);
                if (!professional) throw new Error("Profissional não encontrado");

                await updateDoc(doc(db, "agendamentos", appointmentId), {
                    data: newDateTime,
                    barbeiro: { id: professional.id, nome: professional.nome }
                });
                showToast('Agendamento reagendado!', 'info');
            } catch (error) {
                console.error("Erro ao atualizar agendamento após arrastar:", error);
                showToast('Não foi possível reagendar.', 'error');
            }
        }
    </script>
</body>
</html>





