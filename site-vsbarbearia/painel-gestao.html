<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - VS Barbearia</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #111111;
            color: #e0e0e0;
        }
        .hidden { display: none; }
        
        /* Estilo das Abas */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #fbb62c;
            color: #fbb62c;
        }
        
        /* Estilos dos Formulários */
        .form-input, .form-textarea, .form-select {
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #fbb62c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(251, 182, 44, 0.5);
        }
        
        /* Estilos dos Botões */
        .btn-primary {
            background-color: #fbb62c;
            color: #111111;
            font-weight: 700;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #e0a828;
        }
        .btn-primary:disabled {
            background-color: #4a4a4a;
            color: #888;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #333;
            border: 1px solid #555;
            color: #f0f0f0;
            font-weight: 600;
             border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #444;
        }

        /* Estilos do Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #1e1e1e;
            border-top: 2px solid #fbb62c;
        }

        /* Animação de Spinner/Loader */
        .loader {
            border: 3px solid #444;
            border-top: 3px solid #fbb62c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ESTILOS DA AGENDA --- */
        #agenda-container {
            overflow-x: auto;
        }
        .agenda-grid {
            display: flex;
            min-width: 800px;
        }
        .time-column {
            flex: 0 0 70px;
        }
        .professional-column {
            flex: 1 1 0px;
            border-left: 1px solid #444;
            position: relative;
        }
        .time-slot, .professional-header {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #aaa;
        }
        .professional-header {
            font-weight: 600;
            color: #fff;
            border-bottom: 1px solid #444;
        }
        .time-slot-line {
            height: 40px;
            border-bottom: 1px solid #333;
            box-sizing: border-box;
        }
        .appointment-card {
            position: absolute;
            left: 5px;
            right: 5px;
            background-color: #005c99; /* Agendado */
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            color: white;
            overflow: hidden;
            box-sizing: border-box;
            border-left: 3px solid #00bfff;
            z-index: 10;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .appointment-card:hover {
            opacity: 0.9;
        }
        /* Cores por Status */
        .appointment-card.status-confirmado {
            background-color: #166534; /* green-800 */
            border-left-color: #22c55e; /* green-500 */
        }
        .appointment-card.status-finalizado {
            background-color: #4b5563; /* gray-600 */
            border-left-color: #9ca3af; /* gray-400 */
        }
        .appointment-card.status-cancelado {
            background-color: #991b1b; /* red-800 */
            border-left-color: #ef4444; /* red-500 */
        }

        .appointment-card p {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="h-full">

    <!-- Seção de Login e Cadastro (Visível quando deslogado) -->
    <div id="auth-section" class="flex min-h-full flex-col justify-center px-6 py-12 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-sm text-center">
            <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-20 h-20 mx-auto mb-4">
            <h2 class="text-2xl font-bold leading-9 tracking-tight text-white">Acesse seu painel</h2>
        </div>
        <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
            <div class="space-y-6">
                <input id="email" name="email" type="email" autocomplete="email" required placeholder="E-mail" class="block w-full form-input">
                <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="Senha" class="block w-full form-input">
                <p id="auth-error" class="text-center text-sm text-red-500"></p>
                <button id="login-button" class="w-full justify-center btn-primary">Entrar</button>
                <button id="signup-button" class="w-full justify-center btn-secondary">Não tenho conta, Cadastrar</button>
            </div>
        </div>
    </div>

    <!-- Painel Principal (Visível quando logado) -->
    <div id="panel-section" class="hidden">
        <header class="bg-[#1e1e1e] shadow-lg">
            <div class="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                     <img src="https://i.postimg.cc/5yBSjg1F/Bigode-3.png" alt="Logo VS Barbearia" class="w-10 h-10">
                    <h1 class="text-2xl font-bold tracking-tight text-white">Painel de Gestão</h1>
                </div>
                <div class="flex items-center">
                    <span id="user-email" class="text-sm text-gray-400 mr-4 hidden sm:block"></span>
                    <button id="logout-button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Sair</button>
                </div>
            </div>
        </header>
        <main>
            <!-- Abas de Navegação -->
            <div class="border-b border-gray-800 bg-[#1e1e1e]">
                <nav class="-mb-px flex space-x-8 mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 overflow-x-auto" aria-label="Tabs">
                    <button id="tab-servicos" class="tab-button active whitespace-nowrap py-4 px-1 text-sm font-medium">Serviços</button>
                    <button id="tab-profissionais" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Profissionais</button>
                    <button id="tab-unidades" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Unidades</button>
                    <button id="tab-agenda" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Agenda</button>
                    <button id="tab-clientes" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Clientes</button>
                    <button id="tab-planos" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Planos</button>
                    <button id="tab-metas" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Metas</button>
                    <button id="tab-configuracoes" class="tab-button whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-200">Configurações</button>
                </nav>
            </div>

            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <!-- Conteúdo da Aba Serviços -->
                <div id="content-servicos">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Novo Serviço</h3>
                            <form id="add-service-form" class="space-y-4">
                                <input type="text" id="service-name" required placeholder="Nome do Serviço" class="form-input w-full">
                                <input type="number" id="service-value" step="0.01" required placeholder="Valor (R$)" class="form-input w-full">
                                <input type="number" id="service-promo-value" step="0.01" placeholder="Valor Promocional (Opcional)" class="form-input w-full">
                                <input type="number" id="service-duration" required placeholder="Duração (minutos)" class="form-input w-full">
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Serviço</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Serviços Cadastrados</h3>
                            <div id="services-list" class="space-y-4">
                                <p id="loading-services" class="text-gray-400">Carregando serviços...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo da Aba Profissionais (inicialmente escondido) -->
                <div id="content-profissionais" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Profissional</h3>
                            <form id="add-professional-form" class="space-y-4">
                                <input type="text" id="professional-name" required placeholder="Nome do Profissional" class="form-input w-full">
                                <input type="text" id="professional-function" required placeholder="Função (ex: Barbeiro)" class="form-input w-full">
                                <input type="url" id="professional-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                                <input type="number" id="professional-commission-services" step="1" min="0" max="100" placeholder="Comissão Serviços (%)" class="form-input w-full">
                                <input type="number" id="professional-commission-products" step="1" min="0" max="100" placeholder="Comissão Produtos (%)" class="form-input w-full">
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Profissional</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Profissionais Cadastrados</h3>
                            <div id="professionals-list" class="space-y-4">
                                <p id="loading-professionals" class="text-gray-400">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo da Aba Unidades (inicialmente escondido) -->
                <div id="content-unidades" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Unidade</h3>
                            <form id="add-unit-form" class="space-y-4">
                                <input type="text" id="unit-name" required placeholder="Nome da Unidade" class="form-input w-full">
                                <input type="text" id="unit-address" required placeholder="Endereço" class="form-input w-full">
                                <input type="url" id="unit-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                                <input type="url" id="unit-maps" placeholder="Link do Google Maps (Opcional)" class="form-input w-full">
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Unidade</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Unidades Cadastradas</h3>
                            <div id="units-list" class="space-y-4">
                                <p id="loading-units" class="text-gray-400">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conteúdo da Aba Agenda -->
                <div id="content-agenda" class="hidden">
                    <div class="bg-[#1e1e1e] p-4 sm:p-6 rounded-lg border border-gray-800">
                        <!-- Cabeçalho da Agenda -->
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h3 id="agenda-title" class="text-lg font-bold text-primary">Agenda</h3>
                            <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
                                <select id="professional-filter" class="form-select !p-2">
                                    <option value="all">Todos Profissionais</option>
                                </select>
                                <button id="prev-day-btn" class="btn-secondary px-3 py-2"><i class="fas fa-chevron-left"></i></button>
                                <input type="date" id="date-picker" class="form-input !p-2 text-center">
                                <button id="next-day-btn" class="btn-secondary px-3 py-2"><i class="fas fa-chevron-right"></i></button>
                                <button id="add-appointment-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Agendamento</button>
                            </div>
                        </div>
                        <!-- Container da Grade da Agenda -->
                        <div id="agenda-container">
                             <div id="loading-agenda" class="text-center p-8">
                                <p class="text-gray-400">Carregando agenda...</p>
                                <div class="loader mx-auto mt-4" style="width: 30px; height: 30px;"></div>
                            </div>
                            <div id="agenda-grid-view" class="hidden">
                                <!-- A grade será gerada pelo JavaScript aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo da Aba Clientes (inicialmente escondido) -->
                <div id="content-clientes" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Novo Cliente</h3>
                            <form id="add-client-form" class="space-y-4">
                                <input type="text" id="client-name" required placeholder="Nome do Cliente" class="form-input w-full">
                                <input type="tel" id="client-phone" required placeholder="Telefone" class="form-input w-full">
                                <input type="email" id="client-email" placeholder="E-mail (Opcional)" class="form-input w-full">
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Cliente</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Clientes Cadastrados</h3>
                            <div id="clients-list" class="space-y-4">
                                <p id="loading-clients" class="text-gray-400">Carregando clientes...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conteúdo da Aba Planos (inicialmente escondido) -->
                <div id="content-planos" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Novo Plano</h3>
                            <form id="add-plan-form" class="space-y-4">
                                <input type="text" id="plan-title" required placeholder="Título do Plano" class="form-input w-full">
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" id="plan-price" required placeholder="Preço (ex: 129,90)" class="form-input w-full">
                                    <input type="text" id="plan-period" required placeholder="Período (ex: /mês)" class="form-input w-full">
                                </div>
                                <textarea id="plan-features" required placeholder="Características (uma por linha)" rows="4" class="form-textarea w-full"></textarea>
                                <div class="flex items-center">
                                    <input id="plan-popular" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                                    <label for="plan-popular" class="ml-2 block text-sm text-gray-300">Marcar como "Mais Popular"?</label>
                                </div>
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Plano</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Planos Cadastrados</h3>
                            <div id="plans-list" class="space-y-4">
                                <p id="loading-plans" class="text-gray-400">Carregando planos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Conteúdo da Aba Metas (inicialmente escondido) -->
                <div id="content-metas" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Adicionar Nova Meta</h3>
                            <form id="add-goal-form" class="space-y-4">
                                <input type="number" id="goal-target" required placeholder="Nº de Indicações (ex: 5)" class="form-input w-full">
                                <input type="text" id="goal-prize" required placeholder="Prêmio (ex: Hidratação Grátis)" class="form-input w-full">
                                <input type="text" id="goal-icon" required placeholder="Ícone (ex: fas fa-tint)" class="form-input w-full">
                                <select id="goal-service-id" class="form-select w-full">
                                    <option value="">Prêmio sem serviço vinculado</option>
                                    <!-- Opções de serviços serão populadas aqui -->
                                </select>
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Salvar Meta</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Metas Cadastradas</h3>
                            <div id="goals-list" class="space-y-4">
                                <p id="loading-goals" class="text-gray-400">Carregando metas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Conteúdo da Aba Configurações -->
                <div id="content-configuracoes" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Seção Minha Conta -->
                        <div class="bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Minha Conta</h3>
                            <form id="change-password-form" class="space-y-4">
                                <p class="text-sm text-gray-400">Altere sua senha de acesso ao painel.</p>
                                <input type="password" id="current-password" required placeholder="Senha Atual" class="form-input w-full">
                                <input type="password" id="new-password" required placeholder="Nova Senha" class="form-input w-full">
                                <p id="change-password-feedback" class="text-sm h-4"></p>
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Alterar Senha</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Seção Usuários do Painel -->
                        <div class="bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                            <h3 class="text-lg font-bold text-primary mb-4">Usuários do Painel</h3>
                            <form id="add-panel-user-form" class="space-y-4">
                                <input type="email" id="panel-user-email" required placeholder="Email do novo usuário" class="form-input w-full">
                                <input type="password" id="panel-user-password" required placeholder="Senha provisória" class="form-input w-full">
                                <select id="panel-user-role" class="form-select w-full">
                                    <option value="gestor">Gestor</option>
                                    <option value="profissional">Profissional</option>
                                </select>
                                <p class="text-xs text-gray-500">O novo usuário deverá alterar esta senha no primeiro acesso.</p>
                                <p id="add-user-feedback" class="text-sm h-4"></p>
                                <button type="submit" class="w-full justify-center btn-primary">
                                    <span class="btn-text">Criar Usuário</span>
                                    <div class="loader hidden"></div>
                                </button>
                            </form>
                            <div class="mt-6 pt-4 border-t border-gray-700">
                                <h4 class="text-md font-bold text-primary mb-4">Usuários Ativos</h4>
                                <div id="panel-users-list" class="space-y-3">
                                   <p id="loading-panel-users">Carregando...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Seção Configurações da Agenda -->
                        <div class="md:col-span-2 bg-[#1e1e1e] p-6 rounded-lg border border-gray-800">
                             <h3 class="text-lg font-bold text-primary mb-4">Configurações da Agenda</h3>
                             <form id="agenda-settings-form" class="space-y-4">
                                <label for="agenda-interval" class="block text-sm font-medium text-gray-300">Intervalo padrão dos serviços (minutos)</label>
                                <input type="number" id="agenda-interval" value="30" class="form-input w-full max-w-xs" placeholder="Ex: 30">
                                <p class="text-xs text-gray-500">Este valor define a grade de horários da agenda. Agendamentos com durações diferentes irão se ajustar.</p>
                                <p id="agenda-settings-feedback" class="text-sm h-4"></p>
                                <div>
                                    <button type="submit" class="btn-primary">
                                        <span class="btn-text">Salvar Configurações</span>
                                        <div class="loader hidden"></div>
                                    </button>
                                </div>
                             </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais de Edição -->
    <div id="edit-service-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Serviço</h3>
                <form id="edit-service-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-service-id">
                    <input type="text" id="edit-service-name" required placeholder="Nome" class="form-input w-full">
                    <input type="number" step="0.01" id="edit-service-value" required placeholder="Valor (R$)" class="form-input w-full">
                    <input type="number" step="0.01" id="edit-service-promo-value" placeholder="Valor Promocional (Opcional)" class="form-input w-full">
                    <input type="number" id="edit-service-duration" required placeholder="Duração (min)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-professional-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Profissional</h3>
                <form id="edit-professional-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-professional-id">
                    <input type="text" id="edit-professional-name" required placeholder="Nome do Profissional" class="form-input w-full">
                    <input type="text" id="edit-professional-function" required placeholder="Função" class="form-input w-full">
                    <input type="url" id="edit-professional-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                    <input type="number" id="edit-professional-commission-services" step="1" min="0" max="100" placeholder="Comissão Serviços (%)" class="form-input w-full">
                    <input type="number" id="edit-professional-commission-products" step="1" min="0" max="100" placeholder="Comissão Produtos (%)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-professional-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-professional-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-unit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Unidade</h3>
                <form id="edit-unit-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-unit-id">
                    <input type="text" id="edit-unit-name" required placeholder="Nome da Unidade" class="form-input w-full">
                    <input type="text" id="edit-unit-address" required placeholder="Endereço" class="form-input w-full">
                    <input type="url" id="edit-unit-photo" placeholder="URL da Foto (Opcional)" class="form-input w-full">
                    <input type="url" id="edit-unit-maps" placeholder="Link do Google Maps (Opcional)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-unit-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-unit-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-plan-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Plano</h3>
                <form id="edit-plan-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-plan-id">
                    <input type="text" id="edit-plan-title" required placeholder="Título do Plano" class="form-input w-full">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="edit-plan-price" required placeholder="Preço (ex: 129,90)" class="form-input w-full">
                        <input type="text" id="edit-plan-period" required placeholder="Período (ex: /mês)" class="form-input w-full">
                    </div>
                    <textarea id="edit-plan-features" required placeholder="Características (uma por linha)" rows="4" class="form-textarea w-full"></textarea>
                    <div class="flex items-center">
                        <input id="edit-plan-popular" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-primary focus:ring-primary">
                        <label for="edit-plan-popular" class="ml-2 block text-sm text-gray-300">Marcar como "Mais Popular"?</label>
                    </div>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-plan-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-plan-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-goal-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Meta</h3>
                <form id="edit-goal-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-goal-id">
                    <input type="number" id="edit-goal-target" required placeholder="Nº de Indicações" class="form-input w-full">
                    <input type="text" id="edit-goal-prize" required placeholder="Prêmio" class="form-input w-full">
                    <input type="text" id="edit-goal-icon" required placeholder="Ícone" class="form-input w-full">
                    <select id="edit-goal-service-id" class="form-select w-full">
                        <option value="">Prêmio sem serviço vinculado</option>
                    </select>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-goal-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-goal-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-client-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Editar Cliente</h3>
                <form id="edit-client-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-client-id">
                    <input type="text" id="edit-client-name" required placeholder="Nome do Cliente" class="form-input w-full">
                    <input type="tel" id="edit-client-phone" required placeholder="Telefone" class="form-input w-full">
                    <input type="email" id="edit-client-email" placeholder="E-mail" class="form-input w-full">
                    <input type="number" id="edit-client-credits" step="0.01" placeholder="Créditos de Indicação (R$)" class="form-input w-full">
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-edit-client-button" class="btn-secondary">Cancelar</button>
                    <button id="save-edit-client-button" class="btn-primary">
                        <span class="btn-text">Salvar Alterações</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[100] overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-md">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-white text-center mb-4">Confirmar Ação</h3>
                <p id="confirmation-message" class="text-center text-gray-300 mb-8">Você tem certeza?</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-confirmation-button" class="btn-secondary">Cancelar</button>
                    <button id="confirm-action-button" class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Agendamento -->
    <div id="add-appointment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-bold text-primary text-center mb-6">Adicionar Agendamento Manual</h3>
                <form id="add-appointment-form" class="space-y-4 text-left">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="appt-client-select" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                            <select id="appt-client-select" required class="form-select w-full"></select>
                        </div>
                         <div>
                            <label for="appt-professional-select" class="block text-sm font-medium text-gray-300 mb-1">Profissional</label>
                            <select id="appt-professional-select" required class="form-select w-full"></select>
                        </div>
                    </div>
                    <div>
                        <label for="appt-service-select" class="block text-sm font-medium text-gray-300 mb-1">Serviço</label>
                        <select id="appt-service-select" required class="form-select w-full"></select>
                    </div>
                     <div>
                        <label for="appt-datetime-input" class="block text-sm font-medium text-gray-300 mb-1">Data e Hora</label>
                        <input type="datetime-local" id="appt-datetime-input" required class="form-input w-full">
                    </div>
                    <p id="add-appointment-feedback" class="text-sm h-4 text-center"></p>
                </form>
                <div class="mt-8 flex justify-end space-x-4">
                    <button id="cancel-add-appointment-button" class="btn-secondary">Cancelar</button>
                    <button id="save-add-appointment-button" class="btn-primary">
                        <span class="btn-text">Salvar Agendamento</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO Modal de Edição de Agendamento -->
    <div id="edit-appointment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg">
             <div class="modal-content rounded-lg shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-primary">Gerenciar Agendamento</h3>
                    <button id="close-edit-appointment-modal" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <form id="edit-appointment-form" class="space-y-4 text-left">
                    <input type="hidden" id="edit-appointment-id">
                    <div>
                        <label for="edit-appt-status" class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select id="edit-appt-status" required class="form-select w-full">
                            <option value="agendado">Agendado</option>
                            <option value="confirmado">Confirmado</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit-appt-datetime" class="block text-sm font-medium text-gray-300 mb-1">Data e Hora</label>
                        <input type="datetime-local" id="edit-appt-datetime" required class="form-input w-full">
                    </div>
                    <!-- Mais campos podem ser adicionados aqui para editar cliente, serviço, etc. -->
                     <p id="edit-appointment-feedback" class="text-sm h-4 text-center"></p>
                </form>
                <div class="mt-8 flex flex-wrap justify-between gap-4">
                    <div>
                        <button id="delete-appointment-button" class="btn-secondary !bg-red-800 !border-red-700 hover:!bg-red-700"><i class="fas fa-trash-alt mr-2"></i>Remover</button>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <button id="whatsapp-reminder-button" class="btn-secondary !bg-green-700 !border-green-600 hover:!bg-green-600"><i class="fab fa-whatsapp mr-2"></i>Lembrete</button>
                        <button id="save-edit-appointment-button" class="btn-primary">
                            <span class="btn-text">Salvar Alterações</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- SDK do Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDoc, query, where, getDocs, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBSB03qbus51od3i1ipHJ_Wf6O6rf-1UeY",
            authDomain: "agenda-vs-barbearia.firebaseapp.com",
            projectId: "agenda-vs-barbearia",
            storageBucket: "agenda-vs-barbearia.firebasestorage.app",
            messagingSenderId: "1052414878320",
            appId: "1:1052414878320:web:6bb826bc64b16f9e5b8ab5",
            measurementId: "G-1FYTSFFPYV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Estado global e caches
        let agendaState = {
            currentDate: new Date(),
            interval: 30,
            professionals: [],
            appointments: []
        };
        let localServicesCache = [];
        let localProfessionalsCache = [];
        let localClientsCache = [];


        // --- Lógica de Autenticação ---
        const authSection = document.getElementById('auth-section');
        const panelSection = document.getElementById('panel-section');
        const userEmailSpan = document.getElementById('user-email');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const authError = document.getElementById('auth-error');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.classList.add('hidden');
                panelSection.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                loadServices(user.uid);
                loadAgendaSettings(user.uid);
            } else {
                authSection.classList.remove('hidden');
                panelSection.classList.add('hidden');
            }
        });
        
        signupButton.addEventListener('click', async () => { /* ... */ const email = emailInput.value; const password = passwordInput.value; authError.textContent = ''; try { await createUserWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Erro no cadastro:", error); authError.textContent = "Erro ao cadastrar. Verifique o email e a senha (mínimo 6 caracteres)."; } });
        loginButton.addEventListener('click', async () => { /* ... */ const email = emailInput.value; const password = passwordInput.value; authError.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Erro no login:", error); authError.textContent = "Email ou senha inválidos."; } });
        logoutButton.addEventListener('click', async () => { /* ... */ try { await signOut(auth); } catch (error) { console.error("Erro no logout:", error); } });

        // --- Lógica de Navegação por Abas ---
        const tabs = document.querySelectorAll('.tab-button');
        const contents = { 
            'tab-servicos': document.getElementById('content-servicos'), 
            'tab-profissionais': document.getElementById('content-profissionais'), 
            'tab-unidades': document.getElementById('content-unidades'),
            'tab-agenda': document.getElementById('content-agenda'),
            'tab-clientes': document.getElementById('content-clientes'),
            'tab-planos': document.getElementById('content-planos'),
            'tab-metas': document.getElementById('content-metas'),
            'tab-configuracoes': document.getElementById('content-configuracoes')
        };
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active', 'text-white'));
                tab.classList.add('active', 'text-white');
                
                Object.values(contents).forEach(content => content.classList.add('hidden'));
                const activeContent = contents[tab.id];
                activeContent.classList.remove('hidden');

                const user = auth.currentUser;
                if (!user) return;

                if (tab.id === 'tab-servicos') loadServices(user.uid);
                if (tab.id === 'tab-profissionais') loadProfessionals(user.uid);
                if (tab.id === 'tab-unidades') loadUnits(user.uid);
                if (tab.id === 'tab-agenda') initializeAgenda(user.uid);
                if (tab.id === 'tab-clientes') loadClients(user.uid);
                if (tab.id === 'tab-planos') loadPlans(user.uid);
                if (tab.id === 'tab-metas') loadGoals(user.uid);
                if (tab.id === 'tab-configuracoes') loadPanelUsers(user.uid);
            });
        });

        // --- CRUD DE SERVIÇOS ---
        const addServiceForm = document.getElementById('add-service-form');
        const servicesListDiv = document.getElementById('services-list');
        const loadingServicesP = document.getElementById('loading-services');
        const editServiceModal = document.getElementById('edit-service-modal');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const saveEditButton = document.getElementById('save-edit-button');
        
        addServiceForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const user = auth.currentUser; if (!user) return;
            const submitBtn = addServiceForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            const serviceName = document.getElementById('service-name').value; 
            const serviceValue = parseFloat(document.getElementById('service-value').value); 
            const servicePromoValueInput = document.getElementById('service-promo-value');
            const serviceDuration = parseInt(document.getElementById('service-duration').value);
            const data = { nome: serviceName, valor: serviceValue, duracaoMinutos: serviceDuration, gestorId: user.uid };
            if (servicePromoValueInput.value) { data.promocao = parseFloat(servicePromoValueInput.value); }
            try { await addDoc(collection(db, "servicos"), data); addServiceForm.reset(); } 
            catch (error) { console.error("Erro ao adicionar serviço: ", error); } 
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        let unsubscribeServices = null;
        function loadServices(userId) {
            if (unsubscribeServices) unsubscribeServices();
            const q = query(collection(db, "servicos"), where("gestorId", "==", userId));
            unsubscribeServices = onSnapshot(q, (snapshot) => {
                loadingServicesP.classList.add('hidden');
                servicesListDiv.innerHTML = '';
                localServicesCache = [];
                if (snapshot.empty) { servicesListDiv.innerHTML = '<p class="text-gray-400">Nenhum serviço cadastrado.</p>'; return; }
                snapshot.forEach((doc) => {
                    const servico = {id: doc.id, ...doc.data()};
                    localServicesCache.push(servico);
                    let priceHtml = '';
                    if (servico.promocao && typeof servico.promocao === 'number') {
                        priceHtml = `<span class="font-bold text-primary">R$ ${servico.promocao.toFixed(2)}</span> <span class="text-xs line-through text-gray-500">R$ ${servico.valor.toFixed(2)}</span>`;
                    } else { priceHtml = `R$ ${servico.valor.toFixed(2)}`; }
                    const servicoCard = document.createElement('div');
                    servicoCard.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex justify-between items-center';
                    servicoCard.innerHTML = `
                        <div>
                            <p class="font-bold text-white">${servico.nome}</p>
                            <p class="text-sm text-gray-400">${priceHtml} - ${servico.duracaoMinutos} min</p>
                        </div>
                        <div class="space-x-2 sm:space-x-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${servico.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${servico.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    servicesListDiv.appendChild(servicoCard);
                });
            });
        }
        
        servicesListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
            if (action === 'delete') {
                window.deleteDocument('servicos', id);
            }
            if (action === 'edit') {
                const serviceDoc = await getDoc(doc(db, "servicos", id));
                if (serviceDoc.exists()) {
                    const data = serviceDoc.data();
                    document.getElementById('edit-service-id').value = id;
                    document.getElementById('edit-service-name').value = data.nome;
                    document.getElementById('edit-service-value').value = data.valor;
                    document.getElementById('edit-service-promo-value').value = data.promocao || '';
                    document.getElementById('edit-service-duration').value = data.duracaoMinutos;
                    editServiceModal.classList.remove('hidden');
                }
            }
        });

        cancelEditButton.addEventListener('click', () => editServiceModal.classList.add('hidden'));

        saveEditButton.addEventListener('click', async () => {
            const btnText = saveEditButton.querySelector('.btn-text'); const loader = saveEditButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditButton.disabled = true; cancelEditButton.disabled = true;
            const id = document.getElementById('edit-service-id').value;
            const servicePromoValueInput = document.getElementById('edit-service-promo-value');
            const servicoRef = doc(db, "servicos", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-service-name').value,
                valor: parseFloat(document.getElementById('edit-service-value').value),
                duracaoMinutos: parseInt(document.getElementById('edit-service-duration').value),
                promocao: servicePromoValueInput.value ? parseFloat(servicePromoValueInput.value) : null
            };
            try { await updateDoc(servicoRef, dataToUpdate); editServiceModal.classList.add('hidden'); } 
            catch (error) { console.error("Erro ao atualizar serviço:", error); } 
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditButton.disabled = false; cancelEditButton.disabled = false; }
        });

        // --- CRUD DE PROFISSIONAIS ---
        const addProfessionalForm = document.getElementById('add-professional-form');
        const professionalsListDiv = document.getElementById('professionals-list');
        const editProfessionalModal = document.getElementById('edit-professional-modal');
        const cancelEditProfessionalButton = document.getElementById('cancel-edit-professional-button');
        const saveEditProfessionalButton = document.getElementById('save-edit-professional-button');
        let unsubscribeProfessionals = null;
        
        addProfessionalForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addProfessionalForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const name = document.getElementById('professional-name').value;
            const func = document.getElementById('professional-function').value;
            const photoUrl = document.getElementById('professional-photo').value;
            const comissaoServicos = document.getElementById('professional-commission-services').value;
            const comissaoProdutos = document.getElementById('professional-commission-products').value;

            const data = { 
                nome: name, 
                funcao: func, 
                imgUrl: photoUrl,
                comissaoServicos: comissaoServicos ? parseInt(comissaoServicos) : 0,
                comissaoProdutos: comissaoProdutos ? parseInt(comissaoProdutos) : 0,
                gestorId: user.uid 
            };

            try { await addDoc(collection(db, "profissionais"), data); addProfessionalForm.reset(); } 
            catch (error) { console.error("Erro ao adicionar profissional:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadProfessionals(userId) {
            if (unsubscribeProfessionals) unsubscribeProfessionals();
            const q = query(collection(db, "profissionais"), where("gestorId", "==", userId));
            unsubscribeProfessionals = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-professionals').classList.add('hidden');
                professionalsListDiv.innerHTML = '';
                localProfessionalsCache = [];
                if (snapshot.empty) { professionalsListDiv.innerHTML = '<p class="text-gray-400">Nenhum profissional cadastrado.</p>'; return; }
                snapshot.forEach(doc => {
                    const professional = {id: doc.id, ...doc.data()};
                    localProfessionalsCache.push(professional);
                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${professional.nome.charAt(0)}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <img src="${professional.imgUrl || placeholderImg}" alt="${professional.nome}" class="w-16 h-16 rounded-full mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${professional.nome}</p>
                            <p class="text-sm text-gray-400">${professional.funcao || 'Sem função'}</p>
                            <div class="text-xs text-gray-500 mt-2 flex gap-4">
                                <span><i class="fas fa-cut mr-1 text-primary/70"></i> Serv.: ${professional.comissaoServicos || 0}%</span>
                                <span><i class="fas fa-box mr-1 text-primary/70"></i> Prod.: ${professional.comissaoProdutos || 0}%</span>
                            </div>
                        </div>
                        <div class="space-x-2 sm:space-x-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    professionalsListDiv.appendChild(card);
                });
            });
        }

        professionalsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('profissionais', id);
            }
            if (action === 'edit') {
                const professionalDoc = await getDoc(doc(db, "profissionais", id));
                if (professionalDoc.exists()) {
                    const data = professionalDoc.data();
                    document.getElementById('edit-professional-id').value = id;
                    document.getElementById('edit-professional-name').value = data.nome;
                    document.getElementById('edit-professional-function').value = data.funcao || '';
                    document.getElementById('edit-professional-photo').value = data.imgUrl || '';
                    document.getElementById('edit-professional-commission-services').value = data.comissaoServicos || '';
                    document.getElementById('edit-professional-commission-products').value = data.comissaoProdutos || '';
                    editProfessionalModal.classList.remove('hidden');
                }
            }
        });
        
        cancelEditProfessionalButton.addEventListener('click', () => editProfessionalModal.classList.add('hidden'));

        saveEditProfessionalButton.addEventListener('click', async () => {
            const btnText = saveEditProfessionalButton.querySelector('.btn-text'); const loader = saveEditProfessionalButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditProfessionalButton.disabled = true; cancelEditProfessionalButton.disabled = true;
            
            const id = document.getElementById('edit-professional-id').value;
            const professionalRef = doc(db, "profissionais", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-professional-name').value,
                funcao: document.getElementById('edit-professional-function').value,
                imgUrl: document.getElementById('edit-professional-photo').value,
                comissaoServicos: parseInt(document.getElementById('edit-professional-commission-services').value) || 0,
                comissaoProdutos: parseInt(document.getElementById('edit-professional-commission-products').value) || 0,
            };

            try { await updateDoc(professionalRef, dataToUpdate); editProfessionalModal.classList.add('hidden'); }
            catch(error) { console.error("Erro ao atualizar profissional:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditProfessionalButton.disabled = false; cancelEditProfessionalButton.disabled = false; }
        });


        // --- CRUD DE UNIDADES ---
        const addUnitForm = document.getElementById('add-unit-form');
        const unitsListDiv = document.getElementById('units-list');
        const editUnitModal = document.getElementById('edit-unit-modal');
        const cancelEditUnitButton = document.getElementById('cancel-edit-unit-button');
        const saveEditUnitButton = document.getElementById('save-edit-unit-button');
        let unsubscribeUnits = null;

        addUnitForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addUnitForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const name = document.getElementById('unit-name').value;
            const address = document.getElementById('unit-address').value;
            const photoUrl = document.getElementById('unit-photo').value;
            const mapsUrl = document.getElementById('unit-maps').value;
            
            const data = { nome: name, endereco: address, imgUrl: photoUrl, mapsUrl: mapsUrl, gestorId: user.uid };

            try { await addDoc(collection(db, "unidades"), data); addUnitForm.reset(); } 
            catch (error) { console.error("Erro ao adicionar unidade:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadUnits(userId) {
            if (unsubscribeUnits) unsubscribeUnits();
            const q = query(collection(db, "unidades"), where("gestorId", "==", userId));
            unsubscribeUnits = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-units').classList.add('hidden');
                unitsListDiv.innerHTML = '';
                if (snapshot.empty) { unitsListDiv.innerHTML = '<p class="text-gray-400">Nenhuma unidade cadastrada.</p>'; return; }
                snapshot.forEach(doc => {
                    const unit = doc.data();
                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${unit.nome.slice(0, 2).toUpperCase()}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    
                    const addressHtml = unit.mapsUrl 
                        ? `<a href="${unit.mapsUrl}" target="_blank" class="hover:text-primary transition-colors">${unit.endereco} <i class="fas fa-external-link-alt text-xs ml-1"></i></a>` 
                        : unit.endereco;

                    card.innerHTML = `
                        <img src="${unit.imgUrl || placeholderImg}" alt="${unit.nome}" class="w-20 h-20 rounded-lg mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${unit.nome}</p>
                            <p class="text-sm text-gray-400">${addressHtml}</p>
                        </div>
                        <div class="space-x-2 sm:space-x-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    unitsListDiv.appendChild(card);
                });
            });
        }
        
        unitsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('unidades', id);
            }
            if (action === 'edit') {
                const unitDoc = await getDoc(doc(db, "unidades", id));
                if (unitDoc.exists()) {
                    const data = unitDoc.data();
                    document.getElementById('edit-unit-id').value = id;
                    document.getElementById('edit-unit-name').value = data.nome;
                    document.getElementById('edit-unit-address').value = data.endereco || '';
                    document.getElementById('edit-unit-photo').value = data.imgUrl || '';
                    document.getElementById('edit-unit-maps').value = data.mapsUrl || '';
                    editUnitModal.classList.remove('hidden');
                }
            }
        });
        
        cancelEditUnitButton.addEventListener('click', () => editUnitModal.classList.add('hidden'));

        saveEditUnitButton.addEventListener('click', async () => {
            const btnText = saveEditUnitButton.querySelector('.btn-text'); const loader = saveEditUnitButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditUnitButton.disabled = true; cancelEditUnitButton.disabled = true;
            
            const id = document.getElementById('edit-unit-id').value;
            const unitRef = doc(db, "unidades", id);
            const dataToUpdate = {
                nome: document.getElementById('edit-unit-name').value,
                endereco: document.getElementById('edit-unit-address').value,
                imgUrl: document.getElementById('edit-unit-photo').value,
                mapsUrl: document.getElementById('edit-unit-maps').value,
            };

            try { await updateDoc(unitRef, dataToUpdate); editUnitModal.classList.add('hidden'); }
            catch(error) { console.error("Erro ao atualizar unidade:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditUnitButton.disabled = false; cancelEditUnitButton.disabled = false; }
        });


        // --- LÓGICA DA AGENDA (CORRIGIDA) ---
        const datePicker = document.getElementById('date-picker');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const agendaTitle = document.getElementById('agenda-title');
        const agendaGridView = document.getElementById('agenda-grid-view');
        const loadingAgenda = document.getElementById('loading-agenda');
        const professionalFilter = document.getElementById('professional-filter');
        const addAppointmentBtn = document.getElementById('add-appointment-btn');
        const addAppointmentModal = document.getElementById('add-appointment-modal');
        const cancelAddAppointmentButton = document.getElementById('cancel-add-appointment-button');
        const saveAddAppointmentButton = document.getElementById('save-add-appointment-button');
        let unsubscribeAgenda = null;

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function updateDateDisplay() {
            datePicker.value = formatDateForInput(agendaState.currentDate);
            agendaTitle.textContent = `Agenda - ${agendaState.currentDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}`;
        }

        prevDayBtn.addEventListener('click', () => {
            agendaState.currentDate.setDate(agendaState.currentDate.getDate() - 1);
            updateDateDisplay();
            loadAgendaData(auth.currentUser.uid);
        });
        nextDayBtn.addEventListener('click', () => {
            agendaState.currentDate.setDate(agendaState.currentDate.getDate() + 1);
            updateDateDisplay();
            loadAgendaData(auth.currentUser.uid);
        });
        datePicker.addEventListener('change', () => {
            const [year, month, day] = datePicker.value.split('-').map(Number);
            agendaState.currentDate = new Date(year, month - 1, day);
            updateDateDisplay();
            loadAgendaData(auth.currentUser.uid);
        });
        
        function initializeAgenda(userId) {
            updateDateDisplay();
            loadAgendaData(userId);
        }

        function populateProfessionalFilter() {
            const currentVal = professionalFilter.value;
            professionalFilter.innerHTML = '<option value="all">Todos Profissionais</option>';
            agendaState.professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.nome;
                if (prof.id === currentVal) {
                    option.selected = true;
                }
                professionalFilter.appendChild(option);
            });
        }
        professionalFilter.addEventListener('change', renderAgendaGrid);


        async function loadAgendaData(userId) {
            loadingAgenda.classList.remove('hidden');
            agendaGridView.classList.add('hidden');

            if (unsubscribeAgenda) unsubscribeAgenda();

            try {
                const professionalsQuery = query(collection(db, "profissionais"), where("gestorId", "==", userId));
                const professionalsSnapshot = await getDocs(professionalsQuery);
                agendaState.professionals = professionalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateProfessionalFilter();

                const allAppointmentsQuery = query(collection(db, "agendamentos"), where("gestorId", "==", userId));

                unsubscribeAgenda = onSnapshot(allAppointmentsQuery, (snapshot) => {
                    const startOfDay = new Date(agendaState.currentDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(agendaState.currentDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    const appointmentsForDay = snapshot.docs.filter(doc => {
                        const apptDate = doc.data().data.toDate();
                        return apptDate >= startOfDay && apptDate <= endOfDay;
                    });

                    agendaState.appointments = appointmentsForDay.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAgendaGrid();
                }, (error) => {
                    console.error("Erro no listener de agendamentos:", error);
                    agendaGridView.innerHTML = '<p class="text-center text-red-500 p-8">Ocorreu um erro ao carregar os agendamentos.</p>';
                    loadingAgenda.classList.add('hidden');
                    agendaGridView.classList.remove('hidden');
                });
            } catch (error) {
                console.error("Erro ao carregar dados da agenda:", error);
                agendaGridView.innerHTML = `<p class="text-center text-red-500 p-8">Ocorreu um erro. Verifique o console.</p>`;
                loadingAgenda.classList.add('hidden');
                agendaGridView.classList.remove('hidden');
            }
        }
        
        function renderAgendaGrid() {
            agendaGridView.innerHTML = '';
            
            const selectedProfId = professionalFilter.value;
            const professionalsToRender = selectedProfId === 'all'
                ? agendaState.professionals
                : agendaState.professionals.filter(p => p.id === selectedProfId);

            if (professionalsToRender.length === 0) {
                 agendaGridView.innerHTML = '<p class="text-center text-gray-400 p-8">Nenhum profissional para exibir. Adicione um na aba "Profissionais".</p>';
                 loadingAgenda.classList.add('hidden');
                 agendaGridView.classList.remove('hidden');
                 return;
            }

            const grid = document.createElement('div');
            grid.className = 'agenda-grid';

            const timeColumn = document.createElement('div');
            timeColumn.className = 'time-column';
            const timeHeader = document.createElement('div');
            timeHeader.className = 'professional-header';
            timeHeader.innerHTML = `<i class="far fa-clock"></i>`;
            timeColumn.appendChild(timeHeader);
            
            const timeSlotsContainer = document.createElement('div');
            const startTime = 8;
            const endTime = 20;
            for (let hour = startTime; hour < endTime; hour++) {
                for (let minute = 0; minute < 60; minute += agendaState.interval) {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    timeSlotsContainer.appendChild(timeSlot);
                }
            }
            timeColumn.appendChild(timeSlotsContainer);
            grid.appendChild(timeColumn);

            professionalsToRender.forEach(prof => {
                const profColumn = document.createElement('div');
                profColumn.className = 'professional-column';
                profColumn.dataset.professionalId = prof.id;

                const profHeader = document.createElement('div');
                profHeader.className = 'professional-header';
                profHeader.textContent = prof.nome.split(' ')[0];
                profColumn.appendChild(profHeader);
                
                const linesContainer = document.createElement('div');
                for (let hour = startTime; hour < endTime; hour++) {
                    for (let minute = 0; minute < 60; minute += agendaState.interval) {
                         const line = document.createElement('div');
                         line.className = 'time-slot-line';
                         linesContainer.appendChild(line);
                    }
                }
                profColumn.appendChild(linesContainer);
                grid.appendChild(profColumn);
            });
            
            agendaGridView.appendChild(grid);
            placeAppointments();

            loadingAgenda.classList.add('hidden');
            agendaGridView.classList.remove('hidden');
        }

        function placeAppointments() {
            agendaState.appointments.forEach(appt => {
                const professionalId = appt.barbeiro?.id;
                if (!professionalId) return;

                const column = agendaGridView.querySelector(`.professional-column[data-professional-id="${professionalId}"]`);
                if (!column) return;

                const apptDate = appt.data.toDate();
                const startHour = 8;
                const totalMinutesFromStart = (apptDate.getHours() - startHour) * 60 + apptDate.getMinutes();

                const slotHeight = 40;
                const pixelsPerMinute = slotHeight / agendaState.interval;

                const topPosition = totalMinutesFromStart * pixelsPerMinute;
                const duration = appt.servico?.duracaoMinutos || agendaState.interval;
                const height = duration * pixelsPerMinute;

                const card = document.createElement('div');
                card.className = `appointment-card status-${appt.status || 'agendado'}`;
                card.style.top = `${topPosition}px`;
                card.style.height = `${height}px`;
                card.dataset.id = appt.id; // Adiciona o ID para ser clicável
                card.innerHTML = `
                    <p class="font-bold">${appt.cliente?.nome || 'Cliente'}</p>
                    <p class="text-xs">${appt.servico?.nome || 'Serviço'}</p>
                `;
                
                card.addEventListener('click', () => openEditAppointmentModal(appt.id));

                const linesContainer = column.querySelector('div:not(.professional-header)');
                if (linesContainer) {
                    linesContainer.style.position = 'relative';
                    linesContainer.appendChild(card);
                }
            });
        }
        
        // --- CRUD DE CLIENTES ---
        const addClientForm = document.getElementById('add-client-form');
        const clientsListDiv = document.getElementById('clients-list');
        const loadingClientsP = document.getElementById('loading-clients');
        const editClientModal = document.getElementById('edit-client-modal');
        const cancelEditClientButton = document.getElementById('cancel-edit-client-button');
        const saveEditClientButton = document.getElementById('save-edit-client-button');
        let unsubscribeClients = null;

        addClientForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addClientForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const data = {
                name: document.getElementById('client-name').value,
                phone: document.getElementById('client-phone').value,
                email: document.getElementById('client-email').value,
                referralCredits: 0,
                gestorId: user.uid
            };
            
            try { await addDoc(collection(db, "users"), data); addClientForm.reset(); }
            catch(error) { console.error("Erro ao adicionar cliente:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadClients(userId) {
            if (unsubscribeClients) unsubscribeClients();
            const q = query(collection(db, "users"), where("gestorId", "==", userId));
            unsubscribeClients = onSnapshot(q, (snapshot) => {
                loadingClientsP.classList.add('hidden');
                clientsListDiv.innerHTML = '';
                localClientsCache = [];
                if (snapshot.empty) {
                    clientsListDiv.innerHTML = '<p class="text-gray-400">Nenhum cliente cadastrado.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const client = {id: doc.id, ...doc.data()};
                    localClientsCache.push(client);
                    const placeholderImg = `https://placehold.co/100x100/333333/FFFFFF?text=${client.name ? client.name.charAt(0) : 'C'}`;
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <img src="${client.profilePic || placeholderImg}" alt="${client.name}" class="w-16 h-16 rounded-full mr-4 object-cover border-2 border-gray-600" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        <div class="flex-grow">
                            <p class="font-bold text-white">${client.name || 'Nome não informado'}</p>
                            <p class="text-sm text-gray-400">${client.phone || 'Telefone não informado'}</p>
                            <p class="text-xs text-gray-500">${client.email || 'Email não informado'}</p>
                        </div>
                        <div class="text-right mr-4">
                             <p class="text-sm text-gray-400">Créditos</p>
                             <p class="font-bold text-primary text-lg">R$ ${(client.referralCredits || 0).toFixed(2)}</p>
                        </div>
                        <div class="space-x-2 sm:space-x-4">
                             <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                             <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                 <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                             </button>
                        </div>`;
                    clientsListDiv.appendChild(card);
                });
            });
        }
        
        clientsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('users', id);
            }
            if (action === 'edit') {
                const clientDoc = await getDoc(doc(db, "users", id));
                if (clientDoc.exists()) {
                    const data = clientDoc.data();
                    document.getElementById('edit-client-id').value = id;
                    document.getElementById('edit-client-name').value = data.name || '';
                    document.getElementById('edit-client-phone').value = data.phone || '';
                    document.getElementById('edit-client-email').value = data.email || '';
                    document.getElementById('edit-client-credits').value = data.referralCredits || '';
                    editClientModal.classList.remove('hidden');
                }
            }
        });
        
        cancelEditClientButton.addEventListener('click', () => editClientModal.classList.add('hidden'));

        saveEditClientButton.addEventListener('click', async () => {
            const btnText = saveEditClientButton.querySelector('.btn-text'); const loader = saveEditClientButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditClientButton.disabled = true; cancelEditClientButton.disabled = true;
            
            const id = document.getElementById('edit-client-id').value;
            const clientRef = doc(db, "users", id);
            const dataToUpdate = {
                name: document.getElementById('edit-client-name').value,
                phone: document.getElementById('edit-client-phone').value,
                email: document.getElementById('edit-client-email').value,
                referralCredits: parseFloat(document.getElementById('edit-client-credits').value) || 0
            };

            try { await updateDoc(clientRef, dataToUpdate); editClientModal.classList.add('hidden'); }
            catch(error) { console.error("Erro ao atualizar cliente:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditClientButton.disabled = false; cancelEditClientButton.disabled = false; }
        });

        // --- CRUD DE PLANOS ---
        const addPlanForm = document.getElementById('add-plan-form');
        const plansListDiv = document.getElementById('plans-list');
        const loadingPlansP = document.getElementById('loading-plans');
        const editPlanModal = document.getElementById('edit-plan-modal');
        const cancelEditPlanButton = document.getElementById('cancel-edit-plan-button');
        const saveEditPlanButton = document.getElementById('save-edit-plan-button');
        let unsubscribePlans = null;

        addPlanForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addPlanForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const data = {
                title: document.getElementById('plan-title').value,
                price: document.getElementById('plan-price').value,
                period: document.getElementById('plan-period').value,
                features: document.getElementById('plan-features').value.split('\n').filter(f => f.trim() !== ''),
                popular: document.getElementById('plan-popular').checked,
                gestorId: user.uid
            };

            try { await addDoc(collection(db, "planos"), data); addPlanForm.reset(); }
            catch(error) { console.error("Erro ao adicionar plano:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });

        function loadPlans(userId) {
            if (unsubscribePlans) unsubscribePlans();
            const q = query(collection(db, "planos"), where("gestorId", "==", userId));
            unsubscribePlans = onSnapshot(q, (snapshot) => {
                loadingPlansP.classList.add('hidden');
                plansListDiv.innerHTML = '';
                if (snapshot.empty) { plansListDiv.innerHTML = '<p class="text-gray-400">Nenhum plano cadastrado.</p>'; return; }
                snapshot.forEach(doc => {
                    const plan = doc.data();
                    const card = document.createElement('div');
                    card.className = `p-6 bg-[#2a2a2a] border ${plan.popular ? 'border-primary' : 'border-gray-700'} rounded-lg relative`;
                    
                    if (plan.popular) {
                        card.innerHTML += `<div class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-primary text-black text-xs font-bold px-3 py-1 rounded-full">MAIS POPULAR</div>`;
                    }

                    card.innerHTML += `
                        <div class="flex-grow mt-4">
                            <h4 class="font-bold text-white text-xl">${plan.title}</h4>
                            <p class="text-2xl font-bold text-primary my-2">R$${plan.price} <span class="text-base font-medium text-gray-400">${plan.period}</span></p>
                            <ul class="space-y-2 text-sm text-gray-300 mt-4">
                                ${plan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-primary mr-3 mt-1"></i><span>${f}</span></li>`).join('')}
                            </ul>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-700">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>
                    `;
                    plansListDiv.appendChild(card);
                });
            });
        }

        plansListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('planos', id);
            }

            if (action === 'edit') {
                const planDoc = await getDoc(doc(db, "planos", id));
                if (planDoc.exists()) {
                    const data = planDoc.data();
                    document.getElementById('edit-plan-id').value = id;
                    document.getElementById('edit-plan-title').value = data.title;
                    document.getElementById('edit-plan-price').value = data.price;
                    document.getElementById('edit-plan-period').value = data.period;
                    document.getElementById('edit-plan-features').value = data.features.join('\n');
                    document.getElementById('edit-plan-popular').checked = data.popular;
                    editPlanModal.classList.remove('hidden');
                }
            }
        });

        cancelEditPlanButton.addEventListener('click', () => editPlanModal.classList.add('hidden'));

        saveEditPlanButton.addEventListener('click', async () => {
            const btnText = saveEditPlanButton.querySelector('.btn-text'); const loader = saveEditPlanButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditPlanButton.disabled = true; cancelEditPlanButton.disabled = true;

            const id = document.getElementById('edit-plan-id').value;
            const planRef = doc(db, "planos", id);
            const dataToUpdate = {
                title: document.getElementById('edit-plan-title').value,
                price: document.getElementById('edit-plan-price').value,
                period: document.getElementById('edit-plan-period').value,
                features: document.getElementById('edit-plan-features').value.split('\n').filter(f => f.trim() !== ''),
                popular: document.getElementById('edit-plan-popular').checked,
            };

            try { await updateDoc(planRef, dataToUpdate); editPlanModal.classList.add('hidden'); }
            catch(error) { console.error("Erro ao atualizar plano:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditPlanButton.disabled = false; cancelEditPlanButton.disabled = false; }
        });
        
        // --- CRUD DE METAS ---
        const addGoalForm = document.getElementById('add-goal-form');
        const goalsListDiv = document.getElementById('goals-list');
        const loadingGoalsP = document.getElementById('loading-goals');
        const editGoalModal = document.getElementById('edit-goal-modal');
        const cancelEditGoalButton = document.getElementById('cancel-edit-goal-button');
        const saveEditGoalButton = document.getElementById('save-edit-goal-button');
        let unsubscribeGoals = null;

        addGoalForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const user = auth.currentUser; if (!user) return;
            const submitBtn = addGoalForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const data = {
                target: parseInt(document.getElementById('goal-target').value),
                prize: document.getElementById('goal-prize').value,
                icon: document.getElementById('goal-icon').value,
                serviceId: document.getElementById('goal-service-id').value,
                gestorId: user.uid
            };

            try { await addDoc(collection(db, "metas"), data); addGoalForm.reset(); }
            catch(error) { console.error("Erro ao adicionar meta:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false; }
        });
        
        function populateServicesSelect(selectElement, selectedValue = '') {
            selectElement.innerHTML = '<option value="">Prêmio sem serviço vinculado</option>';
            localServicesCache.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.nome;
                if (service.id === selectedValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        async function loadGoals(userId) {
            if (localServicesCache.length === 0) {
                const servicesQuery = query(collection(db, "servicos"), where("gestorId", "==", userId));
                const querySnapshot = await getDocs(servicesQuery);
                querySnapshot.forEach(doc => {
                    localServicesCache.push({ id: doc.id, ...doc.data() });
                });
            }
            populateServicesSelect(document.getElementById('goal-service-id'));
            
            if (unsubscribeGoals) unsubscribeGoals();
            const q = query(collection(db, "metas"), where("gestorId", "==", userId));
            unsubscribeGoals = onSnapshot(q, (snapshot) => {
                loadingGoalsP.classList.add('hidden');
                goalsListDiv.innerHTML = '';
                if (snapshot.empty) { goalsListDiv.innerHTML = '<p class="text-gray-400">Nenhuma meta cadastrada.</p>'; return; }
                snapshot.forEach(doc => {
                    const goal = doc.data();
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-[#2a2a2a] border border-gray-700 rounded-lg flex items-center';
                    card.innerHTML = `
                        <div class="w-12 h-12 rounded-full flex items-center justify-center bg-primary/20 mr-4">
                            <i class="${goal.icon || 'fas fa-star'} text-xl text-primary"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-white">${goal.prize}</p>
                            <p class="text-sm text-gray-400">Meta: ${goal.target} indicações</p>
                        </div>
                        <div class="space-x-2 sm:space-x-4">
                            <button class="text-sm text-gray-300 hover:text-primary font-semibold" data-id="${doc.id}" data-action="edit"><i class="fas fa-pencil-alt mr-1"></i>Editar</button>
                            <button class="text-sm text-red-500 hover:text-red-400 font-semibold flex items-center" data-id="${doc.id}" data-action="delete">
                                <span class="btn-text"><i class="fas fa-trash-alt mr-1"></i>Excluir</span>
                            </button>
                        </div>`;
                    goalsListDiv.appendChild(card);
                });
            });
        }

        goalsListDiv.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.id) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'delete') {
                window.deleteDocument('metas', id);
            }

            if (action === 'edit') {
                const goalDoc = await getDoc(doc(db, "metas", id));
                if (goalDoc.exists()) {
                    const data = goalDoc.data();
                    document.getElementById('edit-goal-id').value = id;
                    document.getElementById('edit-goal-target').value = data.target;
                    document.getElementById('edit-goal-prize').value = data.prize;
                    document.getElementById('edit-goal-icon').value = data.icon;
                    populateServicesSelect(document.getElementById('edit-goal-service-id'), data.serviceId);
                    editGoalModal.classList.remove('hidden');
                }
            }
        });

        cancelEditGoalButton.addEventListener('click', () => editGoalModal.classList.add('hidden'));

        saveEditGoalButton.addEventListener('click', async () => {
            const btnText = saveEditGoalButton.querySelector('.btn-text'); const loader = saveEditGoalButton.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); saveEditGoalButton.disabled = true; cancelEditGoalButton.disabled = true;

            const id = document.getElementById('edit-goal-id').value;
            const goalRef = doc(db, "metas", id);
            const dataToUpdate = {
                target: parseInt(document.getElementById('edit-goal-target').value),
                prize: document.getElementById('edit-goal-prize').value,
                icon: document.getElementById('edit-goal-icon').value,
                serviceId: document.getElementById('edit-goal-service-id').value,
            };

            try { await updateDoc(goalRef, dataToUpdate); editGoalModal.classList.add('hidden'); }
            catch(error) { console.error("Erro ao atualizar meta:", error); }
            finally { btnText.classList.remove('hidden'); loader.classList.add('hidden'); saveEditGoalButton.disabled = false; cancelEditGoalButton.disabled = false; }
        });
        
        // --- CONFIGURAÇÕES ---
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordFeedback = document.getElementById('change-password-feedback');
        const agendaSettingsForm = document.getElementById('agenda-settings-form');
        const agendaSettingsFeedback = document.getElementById('agenda-settings-feedback');
        
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const user = auth.currentUser;
            changePasswordFeedback.textContent = '';

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                changePasswordFeedback.textContent = 'Senha alterada com sucesso!';
                changePasswordFeedback.className = 'text-sm h-4 text-green-500';
                changePasswordForm.reset();
            } catch(error) {
                console.error("Erro ao alterar senha:", error);
                changePasswordFeedback.textContent = 'Senha atual incorreta.';
                changePasswordFeedback.className = 'text-sm h-4 text-red-500';
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
        
        agendaSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser; if (!user) return;
            const submitBtn = agendaSettingsForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            
            const newInterval = parseInt(document.getElementById('agenda-interval').value);
            if (isNaN(newInterval) || newInterval <= 0) {
                 agendaSettingsFeedback.textContent = 'Por favor, insira um valor válido.';
                 agendaSettingsFeedback.className = 'text-sm h-4 text-red-500';
                 btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
                 return;
            }
            
            const settingsRef = doc(db, 'configuracoes', user.uid);
            try {
                await setDoc(settingsRef, { agendaInterval: newInterval, updatedAt: serverTimestamp() }, { merge: true });
                agendaState.interval = newInterval;
                agendaSettingsFeedback.textContent = 'Configurações salvas!';
                agendaSettingsFeedback.className = 'text-sm h-4 text-green-500';
            } catch(error) {
                 console.error("Erro ao salvar configurações:", error);
                 agendaSettingsFeedback.textContent = 'Erro ao salvar.';
                 agendaSettingsFeedback.className = 'text-sm h-4 text-red-500';
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
        
        async function loadAgendaSettings(userId) {
            const settingsRef = doc(db, 'configuracoes', userId);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const settings = docSnap.data();
                agendaState.interval = settings.agendaInterval || 30;
                document.getElementById('agenda-interval').value = agendaState.interval;
            } else {
                try {
                    await setDoc(settingsRef, { agendaInterval: 30, createdAt: serverTimestamp() });
                } catch(error) { console.error("Erro ao criar doc de config:", error); }
            }
        }

        // --- GESTÃO DE USUÁRIOS DO PAINEL ---
        const addPanelUserForm = document.getElementById('add-panel-user-form');
        const addUserFeedback = document.getElementById('add-user-feedback');
        const panelUsersListDiv = document.getElementById('panel-users-list');
        const loadingPanelUsersP = document.getElementById('loading-panel-users');
        
        addPanelUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = addPanelUserForm.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;
            addUserFeedback.textContent = '';
            
            const email = document.getElementById('panel-user-email').value;
            const password = document.getElementById('panel-user-password').value;
            const role = document.getElementById('panel-user-role').value;
            
            try {
                await addDoc(collection(db, "panel_users"), { email: email, role: role, createdAt: new Date() });
                addUserFeedback.textContent = `Usuário ${email} convidado com sucesso!`;
                addUserFeedback.className = 'text-sm h-4 text-green-500';
                addPanelUserForm.reset();
            } catch (error) {
                console.error("Erro ao convidar usuário:", error);
                addUserFeedback.textContent = 'Erro ao convidar usuário.';
                addUserFeedback.className = 'text-sm h-4 text-red-500';
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
        
        function loadPanelUsers() {
            onSnapshot(collection(db, "panel_users"), (snapshot) => {
                loadingPanelUsersP.classList.add('hidden');
                panelUsersListDiv.innerHTML = '';
                if(snapshot.empty) {
                    panelUsersListDiv.innerHTML = '<p class="text-sm text-gray-500">Nenhum usuário adicional.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const card = document.createElement('div');
                    card.className = 'flex justify-between items-center bg-[#2a2a2a] p-3 rounded-lg';
                    card.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${user.email}</p>
                            <p class="text-xs text-gray-400 capitalize">${user.role}</p>
                        </div>
                        <button class="text-xs text-red-500 hover:text-red-400 font-semibold" onclick="deleteDocument('panel_users', '${doc.id}')">Remover</button>
                    `;
                    panelUsersListDiv.appendChild(card);
                });
            });
        }

        // --- MODAIS E FUNÇÕES GLOBAIS ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationButton = document.getElementById('cancel-confirmation-button');
        const confirmActionButton = document.getElementById('confirm-action-button');
        let confirmationCallback = null;

        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        }
        
        cancelConfirmationButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        confirmActionButton.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        window.deleteDocument = (collectionName, docId) => {
            const message = `Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.`;
            showConfirmationModal(message, async () => {
                try { 
                    await deleteDoc(doc(db, collectionName, docId)); 
                } catch(e) { 
                    console.error("Erro ao deletar:", e);
                }
            });
        };

        // --- LÓGICA DO MODAL DE AGENDAMENTO ---
        addAppointmentBtn.addEventListener('click', async () => {
            const form = addAppointmentModal.querySelector('form');
            form.reset();
            const feedback = document.getElementById('add-appointment-feedback');
            feedback.textContent = '';

            const clientSelect = document.getElementById('appt-client-select');
            const profSelect = document.getElementById('appt-professional-select');
            const serviceSelect = document.getElementById('appt-service-select');
            
            clientSelect.innerHTML = '<option value="">Carregando...</option>';
            profSelect.innerHTML = '<option value="">Carregando...</option>';
            serviceSelect.innerHTML = '<option value="">Carregando...</option>';

            addAppointmentModal.classList.remove('hidden');

            try {
                const [clientsSnapshot, profsSnapshot] = await Promise.all([
                    getDocs(query(collection(db, "users"), where("gestorId", "==", auth.currentUser.uid))),
                    getDocs(query(collection(db, "profissionais"), where("gestorId", "==", auth.currentUser.uid)))
                ]);

                localClientsCache = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
                localClientsCache.forEach(c => clientSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

                localProfessionalsCache = profsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                profSelect.innerHTML = '<option value="">Selecione um profissional</option>';
                localProfessionalsCache.forEach(p => profSelect.innerHTML += `<option value="${p.id}">${p.nome}</option>`);

                serviceSelect.innerHTML = '<option value="">Selecione um serviço</option>';
                localServicesCache.forEach(s => serviceSelect.innerHTML += `<option value="${s.id}">${s.nome}</option>`);

                const dateTimeInput = document.getElementById('appt-datetime-input');
                const now = new Date(agendaState.currentDate);
                now.setHours(9, 0, 0, 0);
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                dateTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;

            } catch (error) {
                console.error("Erro ao abrir modal de agendamento:", error);
                feedback.textContent = "Erro ao carregar dados.";
                feedback.className = "text-sm h-4 text-center text-red-500";
            }
        });

        cancelAddAppointmentButton.addEventListener('click', () => addAppointmentModal.classList.add('hidden'));

        saveAddAppointmentButton.addEventListener('click', async () => {
            const btnText = saveAddAppointmentButton.querySelector('.btn-text');
            const loader = saveAddAppointmentButton.querySelector('.loader');
            const feedback = document.getElementById('add-appointment-feedback');
            feedback.textContent = '';
            
            const clientId = document.getElementById('appt-client-select').value;
            const profId = document.getElementById('appt-professional-select').value;
            const serviceId = document.getElementById('appt-service-select').value;
            const datetime = document.getElementById('appt-datetime-input').value;

            if (!clientId || !profId || !serviceId || !datetime) {
                feedback.textContent = "Preencha todos os campos.";
                feedback.className = "text-sm h-4 text-center text-red-500";
                return;
            }

            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            saveAddAppointmentButton.disabled = true;
            cancelAddAppointmentButton.disabled = true;

            try {
                const clientData = localClientsCache.find(c => c.id === clientId);
                const profData = localProfessionalsCache.find(p => p.id === profId);
                const serviceData = localServicesCache.find(s => s.id === serviceId);

                const unitsQuery = query(collection(db, "unidades"), where("gestorId", "==", auth.currentUser.uid));
                const unitsSnapshot = await getDocs(unitsQuery);
                if (unitsSnapshot.empty) {
                    throw new Error("Cadastre pelo menos uma unidade antes de criar agendamentos.");
                }
                const firstUnit = { id: unitsSnapshot.docs[0].id, ...unitsSnapshot.docs[0].data() };

                const appointmentData = {
                    barbeiro: { id: profData.id, nome: profData.nome },
                    cliente: { id: clientData.id, nome: clientData.name },
                    data: new Date(datetime),
                    gestorId: auth.currentUser.uid,
                    servico: { id: serviceData.id, nome: serviceData.nome, valor: serviceData.valor, duracaoMinutos: serviceData.duracaoMinutos },
                    unidade: { id: firstUnit.id, nome: firstUnit.nome },
                    createdAt: serverTimestamp(),
                    status: 'agendado' // NOVO: status padrão
                };

                await addDoc(collection(db, "agendamentos"), appointmentData);
                addAppointmentModal.classList.add('hidden');
            
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                feedback.textContent = error.message || "Erro ao salvar.";
                feedback.className = "text-sm h-4 text-center text-red-500";
            } finally {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
                saveAddAppointmentButton.disabled = false;
                cancelAddAppointmentButton.disabled = false;
            }
        });

        // --- LÓGICA DO MODAL DE EDIÇÃO DE AGENDAMENTO ---
        const editAppointmentModal = document.getElementById('edit-appointment-modal');
        const closeEditAppointmentModal = document.getElementById('close-edit-appointment-modal');
        const saveEditAppointmentButton = document.getElementById('save-edit-appointment-button');
        const deleteAppointmentButton = document.getElementById('delete-appointment-button');
        const whatsappReminderButton = document.getElementById('whatsapp-reminder-button');

        async function openEditAppointmentModal(appointmentId) {
            const docRef = doc(db, "agendamentos", appointmentId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const appointment = docSnap.data();
                document.getElementById('edit-appointment-id').value = appointmentId;
                document.getElementById('edit-appt-status').value = appointment.status || 'agendado';
                
                const apptDate = appointment.data.toDate();
                const year = apptDate.getFullYear();
                const month = (apptDate.getMonth() + 1).toString().padStart(2, '0');
                const day = apptDate.getDate().toString().padStart(2, '0');
                const hours = apptDate.getHours().toString().padStart(2, '0');
                const minutes = apptDate.getMinutes().toString().padStart(2, '0');
                document.getElementById('edit-appt-datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;

                editAppointmentModal.classList.remove('hidden');
            } else {
                console.error("Agendamento não encontrado!");
            }
        }

        closeEditAppointmentModal.addEventListener('click', () => editAppointmentModal.classList.add('hidden'));

        saveEditAppointmentButton.addEventListener('click', async () => {
            const btnText = saveEditAppointmentButton.querySelector('.btn-text');
            const loader = saveEditAppointmentButton.querySelector('.loader');
            const feedback = document.getElementById('edit-appointment-feedback');
            feedback.textContent = '';

            const id = document.getElementById('edit-appointment-id').value;
            const newStatus = document.getElementById('edit-appt-status').value;
            const newDatetime = document.getElementById('edit-appt-datetime').value;

            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            saveEditAppointmentButton.disabled = true;

            try {
                const appointmentRef = doc(db, "agendamentos", id);
                await updateDoc(appointmentRef, {
                    status: newStatus,
                    data: new Date(newDatetime)
                });
                editAppointmentModal.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao atualizar agendamento:", error);
                feedback.textContent = "Erro ao salvar.";
                feedback.className = "text-sm h-4 text-center text-red-500";
            } finally {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
                saveEditAppointmentButton.disabled = false;
            }
        });

        deleteAppointmentButton.addEventListener('click', () => {
            const id = document.getElementById('edit-appointment-id').value;
            showConfirmationModal("Tem certeza que deseja remover este agendamento?", async () => {
                try {
                    await deleteDoc(doc(db, "agendamentos", id));
                    editAppointmentModal.classList.add('hidden');
                } catch(e) {
                    console.error("Erro ao remover agendamento:", e);
                }
            });
        });

        whatsappReminderButton.addEventListener('click', async () => {
            const id = document.getElementById('edit-appointment-id').value;
            const docRef = doc(db, "agendamentos", id);
            const docSnap = await getDoc(docRef);

            if(docSnap.exists()){
                const appt = docSnap.data();
                const clientRef = doc(db, "users", appt.cliente.id);
                const clientSnap = await getDoc(clientRef);
                if(clientSnap.exists() && clientSnap.data().phone) {
                    const phone = clientSnap.data().phone.replace(/\D/g, '');
                    const date = appt.data.toDate().toLocaleDateString('pt-BR');
                    const time = appt.data.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    const message = encodeURIComponent(`Olá ${appt.cliente.nome}! Lembrete do seu agendamento na VS Barbearia para o serviço de ${appt.servico.nome} no dia ${date} às ${time}. Estamos te esperando!`);
                    window.open(`https://wa.me/55${phone}?text=${message}`, '_blank');
                } else {
                    alert("Cliente não possui telefone cadastrado para enviar lembrete.");
                }
            }
        });


    </script>
</body>
</html>

